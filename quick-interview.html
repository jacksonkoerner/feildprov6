<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Daily Report - Field Documentation</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
    <meta name="theme-color" content="#0a1628">

    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FieldVoice">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dot-navy': '#0a1628',
                        'dot-blue': '#1e3a5f',
                        'dot-slate': '#334155',
                        'dot-orange': '#ea580c',
                        'dot-yellow': '#f59e0b',
                        'safety-green': '#16a34a',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        .header-stripe {
            background: repeating-linear-gradient(-45deg, #f59e0b, #f59e0b 10px, #0a1628 10px, #0a1628 20px);
            height: 4px;
            padding-top: env(safe-area-inset-top);
        }
        .section-card { transition: all 0.3s ease; }
        .section-card.expanded { border-color: #1e3a5f; box-shadow: 0 0 0 2px rgba(30, 58, 95, 0.2); }
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .section-card.expanded .section-content { max-height: 2000px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Contractor work cards */
        .contractor-work-card { transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .contractor-content { transition: max-height 0.3s ease; }
        .contractor-chevron { transition: transform 0.2s ease; }
        /* Personnel cards - mobile-friendly collapsible layout */
        .personnel-card { transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .personnel-card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .personnel-card.expanded .personnel-card-content {
            max-height: 500px;
        }
        .personnel-card-chevron { transition: transform 0.2s ease; }
        .personnel-card.expanded .personnel-card-chevron { transform: rotate(180deg); }
        /* Equipment group headers */
        .equipment-group { margin-bottom: 0.5rem; }
        .equipment-group:last-child { margin-bottom: 0; }
        /* Photo caption textarea - auto-expanding */
        .caption-textarea {
            min-height: 2.5rem;
            max-height: 8rem;
            resize: none;
            overflow-y: auto;
            line-height: 1.3;
            field-sizing: content;
        }
        .caption-counter {
            font-size: 10px;
            color: #94a3b8;
            text-align: right;
            transition: color 0.2s ease;
        }
        .caption-counter.warning { color: #f59e0b; }
        .caption-counter.limit { color: #ef4444; }
        /* Auto-expanding textareas */
        .auto-expand {
            min-height: 72px; /* ~3 lines */
            max-height: 400px;
            overflow-y: hidden;
            resize: none;
            transition: height 0.1s ease-out;
        }
        .auto-expand.scrollable {
            overflow-y: auto;
        }
        /* Mode selection cards */
        .mode-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .mode-card:active {
            transform: translateY(0);
        }
        /* Minimal mode field notes textarea */
        .field-notes-textarea {
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
            resize: none;
            transition: height 0.1s ease-out;
            font-size: 16px;
            line-height: 1.6;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="header-stripe"></div>

    <!-- MODE SELECTION SCREEN -->
    <div id="modeSelectionScreen" class="hidden max-w-lg mx-auto min-h-screen flex flex-col">
        <header class="sticky top-0 z-20 bg-dot-navy text-white">
            <div class="p-4 flex items-center justify-between">
                <a href="index.html" class="w-10 h-10 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-arrow-left text-slate-400"></i>
                </a>
                <div class="text-center flex-1 mx-4">
                    <p id="modeSelectionProjectName" class="text-sm font-bold text-white truncate">Daily Report</p>
                    <p id="modeSelectionDate" class="text-xs text-slate-400"></p>
                </div>
                <div class="w-10"></div>
            </div>
        </header>

        <main class="flex-1 p-6 flex flex-col justify-center">
            <div class="text-center mb-8">
                <h2 class="text-xl font-bold text-slate-800 mb-2">How do you want to capture today?</h2>
                <p class="text-sm text-slate-500">Choose your preferred documentation style</p>
            </div>

            <div class="space-y-4">
                <!-- Quick Notes Mode -->
                <button onclick="selectCaptureMode('minimal')" class="mode-card w-full bg-white border-2 border-slate-200 p-6 text-left hover:border-dot-blue">
                    <div class="flex items-start gap-4">
                        <div class="w-14 h-14 bg-dot-blue flex items-center justify-center shrink-0">
                            <i class="fas fa-bolt text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-slate-800 uppercase text-sm mb-1">Quick Notes</p>
                            <p class="text-slate-600 text-sm mb-2">One text box + photos</p>
                            <p class="text-xs text-slate-400">Dictate everything freely. AI organizes it later.</p>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300 mt-4"></i>
                    </div>
                </button>

                <!-- Guided Sections Mode -->
                <button onclick="selectCaptureMode('guided')" class="mode-card w-full bg-white border-2 border-slate-200 p-6 text-left hover:border-safety-green">
                    <div class="flex items-start gap-4">
                        <div class="w-14 h-14 bg-safety-green flex items-center justify-center shrink-0">
                            <i class="fas fa-list-check text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-slate-800 uppercase text-sm mb-1">Guided Sections</p>
                            <p class="text-slate-600 text-sm mb-2">Work • Issues • Safety • Equipment</p>
                            <p class="text-xs text-slate-400">More structure upfront. Fill in each category.</p>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300 mt-4"></i>
                    </div>
                </button>
            </div>
        </main>
    </div>

    <!-- MINIMAL MODE UI -->
    <div id="minimalModeApp" class="hidden max-w-lg mx-auto min-h-screen flex flex-col">
        <!-- Minimal Mode Header -->
        <header class="sticky top-0 z-20 bg-dot-navy text-white">
            <div class="p-4 flex items-center justify-between">
                <a href="index.html" class="w-10 h-10 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-arrow-left text-slate-400"></i>
                </a>
                <div class="text-center flex-1 mx-4">
                    <p class="text-[10px] font-bold text-dot-blue uppercase tracking-widest">Quick Notes</p>
                    <p id="minimalCurrentDate" class="text-sm text-slate-400"></p>
                </div>
                <button onclick="showSwitchModeConfirm()" class="w-10 h-10 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors" title="Switch Mode">
                    <i class="fas fa-exchange-alt text-slate-400"></i>
                </button>
            </div>
        </header>

        <!-- Minimal Mode Content -->
        <main class="flex-1 p-4 pb-32 space-y-4 overflow-y-auto hide-scrollbar">
            <!-- Weather Card (Minimal) -->
            <div class="bg-white border-2 border-slate-200 p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-dot-blue flex items-center justify-center">
                            <i id="minimalWeatherIcon" class="fas fa-cloud-sun text-white"></i>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-slate-500 uppercase">Weather</p>
                            <p id="minimalWeatherCondition" class="text-sm font-bold text-slate-800">Loading...</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p id="minimalWeatherTemp" class="text-lg font-bold text-slate-800">--</p>
                        <p id="minimalWeatherPrecip" class="text-xs text-slate-500">Precip: --</p>
                    </div>
                </div>
            </div>

            <!-- Field Notes Section -->
            <div class="bg-white border-2 border-slate-200 p-4">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-dot-navy flex items-center justify-center">
                        <i class="fas fa-microphone text-dot-yellow"></i>
                    </div>
                    <div>
                        <p class="font-bold text-slate-800 uppercase text-sm">Field Notes</p>
                        <p class="text-xs text-slate-500">Dictate or type everything here</p>
                    </div>
                </div>
                <textarea
                    id="freeform-notes-input"
                    class="w-full bg-slate-50 border-2 border-slate-200 px-4 py-4 text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue focus:bg-white field-notes-textarea"
                    placeholder="Dictate everything here - contractors, work performed, issues, observations. AI will organize it later.

Example: 'ABC Concrete had 5 workers pouring the foundation today. Weather was good, no delays. Noticed some rebar spacing issues in section 3 that need attention. Safety meeting held at 7am.'"
                    oninput="updateFieldNotes(this.value); autoExpandFieldNotes(this);"
                ></textarea>
                <div class="flex items-center justify-between mt-2">
                    <p class="text-xs text-slate-400">
                        <i class="fas fa-microphone mr-1"></i>Use keyboard mic to dictate
                    </p>
                    <p id="fieldNotesCharCount" class="text-xs text-slate-400"></p>
                </div>
            </div>

            <!-- Photos Section (Minimal) -->
            <div class="bg-white border-2 border-slate-200 p-4">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-dot-navy flex items-center justify-center">
                        <i class="fas fa-camera text-dot-yellow"></i>
                    </div>
                    <div>
                        <p class="font-bold text-slate-800 uppercase text-sm">Progress Photos</p>
                        <p id="minimalPhotosCount" class="text-xs text-slate-500">No photos yet</p>
                    </div>
                </div>
                <label class="block cursor-pointer mb-3">
                    <input type="file" accept="image/*" capture="environment" multiple class="hidden" id="minimalPhotoInput">
                    <div class="border-2 border-dashed border-slate-300 p-4 text-center hover:border-dot-blue hover:bg-slate-50 transition-colors">
                        <i class="fas fa-camera text-xl text-slate-400 mb-1"></i>
                        <p class="font-bold text-slate-600 uppercase text-xs">Tap to Add Photos</p>
                    </div>
                </label>
                <div id="minimalPhotosGrid" class="grid grid-cols-3 gap-2"></div>
            </div>
        </main>

        <!-- Finish Button (Fixed at bottom) -->
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-slate-100 via-slate-100 to-transparent">
            <div class="max-w-lg mx-auto">
                <button onclick="finishMinimalReport()" class="w-full p-4 bg-safety-green hover:bg-green-700 text-white font-bold uppercase transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-check"></i>
                    Finish & Process
                </button>
            </div>
        </div>
    </div>

    <!-- Switch Mode Confirmation Modal -->
    <div id="switchModeModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm">
            <div class="bg-dot-navy text-white p-4 text-center">
                <i class="fas fa-exchange-alt text-2xl mb-2"></i>
                <p class="font-bold uppercase">Switch Mode?</p>
            </div>
            <div class="p-4">
                <p class="text-sm text-slate-600 mb-4">
                    Switching modes will preserve your photos and weather data.
                    <span id="switchModeWarning" class="hidden text-red-600 font-medium">Your field notes will be moved to Additional Notes.</span>
                </p>
                <div class="space-y-2">
                    <button onclick="confirmSwitchMode()" class="w-full p-3 bg-dot-blue hover:bg-dot-navy text-white font-bold uppercase transition-colors">
                        Switch to <span id="switchModeTarget">Guided Sections</span>
                    </button>
                    <button onclick="closeSwitchModeModal()" class="w-full p-3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-medium transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="hidden max-w-lg mx-auto min-h-screen flex flex-col">

        <!-- Permissions Warning Banner -->
        <div id="permissionsWarningBanner" class="hidden bg-dot-orange">
            <div class="px-4 py-3 flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-white"></i>
                <p class="flex-1 text-sm text-white font-medium">Some features require permissions</p>
                <a href="permissions.html" class="px-3 py-1.5 bg-white text-dot-orange font-bold text-xs">Enable</a>
                <button onclick="dismissWarningBanner()" class="text-white/80 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Dictation Hint Banner -->
        <div id="dictationHintBanner" class="bg-dot-blue/10 border-b border-dot-blue/20 px-4 py-3 flex items-center gap-3">
            <i class="fas fa-microphone text-dot-blue"></i>
            <p class="flex-1 text-sm text-slate-600">
                <span class="font-medium">Pro tip:</span> Tap any text field and use the
                <i class="fas fa-microphone text-xs"></i> on your keyboard to dictate
            </p>
            <button onclick="dismissDictationHint()" class="text-slate-400 hover:text-slate-600">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- HEADER -->
        <header class="sticky top-0 z-20 bg-dot-navy text-white">
            <div class="p-4 flex items-center justify-between">
                <a href="index.html" class="w-10 h-10 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-arrow-left text-slate-400"></i>
                </a>
                <div class="text-center flex-1 mx-2">
                    <p class="text-[10px] font-bold text-safety-green uppercase tracking-widest">Guided Sections</p>
                    <p id="currentDate" class="text-sm text-slate-400"></p>
                </div>
                <button onclick="showSwitchModeConfirm()" class="w-10 h-10 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors mr-2" title="Switch Mode">
                    <i class="fas fa-exchange-alt text-slate-400"></i>
                </button>
                <button onclick="finishReport()" class="px-4 py-2 bg-safety-green hover:bg-green-700 text-white text-sm font-bold uppercase transition-colors">
                    Finish
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="px-4 pb-3 flex items-center gap-3">
                <div class="flex-1 h-2 bg-slate-700 overflow-hidden">
                    <div id="progressBar" class="h-full bg-safety-green transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="progressText" class="text-xs font-bold text-slate-400">0%</span>
            </div>
        </header>

        <!-- SECTIONS LIST -->
        <main class="flex-1 p-4 pb-8 space-y-3 overflow-y-auto hide-scrollbar">

            <!-- Reporter Information Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="reporter">
                <button onclick="toggleSection('reporter')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-navy flex items-center justify-center">
                        <i class="fas fa-user-circle text-dot-yellow text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Reporter Information</p>
                        <p id="reporter-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="reporter-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Inspector / RPR Name <span class="text-red-500">*</span></label>
                            <input type="text" id="reporter-name-input" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue" placeholder="Enter your full name">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Information Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="project">
                <button onclick="toggleSection('project')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-blue flex items-center justify-center">
                        <i class="fas fa-hard-hat text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Project Information</p>
                        <p id="project-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="project-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Project Name <span class="text-red-500">*</span></label>
                            <input type="text" id="project-name-input" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue" placeholder="Enter project name">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Contract Day Number <span class="text-red-500">*</span></label>
                            <input type="number" id="project-day-input" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue" placeholder="e.g., 45" min="1">
                            <p class="text-xs text-slate-400 mt-1">What day of the contract is this?</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weather Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="weather">
                <button onclick="toggleSection('weather')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-blue flex items-center justify-center">
                        <i class="fas fa-cloud-sun text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Weather & Site Conditions</p>
                        <p id="weather-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="weather-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div class="bg-slate-50 border border-slate-200 p-3">
                            <div class="grid grid-cols-3 gap-3 text-sm">
                                <div><span class="text-slate-400 text-xs uppercase">Condition</span><p id="weather-condition" class="font-bold text-slate-700">--</p></div>
                                <div><span class="text-slate-400 text-xs uppercase">Temp</span><p id="weather-temp" class="font-bold text-slate-700">--</p></div>
                                <div><span class="text-slate-400 text-xs uppercase">Precip</span><p id="weather-precip" class="font-bold text-slate-700">--</p></div>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Site Conditions</label>
                            <div class="mt-2">
                                <textarea id="site-conditions-input" class="w-full bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue auto-expand" rows="3" placeholder="Describe site conditions..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Work Summary Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="activities">
                <button onclick="toggleSection('activities')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-safety-green flex items-center justify-center">
                        <i class="fas fa-tasks text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Work Summary</p>
                        <p id="activities-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="activities-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <!-- No project warning -->
                        <div id="no-project-warning" class="hidden bg-dot-orange/10 border-2 border-dashed border-dot-orange p-4 text-center">
                            <i class="fas fa-exclamation-triangle text-dot-orange text-xl mb-2"></i>
                            <p class="text-sm font-bold text-dot-orange uppercase mb-1">No Project Selected</p>
                            <p class="text-xs text-slate-600 mb-3">Select a project to load contractors</p>
                            <a href="project-config.html" class="inline-block px-4 py-2 bg-dot-orange text-white text-sm font-bold uppercase">Setup Project</a>
                        </div>
                        <!-- Contractor work cards -->
                        <div id="contractor-work-list" class="space-y-3">
                            <!-- Rendered by renderContractorWorkCards() -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personnel/Operations Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="operations">
                <button onclick="toggleSection('operations')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-blue flex items-center justify-center">
                        <i class="fas fa-users text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Personnel / Operations</p>
                        <p id="operations-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="operations-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <!-- No project warning -->
                        <div id="no-project-warning-ops" class="hidden bg-dot-orange/10 border-2 border-dashed border-dot-orange p-4 text-center">
                            <i class="fas fa-exclamation-triangle text-dot-orange text-xl mb-2"></i>
                            <p class="text-sm font-bold text-dot-orange uppercase mb-1">No Project Selected</p>
                            <p class="text-xs text-slate-600 mb-3">Select a project to load contractors</p>
                            <a href="project-config.html" class="inline-block px-4 py-2 bg-dot-orange text-white text-sm font-bold uppercase">Setup Project</a>
                        </div>
                        <!-- Personnel cards (collapsible per contractor) -->
                        <div id="personnel-list" class="space-y-3">
                            <!-- Rendered by renderPersonnelCards() -->
                        </div>
                        <!-- Personnel Totals Summary -->
                        <div id="personnel-totals" class="hidden bg-slate-100 border-2 border-slate-300 p-3">
                            <p class="text-xs font-bold text-slate-600 uppercase mb-2">Personnel Totals</p>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div class="bg-white p-2 border border-slate-200 text-center">
                                    <p class="text-slate-500">Superintendent</p>
                                    <p id="total-supt" class="font-bold text-dot-blue text-lg">0</p>
                                </div>
                                <div class="bg-white p-2 border border-slate-200 text-center">
                                    <p class="text-slate-500">Foreman</p>
                                    <p id="total-frmn" class="font-bold text-dot-blue text-lg">0</p>
                                </div>
                                <div class="bg-white p-2 border border-slate-200 text-center">
                                    <p class="text-slate-500">Operator</p>
                                    <p id="total-oper" class="font-bold text-dot-blue text-lg">0</p>
                                </div>
                                <div class="bg-white p-2 border border-slate-200 text-center">
                                    <p class="text-slate-500">Laborer</p>
                                    <p id="total-labr" class="font-bold text-dot-blue text-lg">0</p>
                                </div>
                                <div class="bg-white p-2 border border-slate-200 text-center">
                                    <p class="text-slate-500">Surveyor</p>
                                    <p id="total-surv" class="font-bold text-dot-blue text-lg">0</p>
                                </div>
                                <div class="bg-white p-2 border border-slate-200 text-center">
                                    <p class="text-slate-500">Other</p>
                                    <p id="total-othr" class="font-bold text-dot-blue text-lg">0</p>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-slate-300 flex justify-between items-center">
                                <span class="text-sm font-bold text-slate-600 uppercase">Grand Total</span>
                                <span id="total-personnel" class="text-lg font-bold text-dot-blue">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="equipment">
                <button onclick="toggleSection('equipment')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-orange flex items-center justify-center">
                        <i class="fas fa-truck text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Equipment</p>
                        <p id="equipment-preview" class="text-sm text-slate-500 truncate">Tap to add</p>
                    </div>
                    <div id="equipment-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <!-- No project warning -->
                        <div id="no-project-warning-equip" class="hidden bg-dot-orange/10 border-2 border-dashed border-dot-orange p-4 text-center">
                            <i class="fas fa-exclamation-triangle text-dot-orange text-xl mb-2"></i>
                            <p class="text-sm font-bold text-dot-orange uppercase mb-1">No Project Selected</p>
                            <p class="text-xs text-slate-600 mb-3">Select a project to load equipment</p>
                            <a href="project-config.html" class="inline-block px-4 py-2 bg-dot-orange text-white text-sm font-bold uppercase">Setup Project</a>
                        </div>
                        <!-- No equipment warning -->
                        <div id="no-equipment-warning" class="hidden bg-slate-100 border-2 border-dashed border-slate-300 p-4 text-center">
                            <i class="fas fa-truck text-slate-400 text-xl mb-2"></i>
                            <p class="text-sm font-bold text-slate-500 uppercase mb-1">No Equipment Configured</p>
                            <p class="text-xs text-slate-500 mb-3">Add equipment in project configuration</p>
                            <a href="project-config.html" class="inline-block px-4 py-2 bg-dot-blue text-white text-sm font-bold uppercase">Add Equipment</a>
                        </div>
                        <!-- Mark All IDLE button -->
                        <button onclick="markAllEquipmentIdle()" id="mark-all-idle-btn" class="hidden w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-moon mr-2"></i>Mark All IDLE
                        </button>
                        <!-- Equipment rows grouped by contractor -->
                        <div id="equipment-list" class="space-y-3">
                            <!-- Rendered by renderEquipmentCards() -->
                        </div>
                        <!-- Equipment totals -->
                        <div id="equipment-totals" class="hidden bg-slate-100 border-2 border-slate-300">
                            <div class="p-2 text-xs font-bold">
                                <div class="flex justify-between">
                                    <span class="text-slate-600 uppercase">Total Equipment</span>
                                    <span id="equipment-total-count" class="text-dot-blue">0</span>
                                </div>
                                <div class="flex justify-between mt-1">
                                    <span class="text-slate-500">Active (Hours Logged)</span>
                                    <span id="equipment-active-count" class="text-safety-green">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-500">Idle</span>
                                    <span id="equipment-idle-count" class="text-slate-400">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Issues Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="issues">
                <button onclick="toggleSection('issues')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-red-600 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Issues & Delays</p>
                        <p id="issues-preview" class="text-sm text-slate-500 truncate">None reported</p>
                    </div>
                    <div id="issues-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <button onclick="markNA('issues')" id="issues-na-btn" class="w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-check mr-2"></i>No Issues - Mark as N/A
                        </button>
                        <div id="issues-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <textarea id="issue-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue auto-expand" rows="3" placeholder="Describe any issues or delays..."></textarea>
                            <button onclick="addIssue()" class="px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-bold transition-colors"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inspections Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="inspections">
                <button onclick="toggleSection('inspections')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-violet-600 flex items-center justify-center">
                        <i class="fas fa-check-double text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">QA/QC Inspections</p>
                        <p id="inspections-preview" class="text-sm text-slate-500 truncate">None reported</p>
                    </div>
                    <div id="inspections-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <button onclick="markNA('inspections')" id="inspections-na-btn" class="w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-ban mr-2"></i>No Inspections - Mark as N/A
                        </button>
                        <div id="inspections-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <textarea id="inspection-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue auto-expand" rows="3" placeholder="Describe inspections or testing..."></textarea>
                            <button onclick="addInspection()" class="px-4 py-3 bg-violet-600 hover:bg-violet-700 text-white font-bold transition-colors"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Safety Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="safety">
                <button onclick="toggleSection('safety')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-safety-green flex items-center justify-center">
                        <i class="fas fa-hard-hat text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Safety</p>
                        <p id="safety-preview" class="text-sm text-slate-500 truncate">No incidents</p>
                    </div>
                    <div id="safety-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-3 p-3 bg-safety-green/10 border-2 border-safety-green cursor-pointer">
                                <input type="checkbox" id="no-incidents" class="w-5 h-5">
                                <span class="font-medium text-safety-green text-sm uppercase">No Incidents</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-red-50 border-2 border-red-500 cursor-pointer">
                                <input type="checkbox" id="has-incidents" class="w-5 h-5">
                                <span class="font-medium text-red-600 text-sm uppercase">Incident</span>
                            </label>
                        </div>
                        <div id="safety-list" class="space-y-2"></div>
                        <div class="flex items-center gap-2">
                            <textarea id="safety-input" class="flex-1 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue auto-expand" rows="3" placeholder="Safety notes, toolbox talks..."></textarea>
                            <button onclick="addSafetyNote()" class="px-4 py-3 bg-safety-green hover:bg-green-700 text-white font-bold transition-colors"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Communications with Contractor Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="communications">
                <button onclick="toggleSection('communications')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-blue flex items-center justify-center">
                        <i class="fas fa-comments text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Communications with Contractor</p>
                        <p id="communications-preview" class="text-sm text-slate-500 truncate">None reported</p>
                    </div>
                    <div id="communications-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <button onclick="markNA('communications')" id="communications-na-btn" class="w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-ban mr-2"></i>No Communications - Mark as N/A
                        </button>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Contractor Communications</label>
                            <textarea id="contractor-communications-input" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue auto-expand" rows="3" placeholder="Document any communications with contractors today (e.g., discussions about schedule, QC coordination, directives given)..."></textarea>
                            <p class="text-xs text-slate-400 mt-1">Tap the <i class="fas fa-microphone text-xs"></i> on your keyboard to dictate</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visitors/Deliveries/Remarks Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="visitors">
                <button onclick="toggleSection('visitors')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-blue flex items-center justify-center">
                        <i class="fas fa-truck-loading text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-xs leading-tight">Visitors; Deliveries; Additional Contract and/or Change Order Activities; Other Remarks</p>
                        <p id="visitors-preview" class="text-sm text-slate-500 truncate">None reported</p>
                    </div>
                    <div id="visitors-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <button onclick="markNA('visitors')" id="visitors-na-btn" class="w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-ban mr-2"></i>Nothing to Report - Mark as N/A
                        </button>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Visitors, Deliveries & Remarks</label>
                            <textarea id="visitors-remarks-input" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue auto-expand" rows="3" placeholder="Document visitors, deliveries, change orders, and other remarks (e.g., DOT inspectors on site, material deliveries, change order work)..."></textarea>
                            <p class="text-xs text-slate-400 mt-1">Tap the <i class="fas fa-microphone text-xs"></i> on your keyboard to dictate</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="photos">
                <button onclick="toggleSection('photos')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-dot-navy flex items-center justify-center">
                        <i class="fas fa-camera text-dot-yellow text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Progress Photos</p>
                        <p id="photos-preview" class="text-sm text-slate-500 truncate">No photos</p>
                    </div>
                    <div id="photos-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <button onclick="markNA('photos')" id="photos-na-btn" class="w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase">
                            <i class="fas fa-ban mr-2"></i>No Photos - Mark as N/A
                        </button>
                        <label class="block cursor-pointer" id="photos-upload-label">
                            <input type="file" accept="image/*" capture="environment" multiple class="hidden" id="photoInput">
                            <div class="border-2 border-dashed border-slate-300 p-6 text-center hover:border-dot-blue hover:bg-slate-50 transition-colors">
                                <i class="fas fa-camera text-2xl text-slate-400 mb-2"></i>
                                <p class="font-bold text-slate-600 uppercase text-sm">Tap to Add Photos</p>
                                <p class="text-xs text-slate-400">GPS location will be captured</p>
                            </div>
                        </label>
                        <div id="photos-grid" class="grid grid-cols-2 gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Additional Notes Section -->
            <div class="section-card bg-white border-2 border-slate-200" data-section="notes">
                <button onclick="toggleSection('notes')" class="w-full p-4 flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-600 flex items-center justify-center">
                        <i class="fas fa-sticky-note text-white text-lg"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-bold text-slate-800 uppercase text-sm">Additional Notes</p>
                        <p id="notes-preview" class="text-sm text-slate-500 truncate">Optional</p>
                    </div>
                    <div id="notes-status" class="w-8 h-8 border border-slate-300 flex items-center justify-center">
                        <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                    </div>
                </button>
                <div class="section-content">
                    <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Additional Notes & Comments</label>
                            <div class="mt-2">
                                <textarea id="additional-notes-input" class="w-full bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue auto-expand" rows="3" placeholder="Any other observations, comments, or information not covered above..."></textarea>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">Optional - for anything that doesn't fit other categories</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Permissions Setup Modal -->
    <div id="permissionsModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm">
            <div class="bg-dot-navy text-white p-6 text-center">
                <div class="w-16 h-16 bg-dot-yellow flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-dot-navy text-2xl"></i>
                </div>
                <p class="text-xl font-bold uppercase">Enable Permissions</p>
                <p class="text-sm text-slate-400 mt-1">Required for voice recording & weather</p>
            </div>

            <div class="p-4 space-y-3">
                <!-- Microphone Permission -->
                <div id="micPermissionRow" class="bg-slate-50 border border-slate-200 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-dot-navy flex items-center justify-center">
                                <i class="fas fa-microphone text-dot-yellow"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 text-sm uppercase">Microphone</p>
                                <p id="micPermissionStatus" class="text-xs text-slate-500">For keyboard dictation</p>
                            </div>
                        </div>
                        <button id="micPermissionBtn" onclick="requestMicrophonePermission()" class="px-4 py-2 bg-dot-navy hover:bg-dot-blue text-white text-xs font-bold uppercase transition-colors">Enable</button>
                    </div>
                </div>

                <!-- Location Permission -->
                <div id="locPermissionRow" class="bg-slate-50 border border-slate-200 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-safety-green flex items-center justify-center">
                                <i class="fas fa-location-dot text-white"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 text-sm uppercase">Location</p>
                                <p id="locPermissionStatus" class="text-xs text-slate-500">For weather & GPS</p>
                            </div>
                        </div>
                        <button id="locPermissionBtn" onclick="requestLocationPermission()" class="px-4 py-2 bg-safety-green hover:bg-green-700 text-white text-xs font-bold uppercase transition-colors">Enable</button>
                    </div>
                </div>
            </div>

            <div class="p-4 pt-0 space-y-2">
                <button id="permissionsContinueBtn" onclick="closePermissionsModal()" class="w-full p-4 bg-dot-navy hover:bg-dot-blue text-white font-bold uppercase transition-colors">Continue</button>
                <button onclick="closePermissionsModal()" class="w-full p-3 text-slate-500 hover:text-slate-700 text-sm font-medium">Skip for now</button>
            </div>
        </div>
    </div>

    <script>
        // ============ STATE ============
        let currentSection = null;
        let report = null;
        let permissionsChecked = false;
        let activeProject = null;
        let projectContractors = [];

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOSSafari = isIOS && isSafari;
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        // ============ AUTO-EXPAND TEXTAREAS ============
        /**
         * Auto-expand a textarea to fit its content
         * - Starts at reasonable height (3-4 lines via CSS min-height)
         * - Grows to fit content up to max-height (400px)
         * - Shows scrollbar only when content exceeds max-height
         * - On blur, collapses to fit content (no empty space)
         */
        function autoExpand(textarea) {
            if (!textarea) return;

            const maxHeight = 400;
            const minHeight = 72; // ~3 lines

            // Reset height to recalculate
            textarea.style.height = 'auto';

            // Calculate new height
            const newHeight = Math.max(minHeight, Math.min(textarea.scrollHeight, maxHeight));
            textarea.style.height = newHeight + 'px';

            // Toggle scrollable class based on whether content exceeds max
            if (textarea.scrollHeight > maxHeight) {
                textarea.classList.add('scrollable');
            } else {
                textarea.classList.remove('scrollable');
            }
        }

        /**
         * Initialize auto-expand behavior on a textarea
         */
        function initAutoExpand(textarea) {
            if (!textarea || textarea.dataset.autoExpandInit) return;

            textarea.dataset.autoExpandInit = 'true';

            // Add the auto-expand class if not already present
            if (!textarea.classList.contains('auto-expand')) {
                textarea.classList.add('auto-expand');
            }

            // Listen for input events (typing, dictation, paste)
            textarea.addEventListener('input', () => autoExpand(textarea));

            // Listen for change events (programmatic changes)
            textarea.addEventListener('change', () => autoExpand(textarea));

            // On focus, expand to fit content
            textarea.addEventListener('focus', () => autoExpand(textarea));

            // On blur, collapse to content size (remove empty space)
            textarea.addEventListener('blur', () => {
                // Small delay to ensure content is finalized
                setTimeout(() => autoExpand(textarea), 10);
            });

            // Initial sizing
            autoExpand(textarea);
        }

        /**
         * Initialize all textareas with auto-expand class
         */
        function initAllAutoExpandTextareas() {
            document.querySelectorAll('textarea.auto-expand').forEach(initAutoExpand);
        }

        // ============ CAPTURE MODE HANDLING ============
        /**
         * Check if we should show mode selection screen
         * Show if: no captureMode set AND report is essentially empty
         */
        function shouldShowModeSelection() {
            if (!report) return true;
            if (report.meta?.captureMode) return false;

            // Check if report has any meaningful data (besides default values)
            const hasPhotos = report.photos?.length > 0;
            const hasActivities = report.activities?.length > 0;
            const hasIssues = report.generalIssues?.length > 0;
            const hasNotes = report.additionalNotes?.trim().length > 0;
            const hasFieldNotes = report.fieldNotes?.freeformNotes?.trim().length > 0;
            const hasReporterName = report.reporter?.name?.trim().length > 0;

            // If any data exists, don't show mode selection
            return !(hasPhotos || hasActivities || hasIssues || hasNotes || hasFieldNotes || hasReporterName);
        }

        /**
         * Select a capture mode and show the appropriate UI
         */
        function selectCaptureMode(mode) {
            report.meta.captureMode = mode;
            saveReport();
            showModeUI(mode);
        }

        /**
         * Show the appropriate UI for the selected mode
         */
        function showModeUI(mode) {
            const modeSelectionScreen = document.getElementById('modeSelectionScreen');
            const minimalModeApp = document.getElementById('minimalModeApp');
            const guidedModeApp = document.getElementById('app');

            modeSelectionScreen.classList.add('hidden');

            if (mode === 'minimal') {
                minimalModeApp.classList.remove('hidden');
                guidedModeApp.classList.add('hidden');
                initMinimalModeUI();
            } else {
                minimalModeApp.classList.add('hidden');
                guidedModeApp.classList.remove('hidden');
                initGuidedModeUI();
            }
        }

        /**
         * Show the mode selection screen
         */
        function showModeSelectionScreen() {
            const modeSelectionScreen = document.getElementById('modeSelectionScreen');
            const minimalModeApp = document.getElementById('minimalModeApp');
            const guidedModeApp = document.getElementById('app');

            modeSelectionScreen.classList.remove('hidden');
            minimalModeApp.classList.add('hidden');
            guidedModeApp.classList.add('hidden');

            // Update mode selection header
            const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            document.getElementById('modeSelectionDate').textContent = dateStr;

            if (activeProject) {
                document.getElementById('modeSelectionProjectName').textContent = activeProject.name;
            }
        }

        /**
         * Show confirmation modal for switching modes
         */
        function showSwitchModeConfirm() {
            const modal = document.getElementById('switchModeModal');
            const warning = document.getElementById('switchModeWarning');
            const targetSpan = document.getElementById('switchModeTarget');
            const currentMode = report.meta?.captureMode;

            // Set target mode text
            if (currentMode === 'minimal') {
                targetSpan.textContent = 'Guided Sections';
                // Show warning if there are field notes
                if (report.fieldNotes?.freeformNotes?.trim()) {
                    warning.classList.remove('hidden');
                } else {
                    warning.classList.add('hidden');
                }
            } else {
                targetSpan.textContent = 'Quick Notes';
                warning.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        /**
         * Close the switch mode confirmation modal
         */
        function closeSwitchModeModal() {
            document.getElementById('switchModeModal').classList.add('hidden');
        }

        /**
         * Confirm switching modes
         */
        function confirmSwitchMode() {
            const currentMode = report.meta?.captureMode;
            const newMode = currentMode === 'minimal' ? 'guided' : 'minimal';

            // Preserve data when switching
            if (currentMode === 'minimal' && newMode === 'guided') {
                // Move field notes to additionalNotes if not empty
                if (report.fieldNotes?.freeformNotes?.trim()) {
                    const existingNotes = report.additionalNotes?.trim() || '';
                    const fieldNotes = report.fieldNotes.freeformNotes.trim();
                    report.additionalNotes = existingNotes
                        ? `${existingNotes}\n\n--- Field Notes ---\n${fieldNotes}`
                        : fieldNotes;
                }
            }

            // Photos and weather are always preserved (shared between modes)

            report.meta.captureMode = newMode;
            saveReport();
            closeSwitchModeModal();
            showModeUI(newMode);
        }

        // ============ MINIMAL MODE UI ============
        /**
         * Initialize the minimal mode UI
         */
        function initMinimalModeUI() {
            // Set date
            const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            document.getElementById('minimalCurrentDate').textContent = dateStr;

            // Load field notes
            const notesInput = document.getElementById('freeform-notes-input');
            if (notesInput) {
                notesInput.value = report.fieldNotes?.freeformNotes || '';
                autoExpandFieldNotes(notesInput);
                updateFieldNotesCharCount();
            }

            // Update weather display
            updateMinimalWeatherDisplay();

            // Render photos
            renderMinimalPhotos();

            // Setup photo input handler
            const photoInput = document.getElementById('minimalPhotoInput');
            if (photoInput) {
                photoInput.addEventListener('change', handleMinimalPhotoInput);
            }
        }

        /**
         * Initialize the guided mode UI (existing functionality)
         */
        function initGuidedModeUI() {
            // Set date
            const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            document.getElementById('currentDate').textContent = dateStr;

            renderAllSections();
            updateAllPreviews();
            updateProgress();
            updateNAButtons();

            // Populate fields
            document.getElementById('reporter-name-input').value = report.reporter?.name || '';
            document.getElementById('project-name-input').value = report.project?.name || '';
            document.getElementById('project-day-input').value = report.project?.dayNumber || '';
            document.getElementById('additional-notes-input').value = report.additionalNotes || '';
            document.getElementById('contractor-communications-input').value = report.contractorCommunications || '';
            document.getElementById('visitors-remarks-input').value = report.visitorsRemarks || '';

            document.getElementById('no-incidents').checked = report.safety?.noIncidents || false;
            document.getElementById('has-incidents').checked = report.safety?.hasIncidents || false;

            // Initialize auto-expand for all textareas
            initAllAutoExpandTextareas();
        }

        /**
         * Auto-expand the field notes textarea
         */
        function autoExpandFieldNotes(textarea) {
            if (!textarea) return;
            const minHeight = 200;
            const maxHeight = window.innerHeight * 0.6;

            textarea.style.height = 'auto';
            const newHeight = Math.max(minHeight, Math.min(textarea.scrollHeight, maxHeight));
            textarea.style.height = newHeight + 'px';
        }

        /**
         * Update field notes in the report
         */
        function updateFieldNotes(value) {
            if (!report.fieldNotes) report.fieldNotes = { freeformNotes: "" };
            report.fieldNotes.freeformNotes = value;
            saveReport();
            updateFieldNotesCharCount();
        }

        /**
         * Update the character count display for field notes
         */
        function updateFieldNotesCharCount() {
            const charCount = document.getElementById('fieldNotesCharCount');
            const notes = report.fieldNotes?.freeformNotes || '';
            const len = notes.length;
            if (len > 0) {
                charCount.textContent = `${len.toLocaleString()} characters`;
            } else {
                charCount.textContent = '';
            }
        }

        /**
         * Update the weather display in minimal mode
         */
        function updateMinimalWeatherDisplay() {
            const weather = report.overview?.weather;
            if (!weather) return;

            const conditionEl = document.getElementById('minimalWeatherCondition');
            const tempEl = document.getElementById('minimalWeatherTemp');
            const precipEl = document.getElementById('minimalWeatherPrecip');
            const iconEl = document.getElementById('minimalWeatherIcon');

            if (conditionEl) conditionEl.textContent = weather.generalCondition || '--';
            if (tempEl) {
                const high = weather.highTemp || '--';
                const low = weather.lowTemp || '--';
                tempEl.textContent = `${high}° / ${low}°`;
            }
            if (precipEl) precipEl.textContent = `Precip: ${weather.precipitation || '--'}`;

            // Update icon based on condition
            if (iconEl) {
                const condition = (weather.generalCondition || '').toLowerCase();
                let iconClass = 'fa-cloud-sun';
                if (condition.includes('rain') || condition.includes('shower')) iconClass = 'fa-cloud-rain';
                else if (condition.includes('cloud')) iconClass = 'fa-cloud';
                else if (condition.includes('sun') || condition.includes('clear')) iconClass = 'fa-sun';
                else if (condition.includes('snow')) iconClass = 'fa-snowflake';
                else if (condition.includes('storm') || condition.includes('thunder')) iconClass = 'fa-bolt';
                iconEl.className = `fas ${iconClass} text-white`;
            }
        }

        /**
         * Render photos in minimal mode
         */
        function renderMinimalPhotos() {
            const grid = document.getElementById('minimalPhotosGrid');
            const countEl = document.getElementById('minimalPhotosCount');

            if (!grid) return;

            const photos = report.photos || [];
            countEl.textContent = photos.length > 0 ? `${photos.length} photo${photos.length > 1 ? 's' : ''}` : 'No photos yet';

            if (photos.length === 0) {
                grid.innerHTML = '';
                return;
            }

            grid.innerHTML = photos.map((p, idx) => `
                <div class="relative aspect-square bg-slate-200 overflow-hidden">
                    <img src="${p.url}" class="w-full h-full object-cover">
                    <button onclick="deleteMinimalPhoto(${idx})" class="absolute top-1 right-1 w-6 h-6 bg-red-600 text-white flex items-center justify-center hover:bg-red-700">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        /**
         * Handle photo input in minimal mode
         */
        async function handleMinimalPhotoInput(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                try {
                    // Get GPS if available
                    let gps = null;
                    try {
                        const pos = await new Promise((res, rej) =>
                            navigator.geolocation.getCurrentPosition(res, rej, { timeout: 5000 })
                        );
                        gps = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    } catch (e) {}

                    // Compress and store image
                    const compressed = await compressImage(await readFileAsDataURL(file));

                    report.photos.push({
                        id: `photo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        url: compressed,
                        caption: '',
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                        gps: gps
                    });

                    saveReport();
                    renderMinimalPhotos();
                } catch (err) {
                    console.error('Error adding photo:', err);
                    showToast('Failed to add photo', 'error');
                }
            }

            // Reset input
            e.target.value = '';
        }

        /**
         * Read file as data URL
         */
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        /**
         * Delete a photo in minimal mode
         */
        function deleteMinimalPhoto(idx) {
            if (!confirm('Delete this photo?')) return;
            report.photos.splice(idx, 1);
            saveReport();
            renderMinimalPhotos();
        }

        /**
         * Finish the minimal mode report and go to review
         */
        function finishMinimalReport() {
            // Mark as interview completed
            report.meta.interviewCompleted = true;
            saveReport();

            // Navigate to review page
            window.location.href = 'review.html';
        }

        // ============ PROJECT & CONTRACTOR LOADING ============
        const PROJECTS_KEY = 'fvp_projects';
        const ACTIVE_PROJECT_KEY = 'fvp_active_project';

        function loadActiveProject() {
            const activeId = localStorage.getItem(ACTIVE_PROJECT_KEY);
            if (!activeId) {
                activeProject = null;
                projectContractors = [];
                return null;
            }

            const projectsJson = localStorage.getItem(PROJECTS_KEY);
            if (!projectsJson) {
                activeProject = null;
                projectContractors = [];
                return null;
            }

            try {
                const projects = JSON.parse(projectsJson);
                activeProject = projects.find(p => p.id === activeId) || null;
                if (activeProject && activeProject.contractors) {
                    // Sort: prime contractors first, then subcontractors
                    projectContractors = [...activeProject.contractors].sort((a, b) => {
                        if (a.type === 'prime' && b.type !== 'prime') return -1;
                        if (a.type !== 'prime' && b.type === 'prime') return 1;
                        return 0;
                    });
                } else {
                    projectContractors = [];
                }
                return activeProject;
            } catch (e) {
                console.error('Failed to load project:', e);
                activeProject = null;
                projectContractors = [];
                return null;
            }
        }

        function getTodayDateFormatted() {
            return new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        function getContractorActivity(contractorId) {
            if (!report || !report.activities) return null;
            return report.activities.find(a => a.contractorId === contractorId);
        }

        function initializeContractorActivities() {
            if (!report.activities) report.activities = [];

            // Ensure each contractor has an activity entry
            projectContractors.forEach(contractor => {
                const existing = report.activities.find(a => a.contractorId === contractor.id);
                if (!existing) {
                    report.activities.push({
                        contractorId: contractor.id,
                        noWork: true,
                        narrative: '',
                        equipmentUsed: '',
                        crew: ''
                    });
                }
            });
        }

        function renderContractorWorkCards() {
            const container = document.getElementById('contractor-work-list');
            const warningEl = document.getElementById('no-project-warning');

            if (!activeProject || projectContractors.length === 0) {
                warningEl.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }

            warningEl.classList.add('hidden');
            initializeContractorActivities();

            const todayDate = getTodayDateFormatted();

            container.innerHTML = projectContractors.map((contractor, index) => {
                const activity = getContractorActivity(contractor.id) || { noWork: true, narrative: '', equipmentUsed: '', crew: '' };
                const isExpanded = !activity.noWork || activity.narrative;
                const typeLabel = contractor.type === 'prime' ? 'PRIME' : 'SUBCONTRACTOR';
                const tradesText = contractor.trades ? ` (${contractor.trades.toUpperCase()})` : '';
                const headerText = `${contractor.name.toUpperCase()} – ${typeLabel}${tradesText}`;
                const borderColor = contractor.type === 'prime' ? 'border-safety-green' : 'border-dot-blue';
                const bgColor = contractor.type === 'prime' ? 'bg-safety-green' : 'bg-dot-blue';

                return `
                    <div class="contractor-work-card border-2 ${activity.noWork && !activity.narrative ? 'border-slate-200' : borderColor}" data-contractor-id="${contractor.id}">
                        <!-- Header -->
                        <button onclick="toggleContractorCard('${contractor.id}')" class="w-full p-3 flex items-center gap-3 text-left ${activity.noWork && !activity.narrative ? 'bg-slate-50' : bgColor + '/10'}">
                            <div class="w-8 h-8 ${activity.noWork && !activity.narrative ? 'bg-slate-300' : bgColor} flex items-center justify-center shrink-0">
                                <i class="fas ${activity.noWork && !activity.narrative ? 'fa-minus' : 'fa-hard-hat'} text-white text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-bold ${activity.noWork && !activity.narrative ? 'text-slate-500' : (contractor.type === 'prime' ? 'text-safety-green' : 'text-dot-blue')} uppercase leading-tight truncate">${escapeHtml(headerText)}</p>
                                <p class="text-[10px] text-slate-500 mt-0.5">
                                    ${activity.noWork && !activity.narrative ? 'No work performed' : (activity.narrative ? 'Work logged' : 'Tap to add work')}
                                </p>
                            </div>
                            <i id="contractor-chevron-${contractor.id}" class="fas fa-chevron-down text-slate-400 text-xs transition-transform ${isExpanded ? 'rotate-180' : ''}"></i>
                        </button>

                        <!-- Expandable Content -->
                        <div id="contractor-content-${contractor.id}" class="contractor-content ${isExpanded ? '' : 'hidden'} border-t border-slate-200 p-3 space-y-3">
                            <!-- No Work Toggle -->
                            <label class="flex items-center gap-3 p-3 bg-slate-100 border border-slate-300 cursor-pointer hover:bg-slate-200 transition-colors">
                                <input type="checkbox"
                                    id="no-work-${contractor.id}"
                                    ${activity.noWork ? 'checked' : ''}
                                    onchange="toggleNoWork('${contractor.id}', this.checked)"
                                    class="w-5 h-5 accent-slate-600">
                                <span class="text-sm font-medium text-slate-600">No work performed on ${todayDate}</span>
                            </label>

                            <!-- Work Entry Fields (hidden when no work checked) -->
                            <div id="work-fields-${contractor.id}" class="${activity.noWork ? 'hidden' : ''}">
                                <!-- Narrative -->
                                <div class="mb-3">
                                    <label class="text-xs font-bold text-slate-500 uppercase">Work Narrative</label>
                                    <textarea
                                        id="narrative-${contractor.id}"
                                        class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue auto-expand"
                                        rows="3"
                                        placeholder="Describe work performed by ${contractor.name}..."
                                        onchange="updateContractorWork('${contractor.id}')"
                                    >${escapeHtml(activity.narrative)}</textarea>
                                </div>

                                <!-- Equipment Used -->
                                <div class="mb-3">
                                    <label class="text-xs font-bold text-slate-500 uppercase">Equipment Used</label>
                                    <input
                                        type="text"
                                        id="equipment-${contractor.id}"
                                        class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue"
                                        placeholder="e.g., JOHN DEERE 550K GP BULLDOZER (1)"
                                        value="${escapeHtml(activity.equipmentUsed)}"
                                        onchange="updateContractorWork('${contractor.id}')"
                                    >
                                    <p class="text-xs text-slate-400 mt-1">Format: EQUIPMENT TYPE (QTY)</p>
                                </div>

                                <!-- Crew -->
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase">Crew</label>
                                    <input
                                        type="text"
                                        id="crew-${contractor.id}"
                                        class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:border-dot-blue"
                                        placeholder="e.g., SUPERINTENDENT (1); FOREMAN (3); OPERATORS (4)"
                                        value="${escapeHtml(activity.crew)}"
                                        onchange="updateContractorWork('${contractor.id}')"
                                    >
                                    <p class="text-xs text-slate-400 mt-1">Format: ROLE (QTY); separated by semicolons</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Initialize auto-expand for dynamically created textareas
            initAllAutoExpandTextareas();
        }

        function toggleContractorCard(contractorId) {
            const content = document.getElementById(`contractor-content-${contractorId}`);
            const chevron = document.getElementById(`contractor-chevron-${contractorId}`);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        function toggleNoWork(contractorId, isNoWork) {
            const activity = report.activities.find(a => a.contractorId === contractorId);
            if (!activity) return;

            activity.noWork = isNoWork;

            const workFields = document.getElementById(`work-fields-${contractorId}`);
            if (isNoWork) {
                workFields.classList.add('hidden');
                // Clear work fields when marking no work
                activity.narrative = '';
                activity.equipmentUsed = '';
                activity.crew = '';
            } else {
                workFields.classList.remove('hidden');
                // Focus the narrative field
                setTimeout(() => {
                    document.getElementById(`narrative-${contractorId}`)?.focus();
                }, 100);
            }

            saveReport();
            updateContractorCardStyle(contractorId);
            updateAllPreviews();
        }

        function updateContractorWork(contractorId) {
            const activity = report.activities.find(a => a.contractorId === contractorId);
            if (!activity) return;

            const narrative = document.getElementById(`narrative-${contractorId}`)?.value.trim() || '';
            const equipment = document.getElementById(`equipment-${contractorId}`)?.value.trim() || '';
            const crew = document.getElementById(`crew-${contractorId}`)?.value.trim() || '';

            activity.narrative = narrative;
            activity.equipmentUsed = equipment;
            activity.crew = crew;

            // If user entered work, uncheck "no work"
            if (narrative || equipment || crew) {
                activity.noWork = false;
                const checkbox = document.getElementById(`no-work-${contractorId}`);
                if (checkbox) checkbox.checked = false;
            }

            saveReport();
            updateContractorCardStyle(contractorId);
            updateAllPreviews();
        }

        function updateContractorCardStyle(contractorId) {
            const activity = report.activities.find(a => a.contractorId === contractorId);
            const contractor = projectContractors.find(c => c.id === contractorId);
            if (!activity || !contractor) return;

            const card = document.querySelector(`[data-contractor-id="${contractorId}"]`);
            if (!card) return;

            const hasWork = !activity.noWork || activity.narrative;
            const borderColor = contractor.type === 'prime' ? 'border-safety-green' : 'border-dot-blue';
            const bgColor = contractor.type === 'prime' ? 'bg-safety-green' : 'bg-dot-blue';

            // Update border
            card.classList.remove('border-slate-200', 'border-safety-green', 'border-dot-blue');
            card.classList.add(hasWork ? borderColor : 'border-slate-200');

            // Update header background
            const header = card.querySelector('button');
            header.classList.remove('bg-slate-50', 'bg-safety-green/10', 'bg-dot-blue/10');
            header.classList.add(hasWork ? bgColor + '/10' : 'bg-slate-50');

            // Update icon
            const iconDiv = header.querySelector('div');
            iconDiv.classList.remove('bg-slate-300', 'bg-safety-green', 'bg-dot-blue');
            iconDiv.classList.add(hasWork ? bgColor : 'bg-slate-300');

            const icon = iconDiv.querySelector('i');
            icon.classList.remove('fa-minus', 'fa-hard-hat');
            icon.classList.add(hasWork ? 'fa-hard-hat' : 'fa-minus');

            // Update text color
            const titleP = header.querySelectorAll('p')[0];
            titleP.classList.remove('text-slate-500', 'text-safety-green', 'text-dot-blue');
            titleP.classList.add(hasWork ? (contractor.type === 'prime' ? 'text-safety-green' : 'text-dot-blue') : 'text-slate-500');

            // Update subtitle
            const subtitleP = header.querySelectorAll('p')[1];
            subtitleP.textContent = activity.noWork && !activity.narrative ? 'No work performed' : (activity.narrative ? 'Work logged' : 'Tap to add work');
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function getWorkSummaryPreview() {
            if (!report || !report.activities || !projectContractors.length) {
                return 'Tap to add';
            }

            const withWork = report.activities.filter(a => !a.noWork || a.narrative);
            const noWork = report.activities.filter(a => a.noWork && !a.narrative);

            if (withWork.length === 0) {
                return noWork.length > 0 ? `${noWork.length} contractors - no work` : 'Tap to add';
            }

            return `${withWork.length} working, ${noWork.length} idle`;
        }

        // ============ PERSONNEL / OPERATIONS ============
        function getTradeAbbreviation(trades) {
            if (!trades) return '';
            // Common trade abbreviations
            const abbreviations = {
                'pile driving': 'PLE',
                'piling': 'PLE',
                'concrete': 'CONC',
                'concrete pvmt': 'CONC',
                'asphalt': 'ASP',
                'utilities': 'UTL',
                'earthwork': 'ERTHWRK',
                'grading': 'GRAD',
                'demolition': 'DEMO',
                'demo': 'DEMO',
                'electrical': 'ELEC',
                'plumbing': 'PLMB',
                'mechanical': 'MECH',
                'structural': 'STRUC',
                'steel': 'STL',
                'masonry': 'MASN',
                'roofing': 'ROOF',
                'painting': 'PAINT',
                'landscaping': 'LNDSCP',
                'survey': 'SURV',
                'surveying': 'SURV',
                'traffic': 'TRAF',
                'signage': 'SIGN',
                'drainage': 'DRAIN',
                'cm/pm': 'CM/PM',
                'general': 'GEN'
            };

            // Split by semicolon and abbreviate each trade
            return trades.split(';').map(trade => {
                const trimmed = trade.trim().toLowerCase();
                // Check if we have a known abbreviation
                for (const [key, abbr] of Object.entries(abbreviations)) {
                    if (trimmed.includes(key)) {
                        return abbr;
                    }
                }
                // If no match, use first 4 chars uppercase
                return trimmed.substring(0, 4).toUpperCase();
            }).join('; ');
        }

        function getContractorOperations(contractorId) {
            if (!report || !report.operations) return null;
            return report.operations.find(o => o.contractorId === contractorId);
        }

        function initializeOperations() {
            if (!report.operations) report.operations = [];

            // Ensure each contractor has an operations entry
            projectContractors.forEach(contractor => {
                const existing = report.operations.find(o => o.contractorId === contractor.id);
                if (!existing) {
                    report.operations.push({
                        contractorId: contractor.id,
                        superintendents: null,
                        foremen: null,
                        operators: null,
                        laborers: null,
                        surveyors: null,
                        others: null
                    });
                }
            });
        }

        function renderPersonnelCards() {
            const container = document.getElementById('personnel-list');
            const warningEl = document.getElementById('no-project-warning-ops');
            const totalsEl = document.getElementById('personnel-totals');

            if (!activeProject || projectContractors.length === 0) {
                warningEl.classList.remove('hidden');
                totalsEl.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            warningEl.classList.add('hidden');
            totalsEl.classList.remove('hidden');
            initializeOperations();

            container.innerHTML = projectContractors.map((contractor) => {
                const ops = getContractorOperations(contractor.id) || {
                    superintendents: null, foremen: null, operators: null,
                    laborers: null, surveyors: null, others: null
                };
                const typeLabel = contractor.type === 'prime' ? 'PRIME' : 'SUB';
                const borderColor = contractor.type === 'prime' ? 'border-l-safety-green' : 'border-l-dot-blue';
                const headerBg = contractor.type === 'prime' ? 'bg-safety-green/10' : 'bg-dot-blue/10';
                const titleColor = contractor.type === 'prime' ? 'text-safety-green' : 'text-dot-blue';

                // Check if contractor has any personnel data
                const hasData = (ops.superintendents > 0) || (ops.foremen > 0) || (ops.operators > 0) ||
                               (ops.laborers > 0) || (ops.surveyors > 0) || (ops.others > 0);
                const totalPersonnel = (ops.superintendents || 0) + (ops.foremen || 0) + (ops.operators || 0) +
                                      (ops.laborers || 0) + (ops.surveyors || 0) + (ops.others || 0);
                const summaryText = hasData ? `${totalPersonnel} personnel` : 'Tap to add';

                return `
                    <div class="personnel-card bg-white border-2 ${hasData ? borderColor.replace('border-l-', 'border-') : 'border-slate-200'} ${borderColor} border-l-4" data-ops-contractor-id="${contractor.id}">
                        <!-- Card Header - Tap to expand -->
                        <button onclick="togglePersonnelCard('${contractor.id}')" class="w-full p-3 flex items-center gap-3 text-left ${hasData ? headerBg : 'bg-slate-50'}">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg font-bold ${hasData ? titleColor : 'text-slate-600'}">${escapeHtml(contractor.abbreviation)}</span>
                                    <span class="text-[10px] font-medium text-slate-400 uppercase">${typeLabel}</span>
                                </div>
                                <p class="text-xs text-slate-500 truncate">${escapeHtml(contractor.name)}${contractor.trades ? ' • ' + escapeHtml(contractor.trades) : ''}</p>
                                <p class="text-[10px] ${hasData ? titleColor : 'text-slate-400'} mt-1">${summaryText}</p>
                            </div>
                            <i id="personnel-chevron-${contractor.id}" class="fas fa-chevron-down personnel-card-chevron text-slate-400 text-xs"></i>
                        </button>

                        <!-- Expandable Content -->
                        <div class="personnel-card-content">
                            <div class="p-3 border-t border-slate-200 bg-slate-50/50">
                                <!-- 2-column, 3-row grid for role inputs -->
                                <div class="grid grid-cols-2 gap-3">
                                    <!-- Row 1: Superintendent, Foreman -->
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Superintendent</label>
                                        <input type="number" min="0" max="99"
                                            id="ops-supt-${contractor.id}"
                                            value="${ops.superintendents || ''}"
                                            onchange="updateOperations('${contractor.id}')"
                                            class="w-full h-10 text-center text-base font-medium border-2 border-slate-300 focus:border-dot-blue focus:outline-none bg-white"
                                            placeholder="0">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Foreman</label>
                                        <input type="number" min="0" max="99"
                                            id="ops-frmn-${contractor.id}"
                                            value="${ops.foremen || ''}"
                                            onchange="updateOperations('${contractor.id}')"
                                            class="w-full h-10 text-center text-base font-medium border-2 border-slate-300 focus:border-dot-blue focus:outline-none bg-white"
                                            placeholder="0">
                                    </div>
                                    <!-- Row 2: Operator, Laborer -->
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Operator</label>
                                        <input type="number" min="0" max="99"
                                            id="ops-oper-${contractor.id}"
                                            value="${ops.operators || ''}"
                                            onchange="updateOperations('${contractor.id}')"
                                            class="w-full h-10 text-center text-base font-medium border-2 border-slate-300 focus:border-dot-blue focus:outline-none bg-white"
                                            placeholder="0">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Laborer</label>
                                        <input type="number" min="0" max="99"
                                            id="ops-labr-${contractor.id}"
                                            value="${ops.laborers || ''}"
                                            onchange="updateOperations('${contractor.id}')"
                                            class="w-full h-10 text-center text-base font-medium border-2 border-slate-300 focus:border-dot-blue focus:outline-none bg-white"
                                            placeholder="0">
                                    </div>
                                    <!-- Row 3: Surveyor, Other -->
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Surveyor</label>
                                        <input type="number" min="0" max="99"
                                            id="ops-surv-${contractor.id}"
                                            value="${ops.surveyors || ''}"
                                            onchange="updateOperations('${contractor.id}')"
                                            class="w-full h-10 text-center text-base font-medium border-2 border-slate-300 focus:border-dot-blue focus:outline-none bg-white"
                                            placeholder="0">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Other</label>
                                        <input type="number" min="0" max="99"
                                            id="ops-othr-${contractor.id}"
                                            value="${ops.others || ''}"
                                            onchange="updateOperations('${contractor.id}')"
                                            class="w-full h-10 text-center text-base font-medium border-2 border-slate-300 focus:border-dot-blue focus:outline-none bg-white"
                                            placeholder="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updatePersonnelTotals();
        }

        function togglePersonnelCard(contractorId) {
            const card = document.querySelector(`[data-ops-contractor-id="${contractorId}"]`);
            if (!card) return;

            card.classList.toggle('expanded');
        }

        function updateOperations(contractorId) {
            const ops = report.operations.find(o => o.contractorId === contractorId);
            if (!ops) return;

            const getValue = (id) => {
                const input = document.getElementById(id);
                if (!input) return null;
                const val = parseInt(input.value);
                return isNaN(val) ? null : val;
            };

            ops.superintendents = getValue(`ops-supt-${contractorId}`);
            ops.foremen = getValue(`ops-frmn-${contractorId}`);
            ops.operators = getValue(`ops-oper-${contractorId}`);
            ops.laborers = getValue(`ops-labr-${contractorId}`);
            ops.surveyors = getValue(`ops-surv-${contractorId}`);
            ops.others = getValue(`ops-othr-${contractorId}`);

            saveReport();
            updatePersonnelTotals();
            updatePersonnelCardStyle(contractorId);
            updateAllPreviews();
        }

        function updatePersonnelCardStyle(contractorId) {
            const ops = report.operations.find(o => o.contractorId === contractorId);
            const contractor = projectContractors.find(c => c.id === contractorId);
            if (!ops || !contractor) return;

            const card = document.querySelector(`[data-ops-contractor-id="${contractorId}"]`);
            if (!card) return;

            const hasData = (ops.superintendents > 0) || (ops.foremen > 0) || (ops.operators > 0) ||
                           (ops.laborers > 0) || (ops.surveyors > 0) || (ops.others > 0);
            const totalPersonnel = (ops.superintendents || 0) + (ops.foremen || 0) + (ops.operators || 0) +
                                  (ops.laborers || 0) + (ops.surveyors || 0) + (ops.others || 0);

            const borderColor = contractor.type === 'prime' ? 'border-safety-green' : 'border-dot-blue';
            const headerBg = contractor.type === 'prime' ? 'bg-safety-green/10' : 'bg-dot-blue/10';
            const titleColor = contractor.type === 'prime' ? 'text-safety-green' : 'text-dot-blue';

            // Update card border
            card.classList.remove('border-slate-200', 'border-safety-green', 'border-dot-blue');
            card.classList.add(hasData ? borderColor : 'border-slate-200');

            // Update header
            const header = card.querySelector('button');
            header.classList.remove('bg-slate-50', 'bg-safety-green/10', 'bg-dot-blue/10');
            header.classList.add(hasData ? headerBg : 'bg-slate-50');

            // Update abbreviation color
            const abbr = header.querySelector('span.text-lg');
            if (abbr) {
                abbr.classList.remove('text-slate-600', 'text-safety-green', 'text-dot-blue');
                abbr.classList.add(hasData ? titleColor : 'text-slate-600');
            }

            // Update summary text
            const summaryP = header.querySelector('p.text-\\[10px\\]');
            if (summaryP) {
                summaryP.textContent = hasData ? `${totalPersonnel} personnel` : 'Tap to add';
                summaryP.classList.remove('text-slate-400', 'text-safety-green', 'text-dot-blue');
                summaryP.classList.add(hasData ? titleColor : 'text-slate-400');
            }
        }

        function updatePersonnelTotals() {
            if (!report || !report.operations) return;

            let totals = {
                superintendents: 0,
                foremen: 0,
                operators: 0,
                laborers: 0,
                surveyors: 0,
                others: 0
            };

            report.operations.forEach(ops => {
                totals.superintendents += ops.superintendents || 0;
                totals.foremen += ops.foremen || 0;
                totals.operators += ops.operators || 0;
                totals.laborers += ops.laborers || 0;
                totals.surveyors += ops.surveyors || 0;
                totals.others += ops.others || 0;
            });

            const grandTotal = totals.superintendents + totals.foremen + totals.operators +
                              totals.laborers + totals.surveyors + totals.others;

            document.getElementById('total-supt').textContent = totals.superintendents || '-';
            document.getElementById('total-frmn').textContent = totals.foremen || '-';
            document.getElementById('total-oper').textContent = totals.operators || '-';
            document.getElementById('total-labr').textContent = totals.laborers || '-';
            document.getElementById('total-surv').textContent = totals.surveyors || '-';
            document.getElementById('total-othr').textContent = totals.others || '-';

            const grandTotalEl = document.getElementById('total-personnel');
            if (grandTotalEl) {
                grandTotalEl.textContent = grandTotal || '-';
            }
        }

        function getOperationsPreview() {
            if (!report || !report.operations || !projectContractors.length) {
                return 'Tap to add';
            }

            let totalPersonnel = 0;
            let contractorsWithPersonnel = 0;

            report.operations.forEach(ops => {
                const count = (ops.superintendents || 0) + (ops.foremen || 0) +
                              (ops.operators || 0) + (ops.laborers || 0) +
                              (ops.surveyors || 0) + (ops.others || 0);
                totalPersonnel += count;
                if (count > 0) contractorsWithPersonnel++;
            });

            if (totalPersonnel === 0) {
                return 'Tap to add';
            }

            return `${totalPersonnel} personnel from ${contractorsWithPersonnel} contractor${contractorsWithPersonnel !== 1 ? 's' : ''}`;
        }

        function hasOperationsData() {
            if (!report || !report.operations) return false;
            return report.operations.some(ops =>
                (ops.superintendents !== null && ops.superintendents > 0) ||
                (ops.foremen !== null && ops.foremen > 0) ||
                (ops.operators !== null && ops.operators > 0) ||
                (ops.laborers !== null && ops.laborers > 0) ||
                (ops.surveyors !== null && ops.surveyors > 0) ||
                (ops.others !== null && ops.others > 0)
            );
        }

        // ============ EQUIPMENT ============
        function getProjectEquipment() {
            if (!activeProject || !activeProject.equipment) return [];
            return activeProject.equipment;
        }

        function getEquipmentEntry(equipmentId) {
            if (!report || !report.equipment) return null;
            return report.equipment.find(e => e.equipmentId === equipmentId);
        }

        function initializeEquipment() {
            if (!report.equipment) report.equipment = [];

            const projectEquipment = getProjectEquipment();

            // Ensure each equipment item from project config has an entry
            projectEquipment.forEach(equip => {
                const existing = report.equipment.find(e => e.equipmentId === equip.id);
                if (!existing) {
                    report.equipment.push({
                        equipmentId: equip.id,
                        contractorId: equip.contractorId,
                        hoursUtilized: null,  // null means IDLE
                        quantity: equip.quantity || 1
                    });
                } else if (existing.quantity === undefined) {
                    // Migrate existing entries to include quantity
                    existing.quantity = equip.quantity || 1;
                }
            });

            // Clean up equipment entries for items no longer in project config
            report.equipment = report.equipment.filter(e =>
                projectEquipment.some(pe => pe.id === e.equipmentId)
            );
        }

        function renderEquipmentCards() {
            const container = document.getElementById('equipment-list');
            const warningEl = document.getElementById('no-project-warning-equip');
            const noEquipWarningEl = document.getElementById('no-equipment-warning');
            const totalsEl = document.getElementById('equipment-totals');
            const markAllBtn = document.getElementById('mark-all-idle-btn');

            if (!activeProject) {
                warningEl.classList.remove('hidden');
                noEquipWarningEl.classList.add('hidden');
                totalsEl.classList.add('hidden');
                markAllBtn.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            warningEl.classList.add('hidden');

            const projectEquipment = getProjectEquipment();

            if (projectEquipment.length === 0) {
                noEquipWarningEl.classList.remove('hidden');
                totalsEl.classList.add('hidden');
                markAllBtn.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            noEquipWarningEl.classList.add('hidden');
            totalsEl.classList.remove('hidden');
            markAllBtn.classList.remove('hidden');
            initializeEquipment();

            // Group equipment by contractor
            const grouped = {};
            projectContractors.forEach(c => {
                grouped[c.id] = {
                    contractor: c,
                    equipment: []
                };
            });

            projectEquipment.forEach(equip => {
                if (grouped[equip.contractorId]) {
                    grouped[equip.contractorId].equipment.push(equip);
                }
            });

            // Generate status options HTML
            const statusOptions = `
                <option value="">IDLE</option>
                <option value="1">1 HR</option>
                <option value="2">2 HRS</option>
                <option value="3">3 HRS</option>
                <option value="4">4 HRS</option>
                <option value="5">5 HRS</option>
                <option value="6">6 HRS</option>
                <option value="7">7 HRS</option>
                <option value="8">8 HRS</option>
                <option value="9">9 HRS</option>
                <option value="10">10 HRS</option>
            `;

            let html = '';

            Object.values(grouped).forEach(group => {
                const contractor = group.contractor;
                const borderColor = contractor.type === 'prime' ? 'border-l-safety-green' : 'border-l-dot-blue';
                const headerBg = contractor.type === 'prime' ? 'bg-safety-green/10' : 'bg-dot-blue/10';
                const titleColor = contractor.type === 'prime' ? 'text-safety-green' : 'text-dot-blue';

                // Contractor group container
                html += `<div class="equipment-group border-2 border-slate-200 ${borderColor} border-l-4 overflow-hidden">`;

                // Contractor header
                html += `
                    <div class="${headerBg} p-3 border-b border-slate-200">
                        <div class="flex items-center gap-2">
                            <span class="text-base font-bold ${titleColor}">${escapeHtml(contractor.abbreviation)}</span>
                            <span class="text-xs text-slate-500">${escapeHtml(contractor.name)}</span>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-0.5">${group.equipment.length} equipment item${group.equipment.length !== 1 ? 's' : ''}</p>
                    </div>
                `;

                // Check if contractor has equipment
                if (group.equipment.length === 0) {
                    html += `
                        <div class="p-4 text-center bg-slate-50">
                            <i class="fas fa-truck text-slate-300 text-xl mb-2"></i>
                            <p class="text-xs text-slate-400">No equipment for this contractor</p>
                        </div>
                    `;
                } else {
                    // Equipment rows header
                    html += `
                        <div class="bg-slate-100 px-3 py-1.5 border-b border-slate-200">
                            <div class="grid grid-cols-12 gap-2 text-[10px] font-bold text-slate-500 uppercase">
                                <div class="col-span-6">Type / Model</div>
                                <div class="col-span-2 text-center">Qty</div>
                                <div class="col-span-4 text-center">Status</div>
                            </div>
                        </div>
                    `;

                    // Equipment rows for this contractor
                    group.equipment.forEach((equip, index) => {
                        const entry = getEquipmentEntry(equip.id) || { hoursUtilized: null, quantity: equip.quantity || 1 };
                        const typeModel = equip.model ? `${equip.type} / ${equip.model}` : (equip.type || 'N/A');
                        const isActive = entry.hoursUtilized !== null && entry.hoursUtilized > 0;
                        const quantity = entry.quantity || equip.quantity || 1;
                        const isLast = index === group.equipment.length - 1;

                        html += `
                            <div class="bg-white px-3 py-2 ${!isLast ? 'border-b border-slate-100' : ''}" data-equip-id="${equip.id}">
                                <div class="grid grid-cols-12 gap-2 items-center">
                                    <!-- Type / Model (more space now) -->
                                    <div class="col-span-6 min-w-0">
                                        <p class="text-sm text-slate-700 leading-tight" title="${escapeHtml(typeModel)}">${escapeHtml(typeModel)}</p>
                                    </div>
                                    <!-- Quantity input -->
                                    <div class="col-span-2">
                                        <input type="number" min="1" max="99"
                                            id="equip-qty-${equip.id}"
                                            value="${quantity}"
                                            onchange="updateEquipmentQuantity('${equip.id}')"
                                            class="w-full h-8 text-center text-sm font-medium border border-slate-300 focus:border-dot-blue focus:outline-none bg-white">
                                    </div>
                                    <!-- Status Picker -->
                                    <div class="col-span-4">
                                        <select
                                            id="equip-status-${equip.id}"
                                            onchange="updateEquipmentStatus('${equip.id}')"
                                            class="w-full h-8 text-xs border ${isActive ? 'border-safety-green bg-safety-green/10 font-medium' : 'border-slate-300 bg-white'} focus:border-dot-blue focus:outline-none px-1">
                                            ${statusOptions.replace(`value="${entry.hoursUtilized || ''}"`, `value="${entry.hoursUtilized || ''}" selected`)}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                html += `</div>`; // Close equipment-group
            });

            container.innerHTML = html;
            updateEquipmentTotals();
        }

        function updateEquipmentQuantity(equipmentId) {
            const entry = report.equipment.find(e => e.equipmentId === equipmentId);
            if (!entry) return;

            const input = document.getElementById(`equip-qty-${equipmentId}`);
            if (!input) return;

            const val = parseInt(input.value);
            entry.quantity = isNaN(val) || val < 1 ? 1 : val;

            saveReport();
            updateEquipmentTotals();
            updateAllPreviews();
        }

        function updateEquipmentStatus(equipmentId) {
            const entry = report.equipment.find(e => e.equipmentId === equipmentId);
            if (!entry) return;

            const select = document.getElementById(`equip-status-${equipmentId}`);
            if (!select) return;

            const val = select.value;
            entry.hoursUtilized = val === '' ? null : parseInt(val);

            // Update visual style
            const isActive = entry.hoursUtilized !== null && entry.hoursUtilized > 0;
            select.className = `w-full h-8 text-xs border ${isActive ? 'border-safety-green bg-safety-green/10 font-medium' : 'border-slate-300 bg-white'} focus:border-dot-blue focus:outline-none px-1`;

            saveReport();
            updateEquipmentTotals();
            updateAllPreviews();
        }

        function markAllEquipmentIdle() {
            if (!report || !report.equipment) return;

            report.equipment.forEach(entry => {
                entry.hoursUtilized = null;
            });

            saveReport();
            renderEquipmentCards();
            updateAllPreviews();
            showToast('All equipment marked IDLE');
        }

        function updateEquipmentTotals() {
            if (!report || !report.equipment) return;

            const total = report.equipment.length;
            const active = report.equipment.filter(e => e.hoursUtilized !== null && e.hoursUtilized > 0).length;
            const idle = total - active;

            document.getElementById('equipment-total-count').textContent = total;
            document.getElementById('equipment-active-count').textContent = active;
            document.getElementById('equipment-idle-count').textContent = idle;
        }

        function getEquipmentPreview() {
            if (!activeProject) {
                return 'Tap to add';
            }

            const projectEquipment = getProjectEquipment();
            if (projectEquipment.length === 0) {
                return 'No equipment configured';
            }

            if (!report || !report.equipment) {
                return 'Tap to add';
            }

            const total = report.equipment.length;
            const active = report.equipment.filter(e => e.hoursUtilized !== null && e.hoursUtilized > 0).length;
            const idle = total - active;

            if (active === 0) {
                return `${total} equipment - all IDLE`;
            }

            return `${active} active, ${idle} idle`;
        }

        function hasEquipmentData() {
            if (!activeProject) return false;
            const projectEquipment = getProjectEquipment();
            if (projectEquipment.length === 0) return false;

            // Consider complete if we have equipment initialized (even if all IDLE)
            return report && report.equipment && report.equipment.length > 0;
        }

        // ============ STORAGE ============
        /**
         * Generate a report storage key
         * @param {string|null} projectId - Project ID (null for legacy fallback)
         * @param {string|null} dateStr - Date string YYYY-MM-DD (null for today)
         * @returns {string} Storage key
         */
        function getReportKey(projectId, dateStr) {
            const date = dateStr || new Date().toISOString().split('T')[0];
            return projectId
                ? `fieldvoice_report_${projectId}_${date}`
                : `fieldvoice_report_${date}`; // fallback for legacy
        }

        function getTodayKey() {
            return getReportKey(activeProject?.id, null);
        }

        function getReport() {
            const todayStr = new Date().toISOString().split('T')[0];

            // First try project-specific key (new format)
            if (activeProject) {
                const projectKey = getReportKey(activeProject.id, todayStr);
                const saved = localStorage.getItem(projectKey);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);

                        // If report was already submitted, archive it and start fresh
                        if (parsed.meta && parsed.meta.submitted === true) {
                            const archiveKey = `${projectKey}_submitted_${Date.now()}`;
                            localStorage.setItem(archiveKey, saved);
                            localStorage.removeItem(projectKey);
                            return createFreshReport();
                        }

                        return migrateReportFields(parsed);
                    } catch (e) {}
                }
            }

            // Fallback to legacy key (date-only, for backwards compatibility)
            const legacyKey = getReportKey(null, todayStr);
            const legacySaved = localStorage.getItem(legacyKey);
            if (legacySaved) {
                try {
                    const parsed = JSON.parse(legacySaved);

                    if (parsed.meta && parsed.meta.submitted === true) {
                        const archiveKey = `${legacyKey}_submitted_${Date.now()}`;
                        localStorage.setItem(archiveKey, legacySaved);
                        localStorage.removeItem(legacyKey);
                        localStorage.removeItem('fieldvoice_report');
                        return createFreshReport();
                    }

                    return migrateReportFields(parsed);
                } catch (e) {}
            }

            return createFreshReport();
        }

        function migrateReportFields(parsed) {
            if (!parsed.meta) parsed.meta = {};
            if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
            if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
            // Ensure new fields exist for legacy reports
            if (!parsed.reporter) parsed.reporter = { name: "" };
            if (!parsed.project) parsed.project = { name: "", dayNumber: null };
            if (parsed.additionalNotes === undefined) parsed.additionalNotes = "";
            // Migrate contractorCommunications (new field)
            if (parsed.contractorCommunications === undefined) parsed.contractorCommunications = "";
            // Migrate visitorsRemarks from array to string format
            if (Array.isArray(parsed.visitorsRemarks)) {
                parsed.visitorsRemarks = parsed.visitorsRemarks.join('\n');
            }
            if (parsed.visitorsRemarks === undefined) parsed.visitorsRemarks = "";
            // Migrate captureMode field (default to 'guided' for existing reports with data)
            if (parsed.meta.captureMode === undefined) {
                // If report has any guided section data, assume it's guided mode
                const hasGuidedData = parsed.activities?.length > 0 ||
                    parsed.generalIssues?.length > 0 ||
                    parsed.qaqcNotes?.length > 0 ||
                    parsed.safety?.notes?.length > 0;
                parsed.meta.captureMode = hasGuidedData ? 'guided' : null;
            }
            // Migrate fieldNotes structure
            if (!parsed.fieldNotes) parsed.fieldNotes = { freeformNotes: "" };
            if (parsed.fieldNotes.freeformNotes === undefined) parsed.fieldNotes.freeformNotes = "";
            return parsed;
        }

        function createFreshReport() {
            return {
                meta: {
                    createdAt: new Date().toISOString(),
                    interviewCompleted: false,
                    version: 2,
                    naMarked: {},
                    captureMode: null // 'minimal' or 'guided' - null means mode not yet selected
                },
                reporter: {
                    name: ""
                },
                project: {
                    name: "",
                    dayNumber: null
                },
                overview: {
                    projectName: "",
                    date: new Date().toLocaleDateString(),
                    startTime: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                    weather: { highTemp: "--", lowTemp: "--", precipitation: "0.00\"", generalCondition: "Syncing...", jobSiteCondition: "", adverseConditions: "N/A" }
                },
                contractors: [], activities: [], operations: [], equipment: [], generalIssues: [], qaqcNotes: [],
                safety: { hasIncidents: false, noIncidents: false, notes: [] },
                contractorCommunications: "",
                visitorsRemarks: "",
                photos: [],
                additionalNotes: "",
                // Minimal mode fields
                fieldNotes: {
                    freeformNotes: ""
                }
            };
        }

        function saveReport() {
            try {
                const reportJson = JSON.stringify(report);
                const todayStr = new Date().toISOString().split('T')[0];

                // Save with project-specific key if we have an active project
                if (activeProject) {
                    const projectKey = getReportKey(activeProject.id, todayStr);
                    localStorage.setItem(projectKey, reportJson);
                } else {
                    // Fallback to legacy key if no active project
                    const legacyKey = getReportKey(null, todayStr);
                    localStorage.setItem(legacyKey, reportJson);
                }

                // Also save to very old legacy key for backwards compatibility
                localStorage.setItem('fieldvoice_report', reportJson);

                updateAllPreviews();
                updateProgress();
            } catch (err) {
                if (err.name === 'QuotaExceededError' || err.message.includes('quota')) {
                    console.error('[STORAGE] Quota exceeded! Report size:', JSON.stringify(report).length, 'bytes');
                    console.error('[STORAGE] Photos count:', report.photos.length);
                    showToast('Storage full! Remove some photos.', 'error');
                    // Try to save without the last photo
                    if (report.photos.length > 0) {
                        const removedPhoto = report.photos.pop();
                        console.warn('[STORAGE] Removed last photo to free space:', removedPhoto.id);
                        showToast('Last photo removed - storage full', 'warning');
                        saveReport(); // Retry
                    }
                } else {
                    console.error('[STORAGE] Save failed:', err);
                    showToast('Failed to save report', 'error');
                }
            }
        }

        // ============ IMAGE COMPRESSION ============
        async function compressImage(dataUrl, maxWidth = 1200, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    try {
                        // Calculate new dimensions
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        // Create canvas and draw resized image
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to compressed JPEG
                        const compressedUrl = canvas.toDataURL('image/jpeg', quality);

                        console.log(`[PHOTO] Compressed: ${Math.round(dataUrl.length/1024)}KB -> ${Math.round(compressedUrl.length/1024)}KB (${width}x${height})`);

                        resolve(compressedUrl);
                    } catch (err) {
                        reject(err);
                    }
                };
                img.onerror = () => reject(new Error('Failed to load image for compression'));
                img.src = dataUrl;
            });
        }

        function getStorageUsage() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
                }
            }
            return total;
        }

        // ============ WEATHER ============
        async function fetchWeather() {
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                });
                const { latitude, longitude } = position.coords;
                localStorage.setItem('fvp_loc_granted', 'true');
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto&temperature_unit=fahrenheit&precipitation_unit=inch`);
                const data = await response.json();
                const weatherCodes = { 0: 'Clear', 1: 'Mostly Clear', 2: 'Partly Cloudy', 3: 'Overcast', 45: 'Fog', 48: 'Fog', 51: 'Light Drizzle', 53: 'Drizzle', 55: 'Heavy Drizzle', 61: 'Light Rain', 63: 'Rain', 65: 'Heavy Rain', 80: 'Showers', 95: 'Thunderstorm' };
                const precip = data.daily.precipitation_sum[0];
                report.overview.weather = {
                    highTemp: `${Math.round(data.daily.temperature_2m_max[0])}°F`,
                    lowTemp: `${Math.round(data.daily.temperature_2m_min[0])}°F`,
                    precipitation: `${precip.toFixed(2)}"`,
                    generalCondition: weatherCodes[data.current_weather.weathercode] || 'Cloudy',
                    jobSiteCondition: report.overview.weather.jobSiteCondition || (precip > 0.1 ? 'Wet' : 'Dry'),
                    adverseConditions: precip > 0.25 ? 'Rain impact possible' : 'N/A'
                };
                saveReport();
                updateWeatherDisplay();
                updateMinimalWeatherDisplay(); // Also update minimal mode weather
            } catch (error) {
                console.error('Weather fetch failed:', error);
            }
        }

        function updateWeatherDisplay() {
            const w = report.overview.weather;
            const conditionEl = document.getElementById('weather-condition');
            const tempEl = document.getElementById('weather-temp');
            const precipEl = document.getElementById('weather-precip');
            const siteCondEl = document.getElementById('site-conditions-input');

            if (conditionEl) conditionEl.textContent = w.generalCondition;
            if (tempEl) tempEl.textContent = `${w.highTemp} / ${w.lowTemp}`;
            if (precipEl) precipEl.textContent = w.precipitation;
            if (siteCondEl) siteCondEl.value = w.jobSiteCondition || '';
        }

        // ============ SECTION TOGGLE ============
        function toggleSection(sectionId) {
            const cards = document.querySelectorAll('.section-card');
            cards.forEach(card => {
                if (card.dataset.section === sectionId) {
                    card.classList.toggle('expanded');
                    const icon = card.querySelector('[id$="-status"] i');
                    if (card.classList.contains('expanded')) {
                        icon.className = 'fas fa-chevron-up text-dot-blue text-xs';
                    } else {
                        icon.className = 'fas fa-chevron-down text-slate-400 text-xs';
                    }
                } else {
                    card.classList.remove('expanded');
                    const icon = card.querySelector('[id$="-status"] i');
                    if (icon) icon.className = 'fas fa-chevron-down text-slate-400 text-xs';
                }
            });
        }

        // ============ DICTATION HINT BANNER ============
        function dismissDictationHint() {
            localStorage.setItem('fvp_dictation_hint_dismissed', 'true');
            const banner = document.getElementById('dictationHintBanner');
            if (banner) banner.classList.add('hidden');
        }

        function checkDictationHintBanner() {
            const dismissed = localStorage.getItem('fvp_dictation_hint_dismissed') === 'true';
            const banner = document.getElementById('dictationHintBanner');
            if (banner && dismissed) {
                banner.classList.add('hidden');
            }
        }

        // ============ MANUAL ADD FUNCTIONS ============
        // Note: addActivity() is replaced by contractor-based work entry system
        // Legacy activities are migrated in initializeContractorActivities()

        function addIssue() {
            const input = document.getElementById('issue-input');
            const text = input.value.trim();
            if (text) { report.generalIssues.push(text); saveReport(); renderSection('issues'); input.value = ''; }
        }

        function removeIssue(index) { report.generalIssues.splice(index, 1); saveReport(); renderSection('issues'); }

        function addInspection() {
            const input = document.getElementById('inspection-input');
            const text = input.value.trim();
            if (text) { report.qaqcNotes.push(text); saveReport(); renderSection('inspections'); input.value = ''; }
        }

        function removeInspection(index) { report.qaqcNotes.splice(index, 1); saveReport(); renderSection('inspections'); }

        function addSafetyNote() {
            const input = document.getElementById('safety-input');
            const text = input.value.trim();
            if (text) { report.safety.notes.push(text); saveReport(); renderSection('safety'); input.value = ''; }
        }

        function removeSafetyNote(index) { report.safety.notes.splice(index, 1); saveReport(); renderSection('safety'); }

        // Note: addVisitor() and removeVisitor() are replaced by text area inputs
        // contractorCommunications and visitorsRemarks are now strings, not arrays

        // ============ PHOTOS ============
        async function handlePhotoInput(e) {
            console.log('[PHOTO] handlePhotoInput triggered');

            const files = e.target.files;
            if (!files || files.length === 0) {
                console.warn('[PHOTO] No files selected');
                showToast('No photo selected', 'warning');
                return;
            }

            console.log(`[PHOTO] Processing ${files.length} file(s)`);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log(`[PHOTO] File ${i + 1}: ${file.name}, type: ${file.type}, size: ${file.size} bytes`);

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    console.error(`[PHOTO] Invalid file type: ${file.type}`);
                    showToast(`Invalid file type: ${file.type}`, 'error');
                    continue;
                }

                // Validate file size (max 20MB)
                if (file.size > 20 * 1024 * 1024) {
                    console.error(`[PHOTO] File too large: ${file.size} bytes`);
                    showToast('Photo too large (max 20MB)', 'error');
                    continue;
                }

                // Show processing indicator
                showToast('Processing photo...', 'info');

                // Get GPS coordinates
                let gps = null;
                try {
                    console.log('[PHOTO] Requesting GPS coordinates...');
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            timeout: 10000,
                            enableHighAccuracy: true,
                            maximumAge: 60000
                        });
                    });
                    gps = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        accuracy: Math.round(pos.coords.accuracy)
                    };
                    console.log(`[PHOTO] GPS acquired: ${gps.lat.toFixed(6)}, ${gps.lng.toFixed(6)} (±${gps.accuracy}m)`);
                } catch (err) {
                    console.warn('[PHOTO] GPS failed:', err.code, err.message);
                    // Continue without GPS - don't block the photo
                }

                // Read file as data URL
                try {
                    const rawDataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            console.log(`[PHOTO] FileReader success, raw size: ${Math.round(ev.target.result.length/1024)}KB`);
                            resolve(ev.target.result);
                        };
                        reader.onerror = (err) => {
                            console.error('[PHOTO] FileReader error:', err);
                            reject(new Error('Failed to read photo file'));
                        };
                        reader.onabort = () => {
                            console.error('[PHOTO] FileReader aborted');
                            reject(new Error('Photo read was aborted'));
                        };
                        reader.readAsDataURL(file);
                    });

                    // Compress image to reduce storage size (max 1200px width, 70% quality)
                    console.log('[PHOTO] Compressing image...');
                    showToast('Compressing photo...', 'info');
                    let dataUrl = await compressImage(rawDataUrl, 1200, 0.7);

                    // Check storage before saving
                    const storageUsed = getStorageUsage();
                    let photoSize = dataUrl.length * 2;
                    console.log(`[PHOTO] Storage: ${Math.round(storageUsed/1024/1024*10)/10}MB used, photo: ${Math.round(photoSize/1024)}KB`);

                    // If storage is getting full, try more aggressive compression
                    if (storageUsed + photoSize > 4.5 * 1024 * 1024) {
                        console.warn('[PHOTO] Storage nearly full, trying higher compression...');
                        showToast('Storage low, compressing more...', 'warning');
                        dataUrl = await compressImage(rawDataUrl, 800, 0.5);
                        photoSize = dataUrl.length * 2;
                        console.log(`[PHOTO] Re-compressed to: ${Math.round(photoSize/1024)}KB`);

                        if (storageUsed + photoSize > 4.8 * 1024 * 1024) {
                            throw new Error('Storage full - remove old photos first');
                        }
                    }

                    // Create timestamp
                    const now = new Date();
                    const timestamp = now.toISOString();
                    const date = now.toLocaleDateString();
                    const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit' });

                    // Create photo object
                    const photoObj = {
                        id: `photo_${Date.now()}_${i}`,
                        url: dataUrl,
                        caption: '',
                        timestamp: timestamp,
                        date: date,
                        time: time,
                        gps: gps,
                        fileName: file.name,
                        fileSize: file.size,
                        fileType: file.type
                    };

                    console.log('[PHOTO] Adding photo to report:', {
                        id: photoObj.id,
                        timestamp: photoObj.timestamp,
                        gps: photoObj.gps,
                        dataLength: dataUrl.length
                    });

                    report.photos.push(photoObj);
                    saveReport();
                    renderSection('photos');
                    showToast('Photo added', 'success');

                    console.log(`[PHOTO] Success! Total photos: ${report.photos.length}`);

                } catch (err) {
                    console.error('[PHOTO] Failed to process photo:', err);
                    showToast(`Photo error: ${err.message}`, 'error');
                }
            }

            // Reset the input so the same file can be selected again
            e.target.value = '';
        }

        function removePhoto(index) {
            console.log(`[PHOTO] Removing photo at index ${index}`);
            report.photos.splice(index, 1);
            saveReport();
            renderSection('photos');
            showToast('Photo removed', 'info');
        }

        // Update photo caption and save to localStorage
        function updatePhotoCaption(index, value) {
            const maxLength = 500;
            const caption = value.slice(0, maxLength);
            if (report.photos[index]) {
                report.photos[index].caption = caption;
                saveReport();
                // Update character counter
                const counter = document.getElementById(`caption-counter-${index}`);
                if (counter) {
                    const len = caption.length;
                    if (len > 400) {
                        counter.textContent = `${len}/${maxLength}`;
                        counter.classList.remove('hidden');
                        counter.classList.toggle('warning', len <= 480);
                        counter.classList.toggle('limit', len > 480);
                    } else {
                        counter.classList.add('hidden');
                    }
                }
            }
        }

        // Auto-expand caption textarea
        function autoExpandCaption(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
        }

        // ============ RENDER SECTIONS ============
        function renderSection(section) {
            switch (section) {
                case 'activities':
                    // Contractor-based work cards are rendered by renderContractorWorkCards()
                    renderContractorWorkCards();
                    break;
                case 'operations':
                    // Personnel cards are rendered by renderPersonnelCards()
                    renderPersonnelCards();
                    break;
                case 'equipment':
                    // Equipment cards are rendered by renderEquipmentCards()
                    renderEquipmentCards();
                    break;
                case 'issues':
                    document.getElementById('issues-list').innerHTML = report.generalIssues.map((issue, i) => `
                        <div class="bg-red-50 border border-red-200 p-3 flex items-start gap-3">
                            <i class="fas fa-exclamation-circle text-red-500 mt-0.5"></i>
                            <p class="flex-1 text-sm text-slate-700">${issue}</p>
                            <button onclick="removeIssue(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `).join('') || '';
                    break;
                case 'inspections':
                    document.getElementById('inspections-list').innerHTML = report.qaqcNotes.map((note, i) => `
                        <div class="bg-violet-50 border border-violet-200 p-3 flex items-start gap-3">
                            <i class="fas fa-check-circle text-violet-500 mt-0.5"></i>
                            <p class="flex-1 text-sm text-slate-700">${note}</p>
                            <button onclick="removeInspection(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `).join('') || '';
                    break;
                case 'safety':
                    document.getElementById('safety-list').innerHTML = report.safety.notes.map((note, i) => `
                        <div class="bg-green-50 border border-green-200 p-3 flex items-start gap-3">
                            <i class="fas fa-shield-alt text-safety-green mt-0.5"></i>
                            <p class="flex-1 text-sm text-slate-700">${note}</p>
                            <button onclick="removeSafetyNote(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `).join('') || '';
                    document.getElementById('has-incidents').checked = report.safety.hasIncidents;
                    break;
                case 'communications':
                    // Communications text area - value set via event listener
                    break;
                case 'visitors':
                    // Visitors/remarks text area - value set via event listener
                    break;
                case 'photos':
                    document.getElementById('photos-grid').innerHTML = report.photos.map((p, i) => `
                        <div class="border-2 border-slate-300 overflow-hidden bg-slate-100">
                            <div class="relative">
                                <img src="${p.url}" class="w-full aspect-square object-cover" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23cbd5e1%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%2364748b%22 font-size=%2212%22>Error</text></svg>';">
                                <button onclick="removePhoto(${i})" class="absolute top-2 right-2 w-7 h-7 bg-red-600 text-white text-xs flex items-center justify-center shadow-lg"><i class="fas fa-times"></i></button>
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent p-2 pt-6">
                                    <div class="flex items-center gap-1 text-white/90 mb-1">
                                        <i class="fas fa-clock text-[8px]"></i>
                                        <p class="text-[10px] font-medium">${p.date} ${p.time}</p>
                                    </div>
                                    ${p.gps ? `
                                        <div class="flex items-center gap-1 text-safety-green">
                                            <i class="fas fa-map-marker-alt text-[8px]"></i>
                                            <p class="text-[9px] font-mono">${p.gps.lat.toFixed(5)}, ${p.gps.lng.toFixed(5)}</p>
                                            <span class="text-[8px] text-white/60">(±${p.gps.accuracy}m)</span>
                                        </div>
                                    ` : `
                                        <div class="flex items-center gap-1 text-dot-orange">
                                            <i class="fas fa-location-crosshairs text-[8px]"></i>
                                            <p class="text-[9px]">No GPS</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div class="p-2 bg-white">
                                <textarea
                                    id="caption-input-${i}"
                                    class="caption-textarea w-full text-xs border border-slate-200 rounded p-2 bg-slate-50 focus:bg-white focus:border-dot-blue focus:outline-none"
                                    placeholder="Add caption..."
                                    maxlength="500"
                                    oninput="updatePhotoCaption(${i}, this.value); autoExpandCaption(this);"
                                    onblur="updatePhotoCaption(${i}, this.value)"
                                >${p.caption || ''}</textarea>
                                <div id="caption-counter-${i}" class="caption-counter hidden mt-1"></div>
                            </div>
                        </div>
                    `).join('') || '<p class="col-span-2 text-center text-slate-400 text-sm py-4">No photos yet</p>';
                    break;
            }
        }

        function renderAllSections() {
            ['activities', 'operations', 'equipment', 'issues', 'inspections', 'safety', 'communications', 'visitors', 'photos'].forEach(renderSection);
            updateWeatherDisplay();
        }

        // ============ PREVIEWS & PROGRESS ============
        function updateAllPreviews() {
            // Reporter and Project sections
            document.getElementById('reporter-preview').textContent = report.reporter?.name ? report.reporter.name : 'Tap to add';
            document.getElementById('project-preview').textContent = report.project?.name ? `${report.project.name}${report.project.dayNumber ? ` - Day ${report.project.dayNumber}` : ''}` : 'Tap to add';

            const w = report.overview.weather;
            document.getElementById('weather-preview').textContent = w.jobSiteCondition || `${w.generalCondition}, ${w.highTemp}`;
            document.getElementById('activities-preview').textContent = getWorkSummaryPreview();
            document.getElementById('operations-preview').textContent = getOperationsPreview();
            document.getElementById('equipment-preview').textContent = getEquipmentPreview();
            const naMarked = report.meta.naMarked || {};
            document.getElementById('issues-preview').textContent = naMarked.issues ? 'N/A - No issues' : report.generalIssues.length > 0 ? `${report.generalIssues.length} issues` : 'None reported';
            document.getElementById('inspections-preview').textContent = naMarked.inspections ? 'N/A - No inspections' : report.qaqcNotes.length > 0 ? `${report.qaqcNotes.length} inspections` : 'None reported';
            document.getElementById('safety-preview').textContent = report.safety.hasIncidents ? 'INCIDENT REPORTED' : report.safety.noIncidents ? 'No incidents (confirmed)' : report.safety.notes.length > 0 ? 'Notes added' : 'Tap to confirm';
            document.getElementById('communications-preview').textContent = naMarked.communications ? 'N/A - None' : report.contractorCommunications ? 'Communications logged' : 'None reported';
            document.getElementById('visitors-preview').textContent = naMarked.visitors ? 'N/A - None' : report.visitorsRemarks ? 'Remarks logged' : 'None reported';
            document.getElementById('photos-preview').textContent = naMarked.photos ? 'N/A - No photos' : report.photos.length > 0 ? `${report.photos.length} photos` : 'No photos';
            document.getElementById('notes-preview').textContent = report.additionalNotes ? 'Notes added' : 'Optional';
            updateStatusIcons();
        }

        function updateStatusIcons() {
            const naMarked = report.meta.naMarked || {};
            const hasWorkLogged = report.activities && report.activities.some(a => !a.noWork || a.narrative);
            const allMarkedNoWork = report.activities && report.activities.length > 0 && report.activities.every(a => a.noWork);
            const sections = {
                'reporter': report.reporter?.name,
                'project': report.project?.name && report.project?.dayNumber,
                'weather': report.overview.weather.jobSiteCondition,
                'activities': hasWorkLogged || allMarkedNoWork,
                'operations': hasOperationsData(),
                'equipment': hasEquipmentData(),
                'issues': report.generalIssues.length > 0 || naMarked.issues,
                'inspections': report.qaqcNotes.length > 0 || naMarked.inspections,
                'safety': report.safety.noIncidents || report.safety.hasIncidents || report.safety.notes.length > 0,
                'communications': report.contractorCommunications || naMarked.communications,
                'visitors': report.visitorsRemarks || naMarked.visitors,
                'photos': report.photos.length > 0 || naMarked.photos,
                'notes': report.additionalNotes  // Optional - shows check when filled
            };
            Object.entries(sections).forEach(([section, hasData]) => {
                const statusEl = document.getElementById(`${section}-status`);
                if (!statusEl) return;
                const card = document.querySelector(`[data-section="${section}"]`);
                const isExpanded = card?.classList.contains('expanded');
                if (hasData && !isExpanded) {
                    statusEl.innerHTML = '<i class="fas fa-check text-safety-green text-xs"></i>';
                    statusEl.className = 'w-8 h-8 bg-safety-green/20 border-2 border-safety-green flex items-center justify-center';
                } else if (!isExpanded) {
                    statusEl.innerHTML = '<i class="fas fa-chevron-down text-slate-400 text-xs"></i>';
                    statusEl.className = 'w-8 h-8 border border-slate-300 flex items-center justify-center';
                }
            });
        }

        function updateProgress() {
            const naMarked = report.meta.naMarked || {};
            let filled = 0;
            let total = 12; // reporter, project, weather, activities, operations, equipment, issues, inspections, safety, communications, visitors, photos

            // Reporter - has name
            if (report.reporter?.name) filled++;

            // Project - has name AND day number
            if (report.project?.name && report.project?.dayNumber) filled++;

            // Weather - has site condition text
            if (report.overview.weather.jobSiteCondition) filled++;

            // Activities - has at least one contractor with work logged OR all marked no work
            const hasWorkLogged = report.activities && report.activities.some(a => !a.noWork || a.narrative);
            const allMarkedNoWork = report.activities && report.activities.length > 0 && report.activities.every(a => a.noWork);
            if (hasWorkLogged || allMarkedNoWork) filled++;

            // Operations - has personnel data entered
            if (hasOperationsData()) filled++;

            // Equipment - has equipment data (even if all IDLE)
            if (hasEquipmentData()) filled++;

            // Issues - has issues OR marked N/A
            if (report.generalIssues.length > 0 || naMarked.issues) filled++;

            // Inspections - has inspections OR marked N/A
            if (report.qaqcNotes.length > 0 || naMarked.inspections) filled++;

            // Safety - confirmed no incidents OR has incidents OR has notes
            if (report.safety.noIncidents === true || report.safety.hasIncidents === true || report.safety.notes.length > 0) filled++;

            // Communications - has communications OR marked N/A
            if (report.contractorCommunications || naMarked.communications) filled++;

            // Visitors/Remarks - has remarks OR marked N/A
            if (report.visitorsRemarks || naMarked.visitors) filled++;

            // Photos - has photos OR marked N/A
            if (report.photos.length > 0 || naMarked.photos) filled++;

            // Note: Additional Notes is optional and not included in progress

            const percent = Math.round((filled / total) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}%`;
        }

        // ============ N/A MARKING ============
        function markNA(section) {
            if (!report.meta.naMarked) report.meta.naMarked = {};
            report.meta.naMarked[section] = true;
            const btn = document.getElementById(`${section}-na-btn`);
            if (btn) {
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>Marked as N/A';
                btn.className = 'w-full p-3 bg-safety-green/20 border-2 border-safety-green text-safety-green text-sm font-medium uppercase cursor-default';
                btn.onclick = () => clearNA(section);
            }
            // Hide photo upload if photos section is marked N/A
            if (section === 'photos') {
                const uploadLabel = document.getElementById('photos-upload-label');
                if (uploadLabel) uploadLabel.classList.add('hidden');
            }
            saveReport();
            updateAllPreviews();
            showToast('Marked as N/A');
        }

        function clearNA(section) {
            if (report.meta.naMarked) { delete report.meta.naMarked[section]; }
            const btn = document.getElementById(`${section}-na-btn`);
            if (btn) {
                const labels = { issues: 'No Issues - Mark as N/A', inspections: 'No Inspections - Mark as N/A', communications: 'No Communications - Mark as N/A', visitors: 'Nothing to Report - Mark as N/A', photos: 'No Photos - Mark as N/A' };
                btn.innerHTML = `<i class="fas fa-ban mr-2"></i>${labels[section] || 'Mark as N/A'}`;
                btn.className = 'w-full p-3 bg-slate-100 border border-slate-300 text-slate-600 hover:bg-slate-200 transition-colors text-sm font-medium uppercase';
                btn.onclick = () => markNA(section);
            }
            // Show photo upload if photos section is cleared
            if (section === 'photos') {
                const uploadLabel = document.getElementById('photos-upload-label');
                if (uploadLabel) uploadLabel.classList.remove('hidden');
            }
            saveReport();
            updateAllPreviews();
            showToast('N/A cleared');
        }

        function updateNAButtons() {
            const naMarked = report.meta.naMarked || {};
            Object.keys(naMarked).forEach(section => {
                if (naMarked[section]) {
                    const btn = document.getElementById(`${section}-na-btn`);
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Marked as N/A';
                        btn.className = 'w-full p-3 bg-safety-green/20 border-2 border-safety-green text-safety-green text-sm font-medium uppercase cursor-default';
                        btn.onclick = () => clearNA(section);
                    }
                    // Hide photo upload if photos is marked N/A
                    if (section === 'photos') {
                        const uploadLabel = document.getElementById('photos-upload-label');
                        if (uploadLabel) uploadLabel.classList.add('hidden');
                    }
                }
            });
        }

        // ============ UTILITIES ============
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();
            const colors = { success: 'bg-safety-green', warning: 'bg-dot-orange', error: 'bg-red-600', info: 'bg-dot-blue' };
            const toast = document.createElement('div');
            toast.className = `toast-msg fixed bottom-24 left-1/2 -translate-x-1/2 ${colors[type] || colors.success} text-white px-6 py-3 font-bold text-sm shadow-lg z-50 flex items-center gap-2 uppercase`;
            toast.innerHTML = `<i class="fas fa-check"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function dismissWarningBanner() { document.getElementById('permissionsWarningBanner').classList.add('hidden'); }

        function checkAndShowWarningBanner() {
            const micGranted = localStorage.getItem('fvp_mic_granted') === 'true';
            const locGranted = localStorage.getItem('fvp_loc_granted') === 'true';
            if (isMobile && (!micGranted || !locGranted)) {
                document.getElementById('permissionsWarningBanner').classList.remove('hidden');
            }
        }

        // ============ PERMISSIONS ============
        async function requestMicrophonePermission() {
            const btn = document.getElementById('micPermissionBtn');
            const status = document.getElementById('micPermissionStatus');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            status.textContent = 'Testing...';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                localStorage.setItem('fvp_mic_granted', 'true');
                updatePermissionUI('mic', 'granted');
                showToast('Microphone enabled!', 'success');
            } catch (err) {
                console.error('Microphone permission error:', err);
                updatePermissionUI('mic', 'denied');
                status.textContent = 'Blocked - check settings';
            }
        }

        async function requestLocationPermission() {
            const btn = document.getElementById('locPermissionBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
                });
                localStorage.setItem('fvp_loc_granted', 'true');
                updatePermissionUI('loc', 'granted');
                showToast('Location enabled!');
                fetchWeather();
            } catch (err) {
                console.error('Location permission error:', err);
                if (err.code === 1) { updatePermissionUI('loc', 'denied'); }
            }
        }

        function updatePermissionUI(type, state) {
            const btn = document.getElementById(`${type}PermissionBtn`);
            const status = document.getElementById(`${type}PermissionStatus`);
            const row = document.getElementById(`${type}PermissionRow`);
            if (state === 'granted') {
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.className = 'px-4 py-2 bg-safety-green text-white text-xs font-bold cursor-default';
                btn.disabled = true;
                status.textContent = type === 'mic' ? 'Verified Working' : 'Enabled';
                status.className = 'text-xs text-safety-green';
                row.className = 'bg-safety-green/10 border-2 border-safety-green p-4';
            } else if (state === 'denied') {
                btn.textContent = 'Denied';
                btn.className = 'px-4 py-2 bg-red-500/50 text-white text-xs font-bold';
                btn.disabled = true;
                status.textContent = 'Blocked - check settings';
                status.className = 'text-xs text-red-500';
                row.className = 'bg-red-50 border-2 border-red-500 p-4';
            }
        }

        function closePermissionsModal() {
            document.getElementById('permissionsModal').classList.add('hidden');
            localStorage.setItem('permissions_dismissed', 'true');
        }

        function finishReport() {
            report.overview.endTime = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            report.meta.interviewCompleted = true;
            if (report.overview.startTime) {
                const start = new Date(`2000/01/01 ${report.overview.startTime}`);
                const end = new Date(`2000/01/01 ${report.overview.endTime}`);
                const diffMs = end - start;
                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const mins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                report.overview.shiftDuration = `${hours}.${String(mins).padStart(2, '0')} hours`;
            }
            if (report.safety.notes.length === 0) { report.safety.notes.push('No safety incidents reported.'); }
            saveReport();
            window.location.href = 'review.html';
        }

        // ============ EVENT LISTENERS ============
        // Reporter name input
        document.getElementById('reporter-name-input').addEventListener('change', (e) => {
            report.reporter.name = e.target.value.trim();
            // Also update completedBy for the report
            report.overview.completedBy = e.target.value.trim();
            saveReport();
        });

        // Project name input
        document.getElementById('project-name-input').addEventListener('change', (e) => {
            report.project.name = e.target.value.trim();
            // Also update projectName for legacy compatibility
            report.overview.projectName = e.target.value.trim();
            saveReport();
        });

        // Project day input
        document.getElementById('project-day-input').addEventListener('change', (e) => {
            report.project.dayNumber = e.target.value ? parseInt(e.target.value) : null;
            // Also update contractDayNo for legacy compatibility
            if (report.project.dayNumber) {
                report.overview.contractDayNo = `Day ${report.project.dayNumber}`;
            }
            saveReport();
        });

        document.getElementById('site-conditions-input').addEventListener('change', (e) => {
            report.overview.weather.jobSiteCondition = e.target.value;
            saveReport();
        });

        document.getElementById('no-incidents').addEventListener('change', (e) => {
            if (e.target.checked) { report.safety.hasIncidents = false; report.safety.noIncidents = true; document.getElementById('has-incidents').checked = false; }
            else { report.safety.noIncidents = false; }
            saveReport();
            updateAllPreviews();
        });

        document.getElementById('has-incidents').addEventListener('change', (e) => {
            report.safety.hasIncidents = e.target.checked;
            if (e.target.checked) { report.safety.noIncidents = false; document.getElementById('no-incidents').checked = false; }
            saveReport();
            updateAllPreviews();
        });

        // Additional notes input
        document.getElementById('additional-notes-input').addEventListener('change', (e) => {
            report.additionalNotes = e.target.value.trim();
            saveReport();
        });

        // Contractor communications input
        document.getElementById('contractor-communications-input').addEventListener('change', (e) => {
            report.contractorCommunications = e.target.value.trim();
            saveReport();
            updateAllPreviews();
        });

        // Visitors/remarks input
        document.getElementById('visitors-remarks-input').addEventListener('change', (e) => {
            report.visitorsRemarks = e.target.value.trim();
            saveReport();
            updateAllPreviews();
        });

        document.getElementById('photoInput').addEventListener('change', handlePhotoInput);

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', async () => {
            // Load active project and contractors first
            loadActiveProject();

            report = getReport();

            // If user came back to edit a "completed" report (from review.html), mark it as in-progress again
            // This ensures the dashboard shows "In Progress" instead of "Ready for Review" while editing
            if (report.meta?.interviewCompleted && !report.meta?.submitted) {
                report.meta.interviewCompleted = false;
                saveReport();
            }

            // Auto-populate project info from active project if not already set
            if (activeProject && !report.project?.name) {
                report.project.name = activeProject.name || '';
                report.overview.projectName = activeProject.name || '';
                saveReport();
            }

            // Check if we need to show mode selection or jump to a specific mode
            if (shouldShowModeSelection()) {
                showModeSelectionScreen();
                // Fetch weather in background for when user selects a mode
                if (report.overview.weather.generalCondition === 'Syncing...' || report.overview.weather.generalCondition === '--') {
                    fetchWeather();
                }
            } else {
                // Show the appropriate mode UI
                const mode = report.meta?.captureMode || 'guided';
                showModeUI(mode);

                // Fetch weather if needed
                if (report.overview.weather.generalCondition === 'Syncing...' || report.overview.weather.generalCondition === '--') {
                    await fetchWeather();
                    // Update weather display in minimal mode if active
                    if (mode === 'minimal') {
                        updateMinimalWeatherDisplay();
                    }
                }
            }

            checkAndShowWarningBanner();
            checkDictationHintBanner();
        });
    </script>

    <!-- PWA Navigation Fix - Prevent Safari from breaking out of standalone mode -->
    <script>
        (function() {
            // Only apply fix when running as installed PWA
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a');
                    if (link && link.href && link.href.startsWith(window.location.origin)) {
                        // Internal link - prevent default and use location.href
                        e.preventDefault();
                        window.location.href = link.href;
                    }
                }, true);
            }
        })();
    </script>

    <!-- PWA Service Worker Registration & Offline Banner -->
    <div id="offline-banner" class="fixed top-0 left-0 right-0 bg-yellow-500 text-yellow-900 text-center py-2 px-4 font-bold text-sm z-[9999] transform -translate-y-full transition-transform duration-300" style="display: none;">
        <i class="fas fa-wifi-slash mr-2"></i>You are offline - Some features may be unavailable
    </div>
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[PWA] New version available');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });
            });
        }

        // Offline/Online Event Handlers
        const offlineBanner = document.getElementById('offline-banner');

        function showOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.display = 'block';
                setTimeout(() => {
                    offlineBanner.style.transform = 'translateY(0)';
                }, 10);
            }
        }

        function hideOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.transform = 'translateY(-100%)';
                setTimeout(() => {
                    offlineBanner.style.display = 'none';
                }, 300);
            }
        }

        window.addEventListener('online', hideOfflineBanner);
        window.addEventListener('offline', showOfflineBanner);

        // Check initial state
        if (!navigator.onLine) {
            showOfflineBanner();
        }
    </script>
</body>
</html>
