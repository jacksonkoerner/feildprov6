<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RPR Daily Report - FieldVoice Pro</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
    <meta name="theme-color" content="#0a1628">

    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FieldVoice">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ============ BASE STYLES ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #000;
            background: #f0f0f0;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ============ SCREEN-ONLY HEADER ============ */
        .screen-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #0a1628;
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .screen-header h1 {
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .screen-header .header-date {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 2px;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            transition: background 0.2s;
        }

        .btn-home {
            background: transparent;
            color: #94a3b8;
            border: 1px solid #475569;
        }
        .btn-home:hover { background: #1e293b; color: white; }

        .btn-edit {
            background: #1e3a5f;
            color: white;
        }
        .btn-edit:hover { background: #2d4a6f; }

        .btn-submit {
            background: #16a34a;
            color: white;
        }
        .btn-submit:hover { background: #15803d; }

        /* ============ PAGE CONTAINER ============ */
        .page-container {
            max-width: 8.5in;
            margin: 20px auto;
            background: transparent;
            overflow-x: hidden;
        }

        .page {
            width: 100%;
            max-width: 8.5in;
            min-height: 11in;
            padding: 0.4in 0.5in;
            background: white;
            position: relative;
            box-sizing: border-box;
            overflow-x: hidden;
            margin-bottom: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .page:last-child {
            margin-bottom: 0;
        }

        .page-break {
            page-break-after: always;
            break-after: page;
        }

        /* Ensure all sections stay within page bounds */
        .section-header,
        .work-summary,
        .text-section,
        .photos-header-info,
        .photos-grid {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* ============ REPORT HEADER ============ */
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 3px solid #4a7c34;
        }

        .report-logo {
            max-height: 50px;
            max-width: 200px;
        }

        .report-logo-placeholder {
            font-size: 11px;
            font-weight: bold;
            color: #1e3a5f;
            text-transform: uppercase;
        }

        .report-title {
            font-size: 18pt;
            font-weight: bold;
            color: #4a7c34;
            text-align: right;
        }

        /* ============ SECTION HEADERS ============ */
        .section-header {
            background: #4a7c34;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 6px 10px;
            font-size: 10pt;
            text-transform: uppercase;
            margin-top: 12px;
            border: 1px solid #000;
            border-bottom: none;
        }

        .section-header:first-child {
            margin-top: 0;
        }

        /* ============ PROJECT OVERVIEW TABLE ============ */
        .overview-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .overview-table {
            width: 100%;
            min-width: 500px;
            border-collapse: collapse;
            font-size: 9pt;
            border: 1px solid #000;
            border-top: none;
        }

        .overview-table td {
            border: 1px solid #000;
            padding: 4px 8px;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .overview-table .label {
            font-weight: bold;
            background: #f5f5f5;
            white-space: nowrap;
        }

        .overview-table .value {
        }

        /* Weather sub-table */
        .weather-row td {
            padding: 2px 8px;
        }

        .weather-label {
            font-weight: bold;
            background: #f5f5f5;
            width: 140px;
        }

        .weather-sub {
            padding-left: 20px !important;
            background: #fafafa;
        }

        /* Signature area */
        .signature-cell {
            text-align: center;
            vertical-align: middle;
            height: 60px;
        }

        .signature-name {
            font-size: 16pt;
            font-family: 'Brush Script MT', cursive, Arial;
            color: #1e3a5f;
        }

        .signature-details {
            font-size: 7pt;
            color: #666;
            margin-top: 4px;
        }

        /* ============ DAILY WORK SUMMARY ============ */
        .work-summary {
            border: 1px solid #000;
            border-top: none;
            padding: 10px;
            font-size: 9pt;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .contractor-block {
            margin-bottom: 12px;
        }

        .contractor-block:last-child {
            margin-bottom: 0;
        }

        .contractor-name {
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .contractor-narrative {
            margin-bottom: 6px;
        }

        .contractor-details {
            font-size: 8pt;
            text-transform: uppercase;
        }

        /* ============ OPERATIONS TABLE ============ */
        .ops-table {
            width: 100%;
            min-width: 500px;
            border-collapse: collapse;
            font-size: 8pt;
            margin: 0;
            border: 1px solid #000;
            border-top: none;
        }

        .ops-table th {
            background: #f5f5f5;
            border: 1px solid #000;
            padding: 4px 3px;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            font-size: 6pt;
            white-space: nowrap;
        }

        .ops-table td {
            border: 1px solid #000;
            padding: 4px 3px;
            text-align: center;
            font-size: 8pt;
        }

        .ops-table td:first-child,
        .ops-table td:nth-child(2) {
            text-align: left;
        }

        /* ============ EQUIPMENT TABLE ============ */
        .equip-table {
            width: 100%;
            min-width: 500px;
            border-collapse: collapse;
            font-size: 8pt;
            margin: 0;
            border: 1px solid #000;
            border-top: none;
        }

        .equip-table th {
            background: #f5f5f5;
            border: 1px solid #000;
            padding: 4px 3px;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            font-size: 6pt;
        }

        .equip-table td {
            border: 1px solid #000;
            padding: 3px;
            text-align: center;
            font-size: 8pt;
            word-wrap: break-word;
        }

        .equip-table td:first-child,
        .equip-table td:nth-child(2) {
            text-align: left;
        }

        /* ============ TEXT SECTIONS ============ */
        .text-section {
            border: 1px solid #000;
            border-top: none;
            padding: 8px 10px;
            min-height: 40px;
            font-size: 9pt;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .text-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .text-section li {
            margin-bottom: 4px;
        }

        .text-section p {
            margin: 0;
        }

        .na-text {
            color: #666;
        }

        /* ============ SAFETY SECTION ============ */
        .safety-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .safety-checkboxes {
            display: flex;
            gap: 20px;
            font-size: 9pt;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .checkbox-box {
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .checkbox-box.checked {
            background: #000;
            color: white;
        }

        /* ============ PHOTOS SECTION ============ */
        .photos-header-info {
            border: 1px solid #000;
            border-bottom: none;
            padding: 6px 10px;
            font-size: 9pt;
        }

        .photos-header-info table {
            width: auto;
        }

        .photos-header-info td {
            padding: 2px 10px 2px 0;
        }

        .photos-header-info .photo-label {
            font-weight: bold;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border: 1px solid #000;
            border-top: none;
        }

        .photo-cell {
            border: 1px solid #ccc;
            padding: 8px;
            min-height: 280px;
        }

        .photo-cell:nth-child(odd) {
            border-right: 1px solid #000;
        }

        .photo-cell:nth-child(1),
        .photo-cell:nth-child(2) {
            border-top: 1px solid #000;
        }

        .photo-image {
            width: 100%;
            height: 200px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .photo-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .photo-image.empty {
            color: #999;
            font-size: 9pt;
        }

        .photo-meta {
            font-size: 8pt;
            margin-bottom: 4px;
        }

        .photo-meta span {
            font-weight: bold;
        }

        .photo-caption {
            font-size: 8pt;
            font-style: italic;
            color: #333;
        }

        /* ============ PAGE FOOTER ============ */
        .page-footer {
            position: absolute;
            bottom: 0.3in;
            left: 0.5in;
            right: 0.5in;
            text-align: center;
            font-size: 8pt;
            color: #666;
            border-top: 1px solid #ccc;
            padding-top: 4px;
        }

        /* ============ PRINT STYLES ============ */
        @media print {
            body {
                background: white;
                padding: 0;
                margin: 0;
            }

            .screen-header {
                display: none !important;
            }

            .page-container {
                max-width: none;
                margin: 0;
                box-shadow: none;
                background: white;
            }

            .page {
                width: 100%;
                min-height: auto;
                padding: 0.4in 0.5in;
                margin: 0;
                box-shadow: none;
                border-radius: 0;
            }

            .page-break {
                page-break-after: always;
                break-after: page;
            }

            .overview-wrapper {
                overflow: visible;
            }

            .section-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .overview-table .label,
            .ops-table th,
            .equip-table th {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .report-header {
                border-bottom-color: #4a7c34;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .report-title {
                color: #4a7c34;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            @page {
                size: letter;
                margin: 0;
            }
        }

        /* ============ RESPONSIVE (screen only) ============ */
        @media screen and (max-width: 900px) {
            body {
                background: #e5e5e5;
            }

            .page-container {
                margin: 0;
                max-width: 100%;
                overflow-x: visible;
                padding: 16px;
            }

            .page {
                width: 100%;
                min-width: 360px;
                padding: 12px;
                min-height: auto;
                margin-bottom: 30px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                border-radius: 4px;
            }

            .report-header {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .report-title {
                font-size: 14pt;
                text-align: center;
            }

            .section-header {
                font-size: 9pt;
                padding: 5px 8px;
            }

            .work-summary {
                padding: 8px;
                font-size: 8pt;
            }

            .text-section {
                padding: 6px 8px;
                font-size: 8pt;
            }

            .overview-table {
                font-size: 8pt;
            }

            .photos-header-info {
                font-size: 8pt;
            }

            .safety-checkboxes {
                font-size: 8pt;
            }

            .overview-wrapper {
                overflow-x: auto;
                margin: 0 -12px;
                padding: 0 12px;
            }

            .ops-table,
            .equip-table {
                font-size: 7pt;
            }

            .ops-table th,
            .equip-table th {
                padding: 3px 2px;
                font-size: 5pt;
            }

            .ops-table td,
            .equip-table td {
                padding: 3px 2px;
            }

            .photos-grid {
                grid-template-columns: 1fr;
            }

            .photo-cell {
                border-right: 1px solid #ccc !important;
                min-height: 200px;
            }

            .photo-image {
                height: 150px;
            }

            .page-footer {
                position: relative;
                bottom: auto;
                left: auto;
                right: auto;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- SCREEN-ONLY HEADER -->
    <header class="screen-header">
        <div>
            <h1>RPR Daily Report</h1>
            <div class="header-date" id="headerDate"></div>
        </div>
        <div class="header-buttons">
            <a href="index.html" class="header-btn btn-home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <button onclick="goToEdit()" class="header-btn btn-edit">
                <i class="fas fa-edit"></i>
                <span>Edit</span>
            </button>
            <button onclick="submitReport()" class="header-btn btn-submit">
                <i class="fas fa-paper-plane"></i>
                <span>Submit</span>
            </button>
        </div>
    </header>

    <!-- PAGE CONTAINER -->
    <div class="page-container">

        <!-- ==================== PAGE 1 ==================== -->
        <div class="page page-break" id="page1">
            <!-- Report Header -->
            <div class="report-header">
                <div id="logoContainer">
                    <div class="report-logo-placeholder" id="logoPlaceholder">
                        LOUIS ARMSTRONG<br>NEW ORLEANS<br>INTERNATIONAL AIRPORT
                    </div>
                    <img id="logoImage" class="report-logo" style="display:none;" alt="Project Logo">
                </div>
                <div class="report-title">RPR DAILY REPORT</div>
            </div>

            <!-- Project Overview -->
            <div class="section-header">Project Overview</div>
            <div class="overview-wrapper">
            <table class="overview-table">
                <tr>
                    <td class="label">PROJECT NAME:</td>
                    <td class="value" id="projectName"></td>
                    <td class="label">DATE:</td>
                    <td class="value" id="reportDate"></td>
                </tr>
                <tr>
                    <td class="label">NOAB PROJECT NO.:</td>
                    <td class="value" id="noabProjectNo"></td>
                    <td class="label">LOCATION:</td>
                    <td class="value" id="location"></td>
                </tr>
                <tr>
                    <td class="label">CNO SOLICITATION NO.:</td>
                    <td class="value" id="cnoSolicitationNo"></td>
                    <td class="label">ENGINEER:</td>
                    <td class="value" id="engineer"></td>
                </tr>
                <tr>
                    <td class="label">NOTICE TO PROCEED:</td>
                    <td class="value" id="noticeToProceed"></td>
                    <td class="label">CONTRACTOR:</td>
                    <td class="value" id="contractor"></td>
                </tr>
                <tr>
                    <td class="label">CONTRACT DURATION:</td>
                    <td class="value" id="contractDuration"></td>
                    <td class="label">START TIME:</td>
                    <td class="value" id="startTime"></td>
                </tr>
                <tr>
                    <td class="label">EXPECTED COMPLETION:</td>
                    <td class="value" id="expectedCompletion"></td>
                    <td class="label">END TIME:</td>
                    <td class="value" id="endTime"></td>
                </tr>
                <tr>
                    <td class="label">CONTRACT DAY #:</td>
                    <td class="value" id="contractDay"></td>
                    <td class="label">SHIFT DURATION:</td>
                    <td class="value" id="shiftDuration"></td>
                </tr>
                <tr>
                    <td class="label">WEATHER DAYS:</td>
                    <td class="value" id="weatherDays"></td>
                    <td class="label">COMPLETED BY:</td>
                    <td class="value" id="completedBy"></td>
                </tr>
                <!-- Weather Row -->
                <tr class="weather-row">
                    <td class="weather-label" rowspan="5">WEATHER:</td>
                    <td id="weatherTemps" colspan="1"></td>
                    <td class="label" rowspan="5">SIGNATURE:</td>
                    <td class="signature-cell" rowspan="5" id="signatureCell">
                        <div class="signature-name" id="signatureName"></div>
                        <div class="signature-details" id="signatureDetails"></div>
                    </td>
                </tr>
                <tr class="weather-row">
                    <td class="weather-sub" id="weatherPrecip"></td>
                </tr>
                <tr class="weather-row">
                    <td class="weather-sub" id="weatherCondition"></td>
                </tr>
                <tr class="weather-row">
                    <td class="weather-sub" id="weatherJobSite"></td>
                </tr>
                <tr class="weather-row">
                    <td class="weather-sub" id="weatherAdverse"></td>
                </tr>
            </table>
            </div><!-- end overview-wrapper -->

            <!-- Daily Work Summary -->
            <div class="section-header">Daily Work Summary</div>
            <div class="work-summary">
                <p style="font-weight:bold; margin-bottom:8px;">Construction Activities Performed and Observed on this Date:</p>
                <div id="workSummaryContent">
                    <!-- Contractor blocks will be inserted here -->
                </div>
            </div>

            <div class="page-footer">1 of <span class="total-pages">4</span></div>
        </div>

        <!-- ==================== PAGE 2 ==================== -->
        <div class="page page-break" id="page2">
            <!-- Report Header (repeated) -->
            <div class="report-header">
                <div id="logoContainer2">
                    <div class="report-logo-placeholder" id="logoPlaceholder2">
                        LOUIS ARMSTRONG<br>NEW ORLEANS<br>INTERNATIONAL AIRPORT
                    </div>
                    <img id="logoImage2" class="report-logo" style="display:none;" alt="Project Logo">
                </div>
                <div class="report-title">RPR DAILY REPORT</div>
            </div>

            <!-- Daily Operations Table -->
            <div class="section-header">Daily Operations</div>
            <div class="overview-wrapper">
            <table class="ops-table">
                <thead>
                    <tr>
                        <th>CONTRACTOR</th>
                        <th>TRADE</th>
                        <th>SUPER(S)</th>
                        <th>FOREMAN</th>
                        <th>OPERATOR(S)</th>
                        <th>LABORER(S)</th>
                        <th>SURVEYOR(S)</th>
                        <th>OTHER(S)</th>
                    </tr>
                </thead>
                <tbody id="operationsTableBody">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
            </div>

            <!-- Equipment Table -->
            <div class="section-header">Mobilized Equipment & Daily Utilization</div>
            <div class="overview-wrapper">
            <table class="equip-table">
                <thead>
                    <tr>
                        <th>CONTRACTOR</th>
                        <th>EQUIPMENT TYPE / MODEL #</th>
                        <th>QTY</th>
                        <th>NOTES</th>
                    </tr>
                </thead>
                <tbody id="equipmentTableBody">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
            </div>

            <!-- Issues Section -->
            <div class="section-header">General Issues; Unforeseen Conditions; Notices Given</div>
            <div class="text-section" id="issuesContent">
                <ul><li class="na-text">N/A.</li></ul>
            </div>

            <!-- Communications Section -->
            <div class="section-header">Communications with the Contractor</div>
            <div class="text-section" id="communicationsContent">
                <ul><li class="na-text">N/A.</li></ul>
            </div>

            <div class="page-footer">2 of <span class="total-pages">4</span></div>
        </div>

        <!-- ==================== PAGE 3 ==================== -->
        <div class="page page-break" id="page3">
            <!-- Report Header (repeated) -->
            <div class="report-header">
                <div id="logoContainer3">
                    <div class="report-logo-placeholder" id="logoPlaceholder3">
                        LOUIS ARMSTRONG<br>NEW ORLEANS<br>INTERNATIONAL AIRPORT
                    </div>
                    <img id="logoImage3" class="report-logo" style="display:none;" alt="Project Logo">
                </div>
                <div class="report-title">RPR DAILY REPORT</div>
            </div>

            <!-- QA/QC Section -->
            <div class="section-header">QA/QC Testing and/or Inspections</div>
            <div class="text-section" id="qaqcContent">
                <ul><li class="na-text">N/A.</li></ul>
            </div>

            <!-- Safety Section -->
            <div class="section-header">
                <div class="safety-header">
                    <span>Safety Report</span>
                </div>
            </div>
            <div class="text-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span style="font-weight:bold;">Incident(s) on this Date:</span>
                    <div class="safety-checkboxes">
                        <div class="checkbox-item">
                            <span class="checkbox-box" id="checkYes"></span>
                            <span>Yes</span>
                        </div>
                        <div class="checkbox-item">
                            <span class="checkbox-box" id="checkNo">X</span>
                            <span>No</span>
                        </div>
                    </div>
                </div>
                <div id="safetyContent">
                    <ul><li class="na-text">N/A.</li></ul>
                </div>
            </div>

            <!-- Visitors Section -->
            <div class="section-header">Visitors; Deliveries; Additional Contract and/or Change Order Activities; Other Remarks</div>
            <div class="text-section" id="visitorsContent">
                <ul><li class="na-text">N/A.</li></ul>
            </div>

            <div class="page-footer">3 of <span class="total-pages">4</span></div>
        </div>

        <!-- ==================== PAGE 4 (Photos) ==================== -->
        <div class="page" id="page4">
            <!-- Report Header (repeated) -->
            <div class="report-header">
                <div id="logoContainer4">
                    <div class="report-logo-placeholder" id="logoPlaceholder4">
                        LOUIS ARMSTRONG<br>NEW ORLEANS<br>INTERNATIONAL AIRPORT
                    </div>
                    <img id="logoImage4" class="report-logo" style="display:none;" alt="Project Logo">
                </div>
                <div class="report-title">RPR DAILY REPORT</div>
            </div>

            <!-- Photos Section -->
            <div class="section-header">Daily Photos</div>
            <div class="photos-header-info">
                <table>
                    <tr>
                        <td class="photo-label">Project Name:</td>
                        <td id="photoProjectName"></td>
                    </tr>
                    <tr>
                        <td class="photo-label">Project #:</td>
                        <td id="photoProjectNo"></td>
                    </tr>
                </table>
            </div>
            <div class="photos-grid" id="photosGrid">
                <!-- Photo cells will be inserted here -->
            </div>

            <div class="page-footer"><span id="photoPageNum">4</span> of <span class="total-pages">4</span></div>
        </div>

    </div><!-- END page-container -->

    <script>
        // ============ STATE ============
        let report = null;
        let activeProject = null;
        let projectContractors = [];

        const PROJECTS_KEY = 'fvp_projects';
        const ACTIVE_PROJECT_KEY = 'fvp_active_project';

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            loadActiveProject();
            report = loadReport();

            if (!report) {
                alert('No report found for this date.');
                window.location.href = 'index.html';
                return;
            }

            populateReport();
            updateTotalPages();
            checkSubmittedState();
        });

        // ============ CHECK SUBMITTED STATE ============
        function checkSubmittedState() {
            if (report && report.meta && report.meta.submitted) {
                const submitBtn = document.querySelector('.btn-submit');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-check"></i><span>Submitted</span>';
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.7';
                    submitBtn.style.cursor = 'default';
                }
            }
        }

        // ============ PROJECT LOADING ============
        function loadActiveProject() {
            const activeId = localStorage.getItem(ACTIVE_PROJECT_KEY);
            if (!activeId) return;

            const projectsJson = localStorage.getItem(PROJECTS_KEY);
            if (!projectsJson) return;

            try {
                const projects = JSON.parse(projectsJson);
                activeProject = projects.find(p => p.id === activeId) || null;
                if (activeProject && activeProject.contractors) {
                    projectContractors = [...activeProject.contractors].sort((a, b) => {
                        if (a.type === 'prime' && b.type !== 'prime') return -1;
                        if (a.type !== 'prime' && b.type === 'prime') return 1;
                        return 0;
                    });
                }
            } catch (e) {
                console.error('Failed to load project:', e);
            }
        }

        // ============ REPORT LOADING ============
        function loadReport() {
            const params = new URLSearchParams(window.location.search);
            const dateParam = params.get('date');
            const todayStr = dateParam || new Date().toISOString().split('T')[0];

            // Try project-specific key first
            if (activeProject) {
                const key = `fieldvoice_report_${activeProject.id}_${todayStr}`;
                let saved = localStorage.getItem(key);
                if (saved) {
                    try { return JSON.parse(saved); } catch (e) {}
                }
            }

            // Try date-only key
            const legacyKey = `fieldvoice_report_${todayStr}`;
            let saved = localStorage.getItem(legacyKey);
            if (saved) {
                try { return JSON.parse(saved); } catch (e) {}
            }

            // Try very old legacy key
            saved = localStorage.getItem('fieldvoice_report');
            if (saved) {
                try { return JSON.parse(saved); } catch (e) {}
            }

            return null;
        }

        // ============ POPULATE REPORT ============
        function populateReport() {
            const o = report.overview || {};
            const ai = report.aiGenerated || {};
            const userEdits = report.userEdits || {};

            // Helper to get value with priority
            function getValue(path, defaultVal = '') {
                if (userEdits[path] !== undefined) return userEdits[path];
                const aiVal = getNestedValue(ai, path);
                if (aiVal !== undefined && aiVal !== null && aiVal !== '') {
                    if (Array.isArray(aiVal)) return aiVal.join('\n');
                    return aiVal;
                }
                const reportVal = getNestedValue(report, path);
                if (reportVal !== undefined && reportVal !== null && reportVal !== '') {
                    if (Array.isArray(reportVal)) return reportVal.join('\n');
                    return reportVal;
                }
                return defaultVal;
            }

            function getNestedValue(obj, path) {
                return path.split('.').reduce((o, k) => (o || {})[k], obj);
            }

            // Update header date
            document.getElementById('headerDate').textContent = formatDisplayDate(o.date);

            // Project Overview
            document.getElementById('projectName').textContent = getValue('overview.projectName', activeProject?.name || '');
            document.getElementById('reportDate').textContent = formatDisplayDate(o.date);
            document.getElementById('noabProjectNo').textContent = getValue('overview.noabProjectNo', activeProject?.noabProjectNo || '');
            document.getElementById('location').textContent = getValue('overview.location', activeProject?.location || '');
            document.getElementById('cnoSolicitationNo').textContent = getValue('overview.cnoSolicitationNo', activeProject?.cnoSolicitationNo || 'N/A');
            document.getElementById('engineer').textContent = getValue('overview.engineer', activeProject?.engineer || '');

            // Notice to Proceed
            const ntpDate = activeProject?.noticeToProceed;
            document.getElementById('noticeToProceed').textContent = ntpDate ? formatDisplayDate(ntpDate) : '';

            document.getElementById('contractor').textContent = getValue('overview.contractor', activeProject?.primeContractor || '');

            // Contract Duration
            const duration = activeProject?.contractDuration;
            document.getElementById('contractDuration').textContent = duration ? `${duration} days` : '';

            // Times
            document.getElementById('startTime').textContent = formatTime(getValue('overview.startTime', activeProject?.defaultStartTime || ''));
            document.getElementById('endTime').textContent = formatTime(getValue('overview.endTime', activeProject?.defaultEndTime || ''));

            // Expected Completion
            const expectedDate = activeProject?.expectedCompletion;
            document.getElementById('expectedCompletion').textContent = expectedDate ? formatDisplayDate(expectedDate) : '';

            // Shift Duration
            const startTime = getValue('overview.startTime', activeProject?.defaultStartTime || '');
            const endTime = getValue('overview.endTime', activeProject?.defaultEndTime || '');
            document.getElementById('shiftDuration').textContent = calculateShiftDuration(startTime, endTime);

            // Contract Day
            const contractDay = getValue('overview.contractDay', '');
            if (contractDay && duration) {
                document.getElementById('contractDay').textContent = `${contractDay} of ${duration} days`;
            } else {
                document.getElementById('contractDay').textContent = contractDay;
            }

            // Weather Days
            document.getElementById('weatherDays').textContent = getValue('overview.weatherDays', activeProject?.weatherDays || '0') + ' days';

            // Completed By
            document.getElementById('completedBy').textContent = getValue('overview.completedBy', '');

            // Weather
            const weather = o.weather || {};
            document.getElementById('weatherTemps').textContent = `High Temp: ${weather.highTemp || '--'}° Low Temp: ${weather.lowTemp || '--'}°`;
            document.getElementById('weatherPrecip').textContent = `Precipitation: ${weather.precipitation || '0.00"'}`;
            document.getElementById('weatherCondition').textContent = `General Condition: ${weather.generalCondition || 'N/A'}`;
            document.getElementById('weatherJobSite').textContent = `Job Site Condition: ${weather.jobSiteCondition || 'N/A'}`;
            document.getElementById('weatherAdverse').textContent = `Adverse Conditions: ${weather.adverseConditions || 'N/A'}`;

            // Signature
            const sigName = getValue('signature.name', getValue('overview.completedBy', ''));
            const sigTitle = getValue('signature.title', '');
            const sigCompany = getValue('signature.company', '');
            document.getElementById('signatureName').textContent = sigName;

            let sigDetails = '';
            if (sigTitle || sigCompany) {
                sigDetails = `Digitally signed by ${sigName}\nDN: cn=${sigName}, c=US,\no=${sigCompany}, ou=${sigTitle},\nemail=${sigName.toLowerCase().replace(/\s/g, '')}@${sigCompany.toLowerCase().replace(/\s/g, '')}.com\nDate: ${new Date().toISOString().split('T')[0]}`;
            }
            document.getElementById('signatureDetails').innerHTML = sigDetails.replace(/\n/g, '<br>');

            // Render dynamic sections
            renderWorkSummary();
            renderOperationsTable();
            renderEquipmentTable();
            renderTextSections();
            renderSafetySection();
            renderPhotos();
            renderLogo();
        }

        // ============ LOGO RENDERING ============
        function renderLogo() {
            // Check if activeProject has a logo
            if (activeProject && activeProject.logo) {
                const logoData = activeProject.logo;

                // Update all logo containers across all pages
                const logoContainers = [
                    { placeholder: 'logoPlaceholder', image: 'logoImage' },
                    { placeholder: 'logoPlaceholder2', image: 'logoImage2' },
                    { placeholder: 'logoPlaceholder3', image: 'logoImage3' },
                    { placeholder: 'logoPlaceholder4', image: 'logoImage4' }
                ];

                logoContainers.forEach(container => {
                    const placeholder = document.getElementById(container.placeholder);
                    const image = document.getElementById(container.image);

                    if (placeholder && image) {
                        placeholder.style.display = 'none';
                        image.src = logoData;
                        image.style.display = 'block';
                    }
                });
            }
        }

        // ============ WORK SUMMARY ============
        function renderWorkSummary() {
            const container = document.getElementById('workSummaryContent');

            if (projectContractors.length === 0) {
                // No contractors - show general work summary
                const workText = getTextValue('guidedNotes.workSummary', 'issues', 'generalIssues', '');
                container.innerHTML = `<p>${escapeHtml(workText) || '<span class="na-text">No work activities recorded.</span>'}</p>`;
                return;
            }

            let html = '';
            projectContractors.forEach(contractor => {
                const activity = getContractorActivity(contractor.id);
                const typeLabel = contractor.type === 'prime' ? 'PRIME CONTRACTOR' : 'SUBCONTRACTOR';
                const trades = contractor.trades ? ` (${contractor.trades.toUpperCase()})` : '';

                html += `<div class="contractor-block">`;
                html += `<div class="contractor-name">${escapeHtml(contractor.name)} – ${typeLabel}${trades}</div>`;

                if (activity?.noWork) {
                    html += `<div class="contractor-narrative">No work performed on ${formatDisplayDate(report.overview?.date)}.</div>`;
                } else {
                    const narrative = activity?.narrative || '';
                    if (narrative) {
                        html += `<div class="contractor-narrative">${escapeHtml(narrative)}</div>`;
                    }
                    const equipment = activity?.equipmentUsed || '';
                    const crew = activity?.crew || '';
                    if (equipment || crew) {
                        html += `<div class="contractor-details">`;
                        if (equipment) html += `EQUIPMENT: ${escapeHtml(equipment.toUpperCase())}. `;
                        if (crew) html += `CREW: ${escapeHtml(crew.toUpperCase())}.`;
                        html += `</div>`;
                    }
                    if (!narrative && !equipment && !crew) {
                        html += `<div class="contractor-narrative">No work performed on ${formatDisplayDate(report.overview?.date)}.</div>`;
                    }
                }
                html += `</div>`;
            });

            container.innerHTML = html;
        }

        function getContractorActivity(contractorId) {
            const userEdits = report.userEdits || {};
            const userEditKey = `activity_${contractorId}`;
            if (userEdits[userEditKey]) return userEdits[userEditKey];

            if (report.aiGenerated?.activities) {
                const aiActivity = report.aiGenerated.activities.find(a => a.contractorId === contractorId);
                if (aiActivity) return aiActivity;
            }

            if (report.activities) {
                return report.activities.find(a => a.contractorId === contractorId);
            }
            return null;
        }

        // ============ OPERATIONS TABLE ============
        function renderOperationsTable() {
            const tbody = document.getElementById('operationsTableBody');

            if (projectContractors.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:#666;">No contractors defined</td></tr>`;
                return;
            }

            let html = '';
            projectContractors.forEach(contractor => {
                const ops = getContractorOperations(contractor.id);
                const abbrev = contractor.abbreviation || contractor.name.substring(0, 10).toUpperCase();
                const trades = formatTradesAbbrev(contractor.trades);

                html += `<tr>
                    <td>${escapeHtml(abbrev)}</td>
                    <td>${escapeHtml(trades)}</td>
                    <td>${ops?.superintendents || 'N/A'}</td>
                    <td>${ops?.foremen || 'N/A'}</td>
                    <td>${ops?.operators || 'N/A'}</td>
                    <td>${ops?.laborers || 'N/A'}</td>
                    <td>${ops?.surveyors || 'N/A'}</td>
                    <td>${ops?.others || 'N/A'}</td>
                </tr>`;
            });

            tbody.innerHTML = html;
        }

        function getContractorOperations(contractorId) {
            const userEdits = report.userEdits || {};
            const userEditKey = `operations_${contractorId}`;
            if (userEdits[userEditKey]) return userEdits[userEditKey];

            if (report.aiGenerated?.operations) {
                const aiOps = report.aiGenerated.operations.find(o => o.contractorId === contractorId);
                if (aiOps) return aiOps;
            }

            if (report.operations) {
                return report.operations.find(o => o.contractorId === contractorId);
            }
            return null;
        }

        function formatTradesAbbrev(trades) {
            if (!trades) return '-';
            // Common trade abbreviations
            const abbrevMap = {
                'construction management': 'CM',
                'project management': 'PM',
                'pile driving': 'PLE',
                'concrete': 'CONC',
                'asphalt': 'ASP',
                'utilities': 'UTL',
                'earthwork': 'ERTHWRK',
                'electrical': 'ELEC',
                'communications': 'COMM',
                'fence': 'FENCE',
                'pavement markings': 'PVMNT MRK',
                'hauling': 'HAUL',
                'pavement subgrade': 'PVMT SUB',
                'demo': 'DEMO',
                'demolition': 'DEMO',
                'general': 'GEN'
            };

            const parts = trades.split(/[;,]/).map(t => t.trim().toLowerCase());
            const abbrevs = parts.map(t => abbrevMap[t] || t.substring(0, 6).toUpperCase());
            return abbrevs.join('; ');
        }

        // ============ EQUIPMENT TABLE ============
        function renderEquipmentTable() {
            const tbody = document.getElementById('equipmentTableBody');
            const equipmentData = getEquipmentData();

            if (equipmentData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#666;">No equipment mobilized</td></tr>`;
                return;
            }

            let html = '';
            equipmentData.forEach(item => {
                const contractorName = getContractorName(item.contractorId);
                const status = item.status || 'IDLE';
                const notes = status === 'IDLE' ? 'IDLE' : `${status.replace(' hrs', '')} HOURS UTILIZED`;

                html += `<tr>
                    <td>${escapeHtml(contractorName)}</td>
                    <td>${escapeHtml(item.type || 'N/A')}</td>
                    <td>${item.qty || 1}</td>
                    <td>${notes}</td>
                </tr>`;
            });

            tbody.innerHTML = html;
        }

        function getEquipmentData() {
            if (report.equipment && report.equipment.length > 0) {
                return report.equipment;
            }
            if (report.aiGenerated?.equipment && report.aiGenerated.equipment.length > 0) {
                return report.aiGenerated.equipment.map(item => ({
                    contractorId: item.contractorId || '',
                    type: item.type || '',
                    qty: item.qty || item.quantity || 1,
                    status: item.status || (item.hoursUsed ? `${item.hoursUsed} hrs` : 'IDLE')
                }));
            }
            return [];
        }

        function getContractorName(contractorId) {
            const contractor = projectContractors.find(c => c.id === contractorId);
            if (contractor) {
                return contractor.abbreviation || contractor.name.substring(0, 15).toUpperCase();
            }
            return 'UNKNOWN';
        }

        // ============ TEXT SECTIONS ============
        function renderTextSections() {
            // Issues
            const issues = getTextValue('issues', 'generalIssues', 'guidedNotes.issues', '');
            document.getElementById('issuesContent').innerHTML = formatTextSection(issues);

            // Communications
            const comms = getTextValue('communications', 'contractorCommunications', '', '');
            document.getElementById('communicationsContent').innerHTML = formatTextSection(comms);

            // QA/QC
            const qaqc = getTextValue('qaqc', 'qaqcNotes', '', '');
            document.getElementById('qaqcContent').innerHTML = formatTextSection(qaqc);

            // Visitors
            const visitors = getTextValue('visitors', 'visitorsRemarks', '', '');
            document.getElementById('visitorsContent').innerHTML = formatTextSection(visitors);
        }

        function getTextValue(reportPath, aiPath, fallbackPath, defaultVal) {
            const userEdits = report.userEdits || {};

            // User edits first
            if (userEdits[reportPath] !== undefined) {
                return userEdits[reportPath];
            }

            // AI generated
            if (report.aiGenerated) {
                const aiVal = getNestedValueSimple(report.aiGenerated, aiPath);
                if (aiVal !== undefined && aiVal !== null && aiVal !== '') {
                    if (Array.isArray(aiVal)) return aiVal.join('\n');
                    return aiVal;
                }
            }

            // Report value
            const reportVal = getNestedValueSimple(report, reportPath);
            if (reportVal !== undefined && reportVal !== null && reportVal !== '') {
                if (Array.isArray(reportVal)) return reportVal.join('\n');
                return reportVal;
            }

            // Fallback path
            if (fallbackPath) {
                const fallbackVal = getNestedValueSimple(report, fallbackPath);
                if (fallbackVal !== undefined && fallbackVal !== null && fallbackVal !== '') {
                    if (Array.isArray(fallbackVal)) return fallbackVal.join('\n');
                    return fallbackVal;
                }
            }

            return defaultVal;
        }

        function getNestedValueSimple(obj, path) {
            return path.split('.').reduce((o, k) => (o || {})[k], obj);
        }

        function formatTextSection(text) {
            if (!text || text.trim() === '') {
                return '<ul><li class="na-text">N/A.</li></ul>';
            }

            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length === 0) {
                return '<ul><li class="na-text">N/A.</li></ul>';
            }

            if (lines.length === 1) {
                return `<ul><li>${escapeHtml(lines[0])}</li></ul>`;
            }

            return '<ul>' + lines.map(line => `<li>${escapeHtml(line)}</li>`).join('') + '</ul>';
        }

        // ============ SAFETY SECTION ============
        function renderSafetySection() {
            const hasIncident = report.safety?.hasIncident || report.aiGenerated?.safety?.hasIncidents || false;
            const noIncident = !hasIncident;

            document.getElementById('checkYes').textContent = hasIncident ? 'X' : '';
            document.getElementById('checkYes').classList.toggle('checked', hasIncident);
            document.getElementById('checkNo').textContent = noIncident ? 'X' : '';
            document.getElementById('checkNo').classList.toggle('checked', noIncident);

            const safetyNotes = getTextValue('safety.notes', 'safety.notes', 'guidedNotes.safety', '');
            document.getElementById('safetyContent').innerHTML = formatTextSection(safetyNotes);
        }

        // ============ PHOTOS ============
        function renderPhotos() {
            const photos = report.photos || [];
            const grid = document.getElementById('photosGrid');
            const projectName = report.overview?.projectName || activeProject?.name || '';
            const projectNo = report.overview?.noabProjectNo || activeProject?.noabProjectNo || '';

            document.getElementById('photoProjectName').textContent = projectName;
            document.getElementById('photoProjectNo').textContent = projectNo;

            if (photos.length === 0) {
                grid.innerHTML = `
                    <div class="photo-cell">
                        <div class="photo-image empty">No photos captured</div>
                        <div class="photo-meta"><span>Date:</span> --</div>
                    </div>
                    <div class="photo-cell">
                        <div class="photo-image empty"></div>
                        <div class="photo-meta"><span>Date:</span> --</div>
                    </div>
                `;
                return;
            }

            // Generate photo cells (4 per page, 2x2 grid)
            let html = '';
            const displayPhotos = photos.slice(0, 4); // First 4 photos for page 4

            for (let i = 0; i < 4; i++) {
                const photo = displayPhotos[i];
                if (photo) {
                    html += `
                        <div class="photo-cell">
                            <div class="photo-image">
                                <img src="${photo.url}" alt="Photo ${i + 1}">
                            </div>
                            <div class="photo-meta"><span>Date:</span> ${photo.date || formatDisplayDate(report.overview?.date)}</div>
                            <div class="photo-caption">${escapeHtml(photo.caption) || ''}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="photo-cell">
                            <div class="photo-image empty"></div>
                            <div class="photo-meta"><span>Date:</span> ${formatDisplayDate(report.overview?.date)}</div>
                        </div>
                    `;
                }
            }

            grid.innerHTML = html;

            // If more than 4 photos, add additional photo pages
            if (photos.length > 4) {
                addAdditionalPhotoPages(photos.slice(4));
            }
        }

        function addAdditionalPhotoPages(remainingPhotos) {
            const container = document.querySelector('.page-container');
            let pageNum = 5;

            for (let i = 0; i < remainingPhotos.length; i += 4) {
                const pagePhotos = remainingPhotos.slice(i, i + 4);
                const page = document.createElement('div');
                page.className = 'page' + (i + 4 < remainingPhotos.length ? ' page-break' : '');

                let photosHtml = '';
                for (let j = 0; j < 4; j++) {
                    const photo = pagePhotos[j];
                    if (photo) {
                        photosHtml += `
                            <div class="photo-cell">
                                <div class="photo-image">
                                    <img src="${photo.url}" alt="Photo">
                                </div>
                                <div class="photo-meta"><span>Date:</span> ${photo.date || formatDisplayDate(report.overview?.date)}</div>
                                <div class="photo-caption">${escapeHtml(photo.caption) || ''}</div>
                            </div>
                        `;
                    } else {
                        photosHtml += `
                            <div class="photo-cell">
                                <div class="photo-image empty"></div>
                                <div class="photo-meta"><span>Date:</span> --</div>
                            </div>
                        `;
                    }
                }

                // Determine logo HTML based on whether project has a logo
                const logoHtml = activeProject && activeProject.logo
                    ? `<img src="${activeProject.logo}" class="report-logo" alt="Project Logo">`
                    : `<div class="report-logo-placeholder">LOUIS ARMSTRONG<br>NEW ORLEANS<br>INTERNATIONAL AIRPORT</div>`;

                page.innerHTML = `
                    <div class="report-header">
                        <div>${logoHtml}</div>
                        <div class="report-title">RPR DAILY REPORT</div>
                    </div>
                    <div class="section-header">Daily Photos (Continued)</div>
                    <div class="photos-grid">${photosHtml}</div>
                    <div class="page-footer">${pageNum} of <span class="total-pages">4</span></div>
                `;

                container.appendChild(page);
                pageNum++;
            }

            updateTotalPages();
        }

        function updateTotalPages() {
            const pages = document.querySelectorAll('.page');
            const totalPages = pages.length;
            document.querySelectorAll('.total-pages').forEach(el => {
                el.textContent = totalPages;
            });
        }

        // ============ UTILITY FUNCTIONS ============
        function formatDisplayDate(dateStr) {
            if (!dateStr) return '--';
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return dateStr;
                return d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            try {
                // Handle already formatted time (e.g., "6:00 AM")
                if (timeStr.includes('AM') || timeStr.includes('PM')) {
                    return timeStr;
                }
                // Handle 24-hour format (e.g., "06:00")
                const parts = timeStr.split(':');
                if (parts.length < 2) return timeStr;
                const hours = parseInt(parts[0], 10);
                const minutes = parseInt(parts[1], 10);
                if (isNaN(hours) || isNaN(minutes)) return timeStr;
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                return `${displayHours}:${String(minutes).padStart(2, '0')} ${period}`;
            } catch (e) {
                return timeStr;
            }
        }

        function calculateShiftDuration(startTime, endTime) {
            if (!startTime || !endTime) return '';
            try {
                // Handle already formatted times
                let startHours, startMinutes, endHours, endMinutes;
                
                if (startTime.includes(':')) {
                    const startParts = startTime.split(':');
                    startHours = parseInt(startParts[0], 10);
                    startMinutes = parseInt(startParts[1], 10) || 0;
                } else {
                    return '';
                }
                
                if (endTime.includes(':')) {
                    const endParts = endTime.split(':');
                    endHours = parseInt(endParts[0], 10);
                    endMinutes = parseInt(endParts[1], 10) || 0;
                } else {
                    return '';
                }
                
                if (isNaN(startHours) || isNaN(endHours)) return '';
                
                let diffMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);
                if (diffMinutes < 0) diffMinutes += 24 * 60; // Handle overnight
                
                const hours = diffMinutes / 60;
                return `${hours.toFixed(2)} hours`;
            } catch (e) {
                return '';
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ============ NAVIGATION ============
        function goToEdit() {
            const params = new URLSearchParams(window.location.search);
            const dateParam = params.get('date');
            if (dateParam) {
                window.location.href = `report.html?date=${dateParam}`;
            } else {
                window.location.href = 'report.html';
            }
        }

        function submitReport() {
            if (!report) {
                alert('No report data found.');
                return;
            }

            // Get the current report key
            const params = new URLSearchParams(window.location.search);
            const dateParam = params.get('date');
            const todayStr = dateParam || new Date().toISOString().split('T')[0];

            // Mark report as submitted
            report.meta = report.meta || {};
            report.meta.submitted = true;
            report.meta.submittedAt = new Date().toISOString();

            // Determine the storage key
            let storageKey;
            if (activeProject) {
                storageKey = `fieldvoice_report_${activeProject.id}_${todayStr}`;
            } else {
                storageKey = `fieldvoice_report_${todayStr}`;
            }

            // Save the updated report
            try {
                localStorage.setItem(storageKey, JSON.stringify(report));
                showSubmitSuccess();
            } catch (e) {
                console.error('Failed to save report:', e);
                alert('Failed to submit report. Storage may be full.');
            }
        }

        function showSubmitSuccess() {
            // Create and show a success modal
            const modal = document.createElement('div');
            modal.id = 'submitSuccessModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    max-width: 400px;
                    width: 100%;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                ">
                    <div style="
                        background: #16a34a;
                        padding: 20px;
                        text-align: center;
                    ">
                        <i class="fas fa-check-circle" style="color: white; font-size: 48px;"></i>
                    </div>
                    <div style="padding: 24px; text-align: center;">
                        <h3 style="
                            font-size: 18px;
                            font-weight: bold;
                            color: #1e293b;
                            margin-bottom: 8px;
                            text-transform: uppercase;
                        ">Report Submitted</h3>
                        <p style="
                            color: #64748b;
                            font-size: 14px;
                            margin-bottom: 20px;
                        ">Your report has been saved to the archives.</p>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeSubmitModal()" style="
                                flex: 1;
                                padding: 12px;
                                background: #f1f5f9;
                                border: 1px solid #e2e8f0;
                                color: #475569;
                                font-weight: bold;
                                text-transform: uppercase;
                                font-size: 12px;
                                cursor: pointer;
                            ">Close</button>
                            <button onclick="window.location.href='archives.html'" style="
                                flex: 1;
                                padding: 12px;
                                background: #0a1628;
                                border: none;
                                color: white;
                                font-weight: bold;
                                text-transform: uppercase;
                                font-size: 12px;
                                cursor: pointer;
                            ">View Archives</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Update the submit button to show submitted state
            const submitBtn = document.querySelector('.btn-submit');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-check"></i><span>Submitted</span>';
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.7';
                submitBtn.style.cursor = 'default';
            }
        }

        function closeSubmitModal() {
            const modal = document.getElementById('submitSuccessModal');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html>
