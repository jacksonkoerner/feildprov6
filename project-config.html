<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Project Configuration - FieldVoice Pro</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
    <meta name="theme-color" content="#0a1628">

    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FieldVoice">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dot-navy': '#0a1628',
                        'dot-blue': '#1e3a5f',
                        'dot-slate': '#334155',
                        'dot-orange': '#ea580c',
                        'dot-yellow': '#f59e0b',
                        'safety-green': '#16a34a',
                        'dot-green': '#4a7c59',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        .header-stripe {
            background: repeating-linear-gradient(-45deg, #f59e0b, #f59e0b 10px, #0a1628 10px, #0a1628 20px);
            height: 4px;
            padding-top: env(safe-area-inset-top);
        }
        .drag-handle {
            cursor: grab;
            touch-action: none;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .dragging {
            opacity: 0.5;
            background-color: #e2e8f0;
        }
        .drag-over {
            border-top: 2px solid #16a34a;
        }
        /* Import Section Styles */
        .import-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px dashed #cbd5e1;
        }
        .drop-zone {
            border: 2px dashed #94a3b8;
            border-radius: 8px;
            transition: all 0.2s ease;
            background: white;
        }
        .drop-zone.drag-active {
            border-color: #ea580c;
            background-color: #fff7ed;
            transform: scale(1.01);
        }
        .drop-zone:hover {
            border-color: #64748b;
        }
        .file-item {
            animation: slideIn 0.2s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .missing-field {
            border-color: #dc2626 !important;
            background-color: #fef2f2 !important;
        }
        .missing-indicator {
            color: #dc2626;
            font-size: 11px;
            font-weight: 600;
        }
        .extraction-success-banner {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left: 4px solid #16a34a;
        }
        .extraction-error-banner {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border-left: 4px solid #dc2626;
        }
        .extraction-notes {
            background: #fffbeb;
            border: 1px solid #fde68a;
        }
        .spin-animation {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Logo Upload Styles */
        .logo-drop-zone {
            border: 2px dashed #94a3b8;
            border-radius: 8px;
            transition: all 0.2s ease;
            background: #f8fafc;
            cursor: pointer;
        }
        .logo-drop-zone.drag-active {
            border-color: #ea580c;
            background-color: #fff7ed;
            transform: scale(1.01);
        }
        .logo-drop-zone:hover {
            border-color: #64748b;
            background-color: #f1f5f9;
        }
        .logo-preview-container {
            position: relative;
            display: inline-block;
        }
        .logo-preview-container img {
            max-height: 150px;
            max-width: 100%;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }
        .logo-remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #dc2626;
            color: white;
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        .logo-remove-btn:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="header-stripe"></div>

    <div class="max-w-lg mx-auto min-h-screen flex flex-col">

        <!-- HEADER -->
        <header class="bg-dot-navy text-white p-4">
            <div class="flex items-center gap-4">
                <a href="index.html" class="w-10 h-10 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-arrow-left text-slate-400"></i>
                </a>
                <div>
                    <p class="text-[10px] font-bold text-dot-yellow uppercase tracking-widest">Project Setup</p>
                    <h1 class="text-xl font-bold">Project Configuration</h1>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-4 space-y-4">

            <!-- SAVED PROJECTS LIST -->
            <section class="bg-white border-2 border-slate-200">
                <div class="bg-dot-green text-white p-4">
                    <h2 class="text-sm font-bold uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-folder-open"></i>
                        Saved Projects
                    </h2>
                </div>
                <div id="savedProjectsList" class="divide-y divide-slate-200">
                    <!-- Projects will be rendered here -->
                </div>
                <div class="p-4 border-t border-slate-200">
                    <button onclick="createNewProject()" class="w-full p-3 bg-dot-green hover:bg-green-700 text-white font-bold uppercase transition-colors flex items-center justify-center gap-2 text-sm">
                        <i class="fas fa-plus"></i>
                        New Project
                    </button>
                </div>
            </section>

            <!-- PROJECT DETAILS FORM (hidden by default until project is loaded/created) -->
            <div id="projectFormContainer" class="hidden space-y-4">

                <!-- Active Project Indicator -->
                <div id="activeProjectBadge" class="hidden bg-safety-green text-white p-3 flex items-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    <span class="text-sm font-bold uppercase">Active Project</span>
                </div>

                <!-- Import from Existing Report Section -->
                <section class="import-section p-4 rounded-lg">
                    <div class="mb-4">
                        <h2 class="text-sm font-bold text-dot-navy uppercase tracking-wider flex items-center gap-2 mb-2">
                            <i class="fas fa-file-import text-dot-orange"></i>
                            Import from Existing Report
                        </h2>
                        <p class="text-xs text-slate-600">Upload one or more RPR Daily Reports to automatically extract project details, contractors, and equipment.</p>
                    </div>

                    <!-- Success/Error Banners -->
                    <div id="extractionSuccessBanner" class="hidden extraction-success-banner p-3 mb-4 rounded">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-check-circle text-safety-green mt-0.5"></i>
                            <div>
                                <p class="text-sm font-bold text-green-800">Project data extracted!</p>
                                <p class="text-xs text-green-700">Please review and make any corrections before saving.</p>
                            </div>
                        </div>
                    </div>

                    <div id="extractionErrorBanner" class="hidden extraction-error-banner p-3 mb-4 rounded">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-exclamation-circle text-red-600 mt-0.5"></i>
                            <div>
                                <p class="text-sm font-bold text-red-800">Extraction failed</p>
                                <p id="extractionErrorMessage" class="text-xs text-red-700"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Drop Zone -->
                    <div id="dropZone" class="drop-zone p-6 text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx" multiple onchange="handleFileSelect(event)">
                        <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-3"></i>
                        <p class="text-sm font-medium text-slate-600 mb-1">Drag and drop files here</p>
                        <p class="text-xs text-slate-500 mb-3">or</p>
                        <button type="button" onclick="event.stopPropagation(); document.getElementById('fileInput').click();" class="px-4 py-2 bg-dot-blue hover:bg-blue-800 text-white text-sm font-bold uppercase transition-colors">
                            <i class="fas fa-folder-open mr-2"></i>Browse Files
                        </button>
                        <p class="text-xs text-slate-400 mt-3">Accepts PDF and DOCX files</p>
                    </div>

                    <!-- Selected Files List -->
                    <div id="selectedFilesList" class="hidden mt-4">
                        <p class="text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">Selected Files:</p>
                        <div id="filesContainer" class="space-y-2">
                            <!-- Files will be rendered here -->
                        </div>
                    </div>

                    <!-- Extract Button -->
                    <button id="extractBtn" onclick="extractProjectData()" class="hidden w-full mt-4 p-3 bg-dot-orange hover:bg-orange-700 text-white font-bold uppercase transition-colors flex items-center justify-center gap-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <i id="extractBtnIcon" class="fas fa-magic"></i>
                        <span id="extractBtnText">Extract Project Data</span>
                    </button>

                    <!-- Extraction Notes (collapsible) -->
                    <div id="extractionNotesSection" class="hidden mt-4">
                        <button onclick="toggleExtractionNotes()" class="w-full text-left extraction-notes p-3 rounded flex items-center justify-between">
                            <span class="text-xs font-bold text-yellow-800 uppercase tracking-wider">
                                <i class="fas fa-info-circle mr-1"></i>
                                Extraction Notes
                            </span>
                            <i id="notesToggleIcon" class="fas fa-chevron-down text-yellow-700 text-xs transition-transform"></i>
                        </button>
                        <div id="extractionNotesContent" class="hidden bg-yellow-50 p-3 border border-t-0 border-yellow-200 rounded-b text-xs text-yellow-800">
                            <ul id="extractionNotesList" class="space-y-1 list-disc list-inside">
                                <!-- Notes will be rendered here -->
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Project Details -->
                <section class="bg-white border-2 border-slate-200">
                    <div class="bg-dot-navy text-white p-4">
                        <h2 class="text-sm font-bold uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-building text-dot-yellow"></i>
                            Project Details
                        </h2>
                    </div>
                    <div class="p-4 space-y-4">
                        <!-- Project Logo Upload -->
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Project Logo</label>
                            <div id="logoUploadZone" class="logo-drop-zone mt-2 p-4 text-center" onclick="document.getElementById('logoInput').click()">
                                <input type="file" id="logoInput" class="hidden" accept="image/png,image/jpeg,image/jpg,image/svg+xml,image/gif" onchange="handleLogoSelect(event)">
                                <i class="fas fa-image text-2xl text-slate-400 mb-2"></i>
                                <p class="text-xs text-slate-600">Drag & drop or click to upload</p>
                                <p class="text-xs text-slate-400 mt-1">PNG, JPG, SVG, GIF</p>
                            </div>
                            <div id="logoPreviewArea" class="hidden mt-2">
                                <div class="logo-preview-container">
                                    <img id="logoPreviewImg" src="" alt="Project Logo">
                                    <button type="button" onclick="removeLogo()" class="logo-remove-btn" title="Remove logo">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Project Name <span class="text-red-500">*</span></label>
                            <input type="text" id="projectName" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., I-10 Bridge Reconstruction">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">NOAB Project No.</label>
                                <input type="text" id="noabProjectNo" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., 1291">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">CNO Solicitation No.</label>
                                <input type="text" id="cnoSolicitationNo" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="N/A" value="N/A">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Location</label>
                            <input type="text" id="location" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., Jefferson Highway at Mississippi River">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Engineer (Firm)</label>
                            <input type="text" id="engineer" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., AECOM">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Prime Contractor Name</label>
                            <input type="text" id="primeContractor" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., Boh Bros Construction">
                        </div>
                    </div>
                </section>

                <!-- Contract Information -->
                <section class="bg-white border-2 border-slate-200">
                    <div class="bg-dot-blue text-white p-4">
                        <h2 class="text-sm font-bold uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-file-contract"></i>
                            Contract Information
                        </h2>
                    </div>
                    <div class="p-4 space-y-4">
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Notice to Proceed Date</label>
                            <input type="date" id="noticeToProceed" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Report Date (Sample)</label>
                            <input type="date" id="reportDate" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue">
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Contract Duration (Days)</label>
                                <input type="number" id="contractDuration" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., 467">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Weather Days</label>
                                <input type="number" id="weatherDays" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="0" value="0" min="0">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Contract Day #</label>
                                <input type="number" id="contractDayNo" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., 19">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Expected Completion Date</label>
                            <input type="date" id="expectedCompletion" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Default Start Time</label>
                                <input type="time" id="defaultStartTime" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" value="06:00">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Default End Time</label>
                                <input type="time" id="defaultEndTime" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" value="16:00">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Contractor Roster -->
                <section class="bg-white border-2 border-slate-200">
                    <div class="bg-dot-orange text-white p-4">
                        <h2 class="text-sm font-bold uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-hard-hat"></i>
                            Contractor Roster
                        </h2>
                    </div>
                    <div id="contractorList" class="divide-y divide-slate-200">
                        <!-- Contractors will be rendered here -->
                    </div>
                    <div class="p-4 border-t border-slate-200">
                        <button onclick="showAddContractorForm()" class="w-full p-3 bg-dot-orange hover:bg-orange-700 text-white font-bold uppercase transition-colors flex items-center justify-center gap-2 text-sm">
                            <i class="fas fa-plus"></i>
                            Add Contractor
                        </button>
                    </div>
                </section>

                <!-- Add Contractor Form (hidden by default) -->
                <section id="addContractorForm" class="hidden bg-white border-2 border-dot-orange">
                    <div class="bg-dot-orange/10 p-4 border-b border-dot-orange">
                        <h3 class="text-sm font-bold text-dot-orange uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-user-plus"></i>
                            <span id="contractorFormTitle">Add New Contractor</span>
                        </h3>
                    </div>
                    <div class="p-4 space-y-4">
                        <input type="hidden" id="editContractorId">
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Full Name <span class="text-red-500">*</span></label>
                            <input type="text" id="contractorName" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., Boh Bros Construction">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Abbreviation <span class="text-red-500">*</span></label>
                                <input type="text" id="contractorAbbr" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue uppercase" placeholder="e.g., BOH" maxlength="10">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Type <span class="text-red-500">*</span></label>
                                <select id="contractorType" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue">
                                    <option value="prime">Prime</option>
                                    <option value="subcontractor">Subcontractor</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Trades</label>
                            <input type="text" id="contractorTrades" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., Pile Driving; Utilities; Concrete Pvmt">
                            <p class="text-xs text-slate-500 mt-1">Separate multiple trades with semicolons</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveContractor()" class="flex-1 p-3 bg-safety-green hover:bg-green-700 text-white font-bold uppercase transition-colors text-sm">
                                <i class="fas fa-save mr-2"></i>Save
                            </button>
                            <button onclick="hideAddContractorForm()" class="flex-1 p-3 bg-slate-400 hover:bg-slate-500 text-white font-bold uppercase transition-colors text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Equipment Inventory -->
                <section class="bg-white border-2 border-slate-200">
                    <div class="bg-safety-green text-white p-4">
                        <h2 class="text-sm font-bold uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-truck-monster"></i>
                            Equipment Inventory
                        </h2>
                    </div>
                    <div id="equipmentList" class="divide-y divide-slate-200">
                        <!-- Equipment will be rendered here, grouped by contractor -->
                    </div>
                    <div class="p-4 border-t border-slate-200">
                        <button onclick="showAddEquipmentForm()" id="addEquipmentBtn" class="w-full p-3 bg-safety-green hover:bg-green-700 text-white font-bold uppercase transition-colors flex items-center justify-center gap-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-plus"></i>
                            Add Equipment
                        </button>
                    </div>
                </section>

                <!-- Add Equipment Form (hidden by default) -->
                <section id="addEquipmentForm" class="hidden bg-white border-2 border-safety-green">
                    <div class="bg-safety-green/10 p-4 border-b border-safety-green">
                        <h3 class="text-sm font-bold text-safety-green uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-truck"></i>
                            <span id="equipmentFormTitle">Add New Equipment</span>
                        </h3>
                    </div>
                    <div class="p-4 space-y-4">
                        <input type="hidden" id="editEquipmentId">
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Contractor <span class="text-red-500">*</span></label>
                            <select id="equipmentContractor" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue">
                                <!-- Options populated from contractor roster -->
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Equipment Type <span class="text-red-500">*</span></label>
                            <input type="text" id="equipmentType" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., Bulldozer">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-dot-blue uppercase tracking-wider">Model #</label>
                            <input type="text" id="equipmentModel" class="w-full mt-2 bg-white border-2 border-slate-300 px-4 py-3 text-sm text-slate-800 focus:outline-none focus:border-dot-blue" placeholder="e.g., John Deere 700K">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveEquipment()" class="flex-1 p-3 bg-safety-green hover:bg-green-700 text-white font-bold uppercase transition-colors text-sm">
                                <i class="fas fa-save mr-2"></i>Save
                            </button>
                            <button onclick="hideAddEquipmentForm()" class="flex-1 p-3 bg-slate-400 hover:bg-slate-500 text-white font-bold uppercase transition-colors text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Save/Delete Project Actions -->
                <div class="space-y-3">
                    <button onclick="saveProject()" class="w-full p-4 bg-safety-green hover:bg-green-700 text-white font-bold uppercase transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i>
                        Save Project
                    </button>
                    <button onclick="setActiveProject()" id="setActiveBtn" class="w-full p-4 bg-dot-blue hover:bg-blue-800 text-white font-bold uppercase transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-star"></i>
                        Set as Active Project
                    </button>
                    <button onclick="cancelEdit()" class="w-full p-3 bg-slate-300 hover:bg-slate-400 text-slate-700 font-bold uppercase transition-colors flex items-center justify-center gap-2 text-sm">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>

            </div>

        </main>

        <!-- FOOTER -->
        <footer class="bg-dot-navy text-center py-3">
            <p class="text-[10px] text-slate-500 uppercase tracking-widest">
                <i class="fas fa-shield-alt mr-1"></i>
                DOT Compliant Field Documentation System
            </p>
        </footer>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white max-w-sm w-full p-6 shadow-xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">Confirm Delete</h3>
                <p id="deleteModalMessage" class="text-sm text-slate-600 mb-6">Are you sure you want to delete this item?</p>
                <div class="flex gap-3">
                    <button onclick="confirmDelete()" class="flex-1 p-3 bg-red-600 hover:bg-red-700 text-white font-bold uppercase transition-colors text-sm">
                        Delete
                    </button>
                    <button onclick="closeDeleteModal()" class="flex-1 p-3 bg-slate-300 hover:bg-slate-400 text-slate-700 font-bold uppercase transition-colors text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ CONSTANTS ============
        const PROJECTS_KEY = 'fvp_projects';
        const ACTIVE_PROJECT_KEY = 'fvp_active_project';
        const EXTRACT_WEBHOOK_URL = 'https://advidere.app.n8n.cloud/webhook/fieldvoice-project-extractor';

        // ============ STATE ============
        let currentProject = null;
        let deleteCallback = null;
        let selectedFiles = [];

        // ============ INITIALIZATION ============
        // Note: Initialization moved to end of script with setupDropZone()

        // ============ PROJECT MANAGEMENT ============
        function getProjects() {
            const saved = localStorage.getItem(PROJECTS_KEY);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return [];
                }
            }
            return [];
        }

        function saveProjects(projects) {
            localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects));
        }

        function getActiveProjectId() {
            return localStorage.getItem(ACTIVE_PROJECT_KEY);
        }

        function setActiveProjectId(projectId) {
            localStorage.setItem(ACTIVE_PROJECT_KEY, projectId);
        }

        function generateId(prefix) {
            return `${prefix}_${Date.now()}`;
        }

        function createNewProject() {
            currentProject = {
                id: generateId('proj'),
                name: '',
                logo: null,
                noabProjectNo: '',
                cnoSolicitationNo: 'N/A',
                location: '',
                engineer: '',
                primeContractor: '',
                noticeToProceed: '',
                reportDate: '',
                contractDuration: '',
                expectedCompletion: '',
                defaultStartTime: '06:00',
                defaultEndTime: '16:00',
                weatherDays: 0,
                contractDayNo: '',
                contractors: [],
                equipment: []
            };
            populateForm();
            showProjectForm();
        }

        function loadProject(projectId) {
            const projects = getProjects();
            const project = projects.find(p => p.id === projectId);
            if (project) {
                currentProject = JSON.parse(JSON.stringify(project)); // Deep copy
                populateForm();
                showProjectForm();
            }
        }

        function saveProject() {
            if (!currentProject) return;

            // Validate required fields
            const name = document.getElementById('projectName').value.trim();
            if (!name) {
                showToast('Project name is required', 'error');
                document.getElementById('projectName').focus();
                return;
            }

            // Update current project from form
            currentProject.name = name;
            currentProject.logo = currentProject.logo || null;
            currentProject.noabProjectNo = document.getElementById('noabProjectNo').value.trim();
            currentProject.cnoSolicitationNo = document.getElementById('cnoSolicitationNo').value.trim() || 'N/A';
            currentProject.location = document.getElementById('location').value.trim();
            currentProject.engineer = document.getElementById('engineer').value.trim();
            currentProject.primeContractor = document.getElementById('primeContractor').value.trim();
            currentProject.noticeToProceed = document.getElementById('noticeToProceed').value;
            currentProject.reportDate = document.getElementById('reportDate').value;
            currentProject.contractDuration = parseInt(document.getElementById('contractDuration').value) || '';
            currentProject.expectedCompletion = document.getElementById('expectedCompletion').value;
            currentProject.defaultStartTime = document.getElementById('defaultStartTime').value || '06:00';
            currentProject.defaultEndTime = document.getElementById('defaultEndTime').value || '16:00';
            currentProject.weatherDays = parseInt(document.getElementById('weatherDays').value) || 0;
            currentProject.contractDayNo = parseInt(document.getElementById('contractDayNo').value) || '';

            // Save to projects array
            let projects = getProjects();
            const existingIndex = projects.findIndex(p => p.id === currentProject.id);
            if (existingIndex >= 0) {
                projects[existingIndex] = currentProject;
            } else {
                projects.push(currentProject);
            }
            saveProjects(projects);

            showToast('Project saved successfully');
            renderSavedProjects();
            updateActiveProjectBadge();
        }

        function deleteProject(projectId) {
            showDeleteModal('Are you sure you want to delete this project? This cannot be undone.', () => {
                let projects = getProjects();
                projects = projects.filter(p => p.id !== projectId);
                saveProjects(projects);

                // Clear active project if it was deleted
                if (getActiveProjectId() === projectId) {
                    localStorage.removeItem(ACTIVE_PROJECT_KEY);
                }

                // If we're currently editing this project, close the form
                if (currentProject && currentProject.id === projectId) {
                    hideProjectForm();
                }

                renderSavedProjects();
                showToast('Project deleted');
            });
        }

        function setActiveProject() {
            if (!currentProject) return;

            // Save first to ensure project exists
            saveProject();

            setActiveProjectId(currentProject.id);
            showToast('Set as active project');
            renderSavedProjects();
            updateActiveProjectBadge();
        }

        function cancelEdit() {
            currentProject = null;
            hideProjectForm();
        }

        // ============ UI RENDERING ============
        function renderSavedProjects() {
            const container = document.getElementById('savedProjectsList');
            const projects = getProjects();
            const activeId = getActiveProjectId();

            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center">
                        <i class="fas fa-folder-open text-slate-300 text-3xl mb-3"></i>
                        <p class="text-sm text-slate-500">No saved projects</p>
                        <p class="text-xs text-slate-400 mt-1">Create a new project to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = projects.map(project => {
                const isActive = project.id === activeId;
                const isEditing = currentProject && currentProject.id === project.id;
                return `
                    <div class="p-4 ${isEditing ? 'bg-dot-blue/5' : ''} ${isActive ? 'border-l-4 border-safety-green' : ''}">
                        <div class="flex items-start gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <p class="font-bold text-slate-800 truncate">${escapeHtml(project.name)}</p>
                                    ${isActive ? '<span class="shrink-0 text-[10px] bg-safety-green text-white px-2 py-0.5 font-bold uppercase">Active</span>' : ''}
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    ${project.noabProjectNo ? `#${escapeHtml(project.noabProjectNo)}` : 'No project number'}
                                    ${project.location ? ` • ${escapeHtml(project.location)}` : ''}
                                </p>
                                <p class="text-xs text-slate-400 mt-1">
                                    ${project.contractors?.length || 0} contractors • ${project.equipment?.length || 0} equipment
                                </p>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                <button onclick="loadProject('${project.id}')" class="w-9 h-9 bg-dot-blue text-white flex items-center justify-center hover:bg-blue-800 transition-colors" title="Edit">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                                <button onclick="deleteProject('${project.id}')" class="w-9 h-9 bg-red-600 text-white flex items-center justify-center hover:bg-red-700 transition-colors" title="Delete">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateForm() {
            if (!currentProject) return;

            document.getElementById('projectName').value = currentProject.name || '';
            document.getElementById('noabProjectNo').value = currentProject.noabProjectNo || '';
            document.getElementById('cnoSolicitationNo').value = currentProject.cnoSolicitationNo || 'N/A';
            document.getElementById('location').value = currentProject.location || '';
            document.getElementById('engineer').value = currentProject.engineer || '';
            document.getElementById('primeContractor').value = currentProject.primeContractor || '';
            document.getElementById('noticeToProceed').value = currentProject.noticeToProceed || '';
            document.getElementById('reportDate').value = currentProject.reportDate || '';
            document.getElementById('contractDuration').value = currentProject.contractDuration || '';
            document.getElementById('expectedCompletion').value = currentProject.expectedCompletion || '';
            document.getElementById('defaultStartTime').value = currentProject.defaultStartTime || '06:00';
            document.getElementById('defaultEndTime').value = currentProject.defaultEndTime || '16:00';
            document.getElementById('weatherDays').value = currentProject.weatherDays || 0;
            document.getElementById('contractDayNo').value = currentProject.contractDayNo || '';

            // Handle logo preview
            const logoUploadZone = document.getElementById('logoUploadZone');
            const logoPreviewArea = document.getElementById('logoPreviewArea');
            const logoPreviewImg = document.getElementById('logoPreviewImg');

            if (currentProject.logo) {
                logoPreviewImg.src = currentProject.logo;
                logoUploadZone.classList.add('hidden');
                logoPreviewArea.classList.remove('hidden');
            } else {
                logoUploadZone.classList.remove('hidden');
                logoPreviewArea.classList.add('hidden');
                logoPreviewImg.src = '';
            }

            renderContractors();
            renderEquipment();
            updateActiveProjectBadge();
        }

        function showProjectForm() {
            document.getElementById('projectFormContainer').classList.remove('hidden');
            // Scroll to form
            document.getElementById('projectFormContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function hideProjectForm() {
            document.getElementById('projectFormContainer').classList.add('hidden');
            currentProject = null;
        }

        function updateActiveProjectBadge() {
            const badge = document.getElementById('activeProjectBadge');
            const setActiveBtn = document.getElementById('setActiveBtn');

            if (currentProject && getActiveProjectId() === currentProject.id) {
                badge.classList.remove('hidden');
                setActiveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Currently Active';
                setActiveBtn.disabled = true;
                setActiveBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                badge.classList.add('hidden');
                setActiveBtn.innerHTML = '<i class="fas fa-star mr-2"></i>Set as Active Project';
                setActiveBtn.disabled = false;
                setActiveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // ============ CONTRACTOR MANAGEMENT ============
        function renderContractors() {
            const container = document.getElementById('contractorList');

            if (!currentProject || currentProject.contractors.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center">
                        <i class="fas fa-hard-hat text-slate-300 text-2xl mb-2"></i>
                        <p class="text-sm text-slate-500">No contractors added</p>
                    </div>
                `;
                updateEquipmentContractorDropdown();
                return;
            }

            // Sort: prime contractors first
            const sortedContractors = [...currentProject.contractors].sort((a, b) => {
                if (a.type === 'prime' && b.type !== 'prime') return -1;
                if (a.type !== 'prime' && b.type === 'prime') return 1;
                return 0;
            });

            container.innerHTML = sortedContractors.map((contractor, index) => `
                <div class="p-4 flex items-start gap-3" data-contractor-id="${contractor.id}" draggable="true">
                    <div class="drag-handle w-8 h-8 bg-slate-100 flex items-center justify-center text-slate-400 shrink-0">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <p class="font-bold text-slate-800">${escapeHtml(contractor.name)}</p>
                            <span class="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 font-mono">${escapeHtml(contractor.abbreviation)}</span>
                        </div>
                        <p class="text-xs mt-1">
                            <span class="${contractor.type === 'prime' ? 'text-safety-green font-bold' : 'text-slate-500'}">${contractor.type === 'prime' ? 'PRIME' : 'Subcontractor'}</span>
                            ${contractor.trades ? ` • ${escapeHtml(contractor.trades)}` : ''}
                        </p>
                    </div>
                    <div class="flex items-center gap-1 shrink-0">
                        <button onclick="editContractor('${contractor.id}')" class="w-8 h-8 text-dot-blue hover:bg-dot-blue/10 flex items-center justify-center transition-colors" title="Edit">
                            <i class="fas fa-edit text-sm"></i>
                        </button>
                        <button onclick="deleteContractor('${contractor.id}')" class="w-8 h-8 text-red-600 hover:bg-red-50 flex items-center justify-center transition-colors" title="Delete">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Setup drag and drop
            setupContractorDragDrop();
            updateEquipmentContractorDropdown();
        }

        function showAddContractorForm() {
            document.getElementById('addContractorForm').classList.remove('hidden');
            document.getElementById('contractorFormTitle').textContent = 'Add New Contractor';
            document.getElementById('editContractorId').value = '';
            document.getElementById('contractorName').value = '';
            document.getElementById('contractorAbbr').value = '';
            document.getElementById('contractorType').value = 'subcontractor';
            document.getElementById('contractorTrades').value = '';
            document.getElementById('addContractorForm').scrollIntoView({ behavior: 'smooth' });
        }

        function hideAddContractorForm() {
            document.getElementById('addContractorForm').classList.add('hidden');
        }

        function editContractor(contractorId) {
            const contractor = currentProject.contractors.find(c => c.id === contractorId);
            if (!contractor) return;

            document.getElementById('addContractorForm').classList.remove('hidden');
            document.getElementById('contractorFormTitle').textContent = 'Edit Contractor';
            document.getElementById('editContractorId').value = contractorId;
            document.getElementById('contractorName').value = contractor.name;
            document.getElementById('contractorAbbr').value = contractor.abbreviation;
            document.getElementById('contractorType').value = contractor.type;
            document.getElementById('contractorTrades').value = contractor.trades || '';
            document.getElementById('addContractorForm').scrollIntoView({ behavior: 'smooth' });
        }

        function saveContractor() {
            const name = document.getElementById('contractorName').value.trim();
            const abbr = document.getElementById('contractorAbbr').value.trim().toUpperCase();
            const type = document.getElementById('contractorType').value;
            const trades = document.getElementById('contractorTrades').value.trim();
            const editId = document.getElementById('editContractorId').value;

            if (!name || !abbr) {
                showToast('Name and abbreviation are required', 'error');
                return;
            }

            if (editId) {
                // Edit existing
                const contractor = currentProject.contractors.find(c => c.id === editId);
                if (contractor) {
                    contractor.name = name;
                    contractor.abbreviation = abbr;
                    contractor.type = type;
                    contractor.trades = trades;
                }
            } else {
                // Add new
                currentProject.contractors.push({
                    id: generateId('contractor'),
                    name,
                    abbreviation: abbr,
                    type,
                    trades
                });
            }

            hideAddContractorForm();
            renderContractors();
            showToast(editId ? 'Contractor updated' : 'Contractor added');
        }

        function deleteContractor(contractorId) {
            showDeleteModal('Delete this contractor? Any equipment assigned to them will also be removed.', () => {
                currentProject.contractors = currentProject.contractors.filter(c => c.id !== contractorId);
                // Also remove equipment for this contractor
                currentProject.equipment = currentProject.equipment.filter(e => e.contractorId !== contractorId);
                renderContractors();
                renderEquipment();
                showToast('Contractor deleted');
            });
        }

        function setupContractorDragDrop() {
            const container = document.getElementById('contractorList');
            const items = container.querySelectorAll('[data-contractor-id]');

            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (this !== draggedItem) {
                const draggedId = draggedItem.getAttribute('data-contractor-id');
                const targetId = this.getAttribute('data-contractor-id');

                const draggedIndex = currentProject.contractors.findIndex(c => c.id === draggedId);
                const targetIndex = currentProject.contractors.findIndex(c => c.id === targetId);

                if (draggedIndex > -1 && targetIndex > -1) {
                    const [removed] = currentProject.contractors.splice(draggedIndex, 1);
                    currentProject.contractors.splice(targetIndex, 0, removed);
                    renderContractors();
                }
            }
        }

        // ============ EQUIPMENT MANAGEMENT ============
        function renderEquipment() {
            const container = document.getElementById('equipmentList');
            const addBtn = document.getElementById('addEquipmentBtn');

            if (!currentProject || currentProject.contractors.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center">
                        <i class="fas fa-truck-monster text-slate-300 text-2xl mb-2"></i>
                        <p class="text-sm text-slate-500">Add contractors first</p>
                    </div>
                `;
                addBtn.disabled = true;
                return;
            }

            addBtn.disabled = false;

            if (currentProject.equipment.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center">
                        <i class="fas fa-truck-monster text-slate-300 text-2xl mb-2"></i>
                        <p class="text-sm text-slate-500">No equipment added</p>
                    </div>
                `;
                return;
            }

            // Group equipment by contractor
            const grouped = {};
            currentProject.contractors.forEach(c => {
                grouped[c.id] = {
                    contractor: c,
                    equipment: []
                };
            });

            currentProject.equipment.forEach(eq => {
                if (grouped[eq.contractorId]) {
                    grouped[eq.contractorId].equipment.push(eq);
                }
            });

            let html = '';
            Object.values(grouped).forEach(group => {
                if (group.equipment.length === 0) return;

                html += `
                    <div class="bg-slate-50 px-4 py-2 border-b border-slate-200">
                        <p class="text-xs font-bold text-slate-600 uppercase tracking-wider">
                            <i class="fas fa-hard-hat mr-1 text-dot-orange"></i>
                            ${escapeHtml(group.contractor.name)} (${escapeHtml(group.contractor.abbreviation)})
                        </p>
                    </div>
                `;

                group.equipment.forEach(eq => {
                    html += `
                        <div class="p-4 pl-8 flex items-center gap-3">
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-slate-800">${escapeHtml(eq.type)}</p>
                                ${eq.model ? `<p class="text-xs text-slate-500">${escapeHtml(eq.model)}</p>` : ''}
                            </div>
                            <div class="flex items-center gap-1 shrink-0">
                                <button onclick="editEquipment('${eq.id}')" class="w-8 h-8 text-dot-blue hover:bg-dot-blue/10 flex items-center justify-center transition-colors" title="Edit">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                                <button onclick="deleteEquipment('${eq.id}')" class="w-8 h-8 text-red-600 hover:bg-red-50 flex items-center justify-center transition-colors" title="Delete">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html || `
                <div class="p-6 text-center">
                    <i class="fas fa-truck-monster text-slate-300 text-2xl mb-2"></i>
                    <p class="text-sm text-slate-500">No equipment added</p>
                </div>
            `;
        }

        function updateEquipmentContractorDropdown() {
            const select = document.getElementById('equipmentContractor');

            if (!currentProject || currentProject.contractors.length === 0) {
                select.innerHTML = '<option value="">No contractors available</option>';
                return;
            }

            select.innerHTML = currentProject.contractors.map(c =>
                `<option value="${c.id}">${escapeHtml(c.name)} (${escapeHtml(c.abbreviation)})</option>`
            ).join('');
        }

        function showAddEquipmentForm() {
            if (!currentProject || currentProject.contractors.length === 0) {
                showToast('Add contractors first', 'warning');
                return;
            }

            document.getElementById('addEquipmentForm').classList.remove('hidden');
            document.getElementById('equipmentFormTitle').textContent = 'Add New Equipment';
            document.getElementById('editEquipmentId').value = '';
            document.getElementById('equipmentContractor').value = currentProject.contractors[0]?.id || '';
            document.getElementById('equipmentType').value = '';
            document.getElementById('equipmentModel').value = '';
            document.getElementById('addEquipmentForm').scrollIntoView({ behavior: 'smooth' });
        }

        function hideAddEquipmentForm() {
            document.getElementById('addEquipmentForm').classList.add('hidden');
        }

        function editEquipment(equipmentId) {
            const equipment = currentProject.equipment.find(e => e.id === equipmentId);
            if (!equipment) return;

            document.getElementById('addEquipmentForm').classList.remove('hidden');
            document.getElementById('equipmentFormTitle').textContent = 'Edit Equipment';
            document.getElementById('editEquipmentId').value = equipmentId;
            document.getElementById('equipmentContractor').value = equipment.contractorId;
            document.getElementById('equipmentType').value = equipment.type;
            document.getElementById('equipmentModel').value = equipment.model || '';
            document.getElementById('addEquipmentForm').scrollIntoView({ behavior: 'smooth' });
        }

        function saveEquipment() {
            const contractorId = document.getElementById('equipmentContractor').value;
            const type = document.getElementById('equipmentType').value.trim();
            const model = document.getElementById('equipmentModel').value.trim();
            const editId = document.getElementById('editEquipmentId').value;

            if (!contractorId || !type) {
                showToast('Contractor and equipment type are required', 'error');
                return;
            }

            if (editId) {
                // Edit existing
                const equipment = currentProject.equipment.find(e => e.id === editId);
                if (equipment) {
                    equipment.contractorId = contractorId;
                    equipment.type = type;
                    equipment.model = model;
                }
            } else {
                // Add new
                currentProject.equipment.push({
                    id: generateId('equip'),
                    contractorId,
                    type,
                    model
                });
            }

            hideAddEquipmentForm();
            renderEquipment();
            showToast(editId ? 'Equipment updated' : 'Equipment added');
        }

        function deleteEquipment(equipmentId) {
            showDeleteModal('Delete this equipment?', () => {
                currentProject.equipment = currentProject.equipment.filter(e => e.id !== equipmentId);
                renderEquipment();
                showToast('Equipment deleted');
            });
        }

        // ============ MODAL ============
        function showDeleteModal(message, callback) {
            document.getElementById('deleteModalMessage').textContent = message;
            document.getElementById('deleteModal').classList.remove('hidden');
            deleteCallback = callback;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deleteCallback = null;
        }

        function confirmDelete() {
            if (deleteCallback) {
                deleteCallback();
            }
            closeDeleteModal();
        }

        // ============ UTILITIES ============
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();

            const colors = {
                success: 'bg-safety-green',
                warning: 'bg-dot-orange',
                error: 'bg-red-600'
            };

            const icons = {
                success: 'fa-check',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times-circle'
            };

            const toast = document.createElement('div');
            toast.className = `toast-msg fixed bottom-24 left-1/2 -translate-x-1/2 ${colors[type] || colors.success} text-white px-6 py-3 font-bold text-sm shadow-lg z-50 flex items-center gap-2 uppercase`;
            toast.innerHTML = `<i class="fas ${icons[type] || icons.success}"></i>${escapeHtml(message)}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============ FILE IMPORT FUNCTIONS ============
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-active'), false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            const validExtensions = ['.pdf', '.docx'];
            const newFiles = Array.from(files).filter(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (!validExtensions.includes(ext)) {
                    showToast(`Invalid file type: ${file.name}. Only PDF and DOCX allowed.`, 'error');
                    return false;
                }
                // Check for duplicates
                if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    showToast(`File already added: ${file.name}`, 'warning');
                    return false;
                }
                return true;
            });

            selectedFiles = [...selectedFiles, ...newFiles];
            renderFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (ext === 'pdf') {
                return '<i class="fas fa-file-pdf text-red-500"></i>';
            } else if (ext === 'docx' || ext === 'doc') {
                return '<i class="fas fa-file-word text-blue-500"></i>';
            }
            return '<i class="fas fa-file text-slate-400"></i>';
        }

        function renderFileList() {
            const listContainer = document.getElementById('selectedFilesList');
            const filesContainer = document.getElementById('filesContainer');
            const extractBtn = document.getElementById('extractBtn');

            if (selectedFiles.length === 0) {
                listContainer.classList.add('hidden');
                extractBtn.classList.add('hidden');
                return;
            }

            listContainer.classList.remove('hidden');
            extractBtn.classList.remove('hidden');

            filesContainer.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-item flex items-center gap-3 bg-white p-3 rounded border border-slate-200">
                    <span class="text-lg">${getFileIcon(file.name)}</span>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-800 truncate">${escapeHtml(file.name)}</p>
                        <p class="text-xs text-slate-500">${formatFileSize(file.size)}</p>
                    </div>
                    <button onclick="removeFile(${index})" class="w-8 h-8 text-red-500 hover:bg-red-50 flex items-center justify-center rounded transition-colors" title="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFileList();
        }

        function clearSelectedFiles() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            renderFileList();
        }

        // ============ LOGO UPLOAD FUNCTIONS ============
        function handleLogoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate it's an image
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showToast('Please select a valid image file (PNG, JPG, SVG, GIF)', 'error');
                event.target.value = '';
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                currentProject.logo = base64Data;

                // Show preview
                const logoUploadZone = document.getElementById('logoUploadZone');
                const logoPreviewArea = document.getElementById('logoPreviewArea');
                const logoPreviewImg = document.getElementById('logoPreviewImg');

                logoPreviewImg.src = base64Data;
                logoUploadZone.classList.add('hidden');
                logoPreviewArea.classList.remove('hidden');

                showToast('Logo uploaded');
            };
            reader.onerror = function() {
                showToast('Error reading file', 'error');
            };
            reader.readAsDataURL(file);

            // Clear the input so the same file can be selected again
            event.target.value = '';
        }

        function removeLogo() {
            if (!currentProject) return;

            currentProject.logo = null;

            const logoUploadZone = document.getElementById('logoUploadZone');
            const logoPreviewArea = document.getElementById('logoPreviewArea');
            const logoPreviewImg = document.getElementById('logoPreviewImg');

            logoPreviewImg.src = '';
            logoPreviewArea.classList.add('hidden');
            logoUploadZone.classList.remove('hidden');

            // Clear the file input
            document.getElementById('logoInput').value = '';

            showToast('Logo removed');
        }

        function setupLogoDropZone() {
            const logoDropZone = document.getElementById('logoUploadZone');
            if (!logoDropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                logoDropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                logoDropZone.addEventListener(eventName, () => logoDropZone.classList.add('drag-active'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                logoDropZone.addEventListener(eventName, () => logoDropZone.classList.remove('drag-active'), false);
            });

            logoDropZone.addEventListener('drop', handleLogoDrop, false);
        }

        function handleLogoDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                // Create a fake event to reuse handleLogoSelect
                const fakeEvent = {
                    target: {
                        files: files,
                        value: ''
                    }
                };
                handleLogoSelect(fakeEvent);
            }
        }

        // ============ EXTRACTION FUNCTIONS ============
        async function extractProjectData() {
            if (selectedFiles.length === 0) {
                showToast('Please select at least one file', 'error');
                return;
            }

            // Hide any previous banners
            hideExtractionBanners();

            // Show loading state
            setExtractButtonLoading(true);

            try {
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('documents', file);
                });

                const response = await fetch(EXTRACT_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success && result.data) {
                    // Populate form with extracted data
                    populateFormWithExtractedData(result.data);

                    // Show success banner
                    document.getElementById('extractionSuccessBanner').classList.remove('hidden');

                    // Show extraction notes if any
                    if (result.extractionNotes && result.extractionNotes.length > 0) {
                        showExtractionNotes(result.extractionNotes);
                    }

                    // Clear selected files
                    clearSelectedFiles();

                    // Scroll to top of form
                    document.getElementById('projectFormContainer').scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Show error banner
                    const errorMsg = result.error || 'Failed to extract project data. Please try again.';
                    document.getElementById('extractionErrorMessage').textContent = errorMsg;
                    document.getElementById('extractionErrorBanner').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Extraction error:', error);
                document.getElementById('extractionErrorMessage').textContent = 'Network error. Please check your connection and try again.';
                document.getElementById('extractionErrorBanner').classList.remove('hidden');
            } finally {
                setExtractButtonLoading(false);
            }
        }

        function setExtractButtonLoading(isLoading) {
            const btn = document.getElementById('extractBtn');
            const icon = document.getElementById('extractBtnIcon');
            const text = document.getElementById('extractBtnText');

            if (isLoading) {
                btn.disabled = true;
                icon.className = 'fas fa-spinner spin-animation';
                text.textContent = 'Extracting...';
            } else {
                btn.disabled = false;
                icon.className = 'fas fa-magic';
                text.textContent = 'Extract Project Data';
            }
        }

        function hideExtractionBanners() {
            document.getElementById('extractionSuccessBanner').classList.add('hidden');
            document.getElementById('extractionErrorBanner').classList.add('hidden');
        }

        function showExtractionNotes(notes) {
            const section = document.getElementById('extractionNotesSection');
            const list = document.getElementById('extractionNotesList');

            list.innerHTML = notes.map(note => `<li>${escapeHtml(note)}</li>`).join('');
            section.classList.remove('hidden');
        }

        function toggleExtractionNotes() {
            const content = document.getElementById('extractionNotesContent');
            const icon = document.getElementById('notesToggleIcon');

            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        // ============ FORM POPULATION FROM EXTRACTED DATA ============
        function populateFormWithExtractedData(data) {
            if (!currentProject) return;

            // Define field mappings: formFieldId -> dataFieldPath
            const fieldMappings = {
                'projectName': 'projectName',
                'noabProjectNo': 'noabProjectNo',
                'cnoSolicitationNo': 'cnoSolicitationNo',
                'location': 'location',
                'engineer': 'engineer',
                'primeContractor': 'primeContractor',
                'noticeToProceed': 'noticeToProceed',
                'reportDate': 'reportDate',
                'contractDuration': 'contractDuration',
                'expectedCompletion': 'expectedCompletion',
                'defaultStartTime': 'defaultStartTime',
                'defaultEndTime': 'defaultEndTime',
                'weatherDays': 'weatherDays',
                'contractDayNo': 'contractDayNo'
            };

            // Track missing fields
            const missingFields = [];

            // Populate each field
            Object.entries(fieldMappings).forEach(([fieldId, dataKey]) => {
                const input = document.getElementById(fieldId);
                if (!input) return;

                const value = data[dataKey];

                // Clear any previous missing field indicators
                clearMissingFieldIndicator(input);

                if (value === null || value === undefined || value === '') {
                    // Mark as missing
                    markFieldAsMissing(input);
                    missingFields.push(fieldId);
                    input.value = '';
                } else {
                    input.value = value;
                    // Update currentProject
                    currentProject[dataKey] = value;
                }
            });

            // Process contractors
            if (data.contractors && Array.isArray(data.contractors)) {
                const contractorIdMap = {}; // Map original names to new IDs
                currentProject.contractors = data.contractors.map(contractor => {
                    const id = generateId('contractor');
                    contractorIdMap[contractor.name] = id;
                    return {
                        id: id,
                        name: contractor.name || '',
                        abbreviation: contractor.abbreviation || generateAbbreviation(contractor.name),
                        type: contractor.type || 'subcontractor',
                        trades: contractor.trades || ''
                    };
                });

                // Process equipment
                if (data.equipment && Array.isArray(data.equipment)) {
                    currentProject.equipment = data.equipment.map(equip => {
                        // Try to match contractor by name
                        let contractorId = contractorIdMap[equip.contractorName];

                        // If not found by exact name, try to find by partial match
                        if (!contractorId && equip.contractorName) {
                            const matchedContractor = currentProject.contractors.find(c =>
                                c.name.toLowerCase().includes(equip.contractorName.toLowerCase()) ||
                                equip.contractorName.toLowerCase().includes(c.name.toLowerCase())
                            );
                            if (matchedContractor) {
                                contractorId = matchedContractor.id;
                            }
                        }

                        // If still not found, use first contractor as fallback
                        if (!contractorId && currentProject.contractors.length > 0) {
                            contractorId = currentProject.contractors[0].id;
                        }

                        return {
                            id: generateId('equip'),
                            contractorId: contractorId || '',
                            type: equip.type || '',
                            model: equip.model || ''
                        };
                    }).filter(eq => eq.contractorId); // Only keep equipment with valid contractor
                }

                renderContractors();
                renderEquipment();
            }

            // Setup input listeners to clear missing indicators when user types
            setupMissingFieldListeners();
        }

        function generateAbbreviation(name) {
            if (!name) return '';
            // Take first letter of each word, max 4 characters
            const words = name.split(/\s+/);
            if (words.length === 1) {
                return name.substring(0, 3).toUpperCase();
            }
            return words.map(w => w[0]).join('').substring(0, 4).toUpperCase();
        }

        function markFieldAsMissing(input) {
            input.classList.add('missing-field');

            // Create missing indicator if it doesn't exist
            const parent = input.parentElement;
            let indicator = parent.querySelector('.missing-indicator');
            if (!indicator) {
                indicator = document.createElement('p');
                indicator.className = 'missing-indicator mt-1';
                indicator.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>Missing - please fill in';
                parent.appendChild(indicator);
            }
        }

        function clearMissingFieldIndicator(input) {
            input.classList.remove('missing-field');
            const parent = input.parentElement;
            const indicator = parent.querySelector('.missing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function setupMissingFieldListeners() {
            const inputs = document.querySelectorAll('.missing-field');
            inputs.forEach(input => {
                // Remove existing listener if any to avoid duplicates
                input.removeEventListener('input', handleMissingFieldInput);
                input.addEventListener('input', handleMissingFieldInput);
            });
        }

        function handleMissingFieldInput(e) {
            const input = e.target;
            if (input.value.trim() !== '') {
                clearMissingFieldIndicator(input);
            }
        }

        // Initialize drop zones when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            renderSavedProjects();
            setupDropZone();
            setupLogoDropZone();
        });
    </script>

    <!-- PWA Navigation Fix -->
    <script>
        (function() {
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a');
                    if (link && link.href && link.href.startsWith(window.location.origin)) {
                        e.preventDefault();
                        window.location.href = link.href;
                    }
                }, true);
            }
        })();
    </script>

    <!-- PWA Service Worker Registration & Offline Banner -->
    <div id="offline-banner" class="fixed top-0 left-0 right-0 bg-yellow-500 text-yellow-900 text-center py-2 px-4 font-bold text-sm z-[9999] transform -translate-y-full transition-transform duration-300" style="display: none;">
        <i class="fas fa-wifi-slash mr-2"></i>You are offline - Some features may be unavailable
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registered:', registration.scope);
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[PWA] New version available');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });
            });
        }

        const offlineBanner = document.getElementById('offline-banner');

        function showOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.display = 'block';
                setTimeout(() => {
                    offlineBanner.style.transform = 'translateY(0)';
                }, 10);
            }
        }

        function hideOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.transform = 'translateY(-100%)';
                setTimeout(() => {
                    offlineBanner.style.display = 'none';
                }, 300);
            }
        }

        window.addEventListener('online', hideOfflineBanner);
        window.addEventListener('offline', showOfflineBanner);

        if (!navigator.onLine) {
            showOfflineBanner();
        }
    </script>
</body>
</html>
