<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Daily Field Report System</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
    <meta name="theme-color" content="#0a1628">

    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FieldVoice">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dot-navy': '#0a1628',
                        'dot-blue': '#1e3a5f',
                        'dot-slate': '#334155',
                        'dot-orange': '#ea580c',
                        'dot-yellow': '#f59e0b',
                        'safety-green': '#16a34a',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        .header-stripe {
            background: repeating-linear-gradient(
                -45deg,
                #f59e0b,
                #f59e0b 10px,
                #0a1628 10px,
                #0a1628 20px
            );
            height: 4px;
            padding-top: env(safe-area-inset-top);
        }
        .official-badge {
            border: 2px solid #1e3a5f;
            position: relative;
        }
        .official-badge::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border: 1px solid #1e3a5f;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <!-- Safety Stripe Header -->
    <div class="header-stripe"></div>

    <!-- Permissions Banner -->
    <div id="permissionsBanner" class="hidden">
        <div class="bg-dot-orange text-white">
            <div class="max-w-lg mx-auto px-4 py-3 flex items-center gap-3">
                <i class="fas fa-exclamation-triangle"></i>
                <p class="flex-1 text-sm font-medium">System permissions required for full functionality</p>
                <a href="permissions.html" class="px-4 py-1.5 bg-white text-dot-orange font-bold text-xs rounded">
                    ENABLE
                </a>
                <button onclick="dismissPermissionsBanner()" class="text-white/80 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Submitted Success Banner -->
    <div id="submittedBanner" class="hidden bg-safety-green text-white">
        <div class="max-w-lg mx-auto px-4 py-3 flex items-center gap-3">
            <i class="fas fa-check-circle"></i>
            <p class="flex-1 text-sm font-medium">Report submitted successfully</p>
            <button onclick="dismissSubmittedBanner()" class="text-white/80 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div id="app" class="max-w-lg mx-auto min-h-screen flex flex-col">

        <!-- HEADER -->
        <header class="bg-dot-navy text-white p-4">
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fas fa-clipboard-check text-dot-yellow"></i>
                        <span class="text-[10px] font-bold tracking-widest text-dot-yellow">DAILY FIELD REPORT</span>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight">
                        RPR INSPECTION SYSTEM
                    </h1>
                    <p id="currentDate" class="text-xs text-slate-400 mt-1"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openProjectConfig()" class="w-10 h-10 border border-slate-600 flex items-center justify-center text-slate-400 hover:bg-slate-800 hover:text-white transition-colors" title="Manage Projects">
                        <i class="fas fa-folder-open"></i>
                    </button>
                    <button onclick="openSettings()" class="w-10 h-10 border border-slate-600 flex items-center justify-center text-slate-400 hover:bg-slate-800 hover:text-white transition-colors" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- WEATHER STATUS CARD -->
        <section class="px-4 mb-4">
            <div class="bg-white border-l-4 border-dot-blue p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-cloud-sun text-dot-blue"></i>
                        <span class="text-xs font-bold text-dot-blue uppercase tracking-wider">Weather Conditions</span>
                    </div>
                    <button id="syncWeatherBtn" onclick="syncWeather()" class="text-xs text-dot-blue font-bold flex items-center gap-1 hover:text-dot-navy transition-colors">
                        <i id="syncIcon" class="fas fa-sync-alt text-[10px]"></i>
                        SYNC
                    </button>
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <div class="text-center">
                        <i id="weatherIcon" class="fas fa-sun text-2xl text-dot-yellow mb-1"></i>
                        <p id="weatherCondition" class="text-xs font-medium text-slate-600">Loading...</p>
                    </div>
                    <div class="text-center border-l border-slate-200">
                        <p class="text-lg font-bold text-slate-800" id="weatherTempHigh">--°</p>
                        <p class="text-[10px] text-slate-400 uppercase">High</p>
                    </div>
                    <div class="text-center border-l border-slate-200">
                        <p class="text-lg font-bold text-slate-800" id="weatherTempLow">--°</p>
                        <p class="text-[10px] text-slate-400 uppercase">Low</p>
                    </div>
                    <div class="text-center border-l border-slate-200">
                        <p class="text-lg font-bold text-slate-800" id="weatherPrecipVal">0.00"</p>
                        <p class="text-[10px] text-slate-400 uppercase">Precip</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ACTIVE PROJECT CARD -->
        <section id="activeProjectSection" class="px-4 mb-4">
            <!-- Content rendered by updateActiveProjectCard() -->
        </section>

        <!-- DYNAMIC STATUS/ACTION CARD -->
        <section id="reportStatusSection" class="px-4 mb-4">
            <!-- Content rendered by updateReportStatus() -->
        </section>

        <!-- REPORT ARCHIVES -->
        <section class="px-4 mb-4">
            <a href="archives.html" class="block bg-white border-l-4 border-dot-slate p-4 hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-dot-slate flex items-center justify-center shrink-0">
                        <i class="fas fa-archive text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-xs font-bold text-dot-slate uppercase tracking-wider">Report Archives</p>
                        <p class="text-sm text-slate-600">View past reports and history</p>
                    </div>
                    <i class="fas fa-chevron-right text-slate-400"></i>
                </div>
            </a>
        </section>

        <!-- DRAFTS & PENDING REPORTS -->
        <section id="draftsSection" class="px-4 mb-4 flex-1 hidden">
            <a href="drafts.html" class="block bg-white border-l-4 border-dot-orange p-4 hover:bg-orange-50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-dot-orange flex items-center justify-center shrink-0 relative">
                        <i class="fas fa-clock text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-xs font-bold text-dot-orange uppercase tracking-wider">Drafts & Pending</p>
                        <p id="draftsDescription" class="text-sm text-slate-600">Reports waiting to sync</p>
                    </div>
                    <span id="draftsBadge" class="bg-dot-orange text-white text-xs font-bold px-2 py-1 min-w-[24px] text-center">0</span>
                    <i class="fas fa-chevron-right text-dot-orange"></i>
                </div>
            </a>
        </section>

        <!-- FOOTER -->
        <footer class="bg-dot-navy text-center py-3">
            <p class="text-[10px] text-slate-500 uppercase tracking-widest">
                <i class="fas fa-shield-alt mr-1"></i>
                DOT Compliant Field Documentation System
            </p>
            <div class="text-center text-gray-600 text-xs mt-2">
                <a href="admin-debug.html" class="hover:text-gray-400">Debug Tools</a>
            </div>
        </footer>
    </div>

    <script>
        // ============ SUPABASE CONFIGURATION ============
        const SUPABASE_URL = 'https://ruzadotbgkjhgwkvotlz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1emFkb3RiZ2tqaGd3a3ZvdGx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyMDY1MzQsImV4cCI6MjA4NDc4MjUzNH0.RiW5IFA_i8Fj4QIc1Swe1ERx3rEwPyOnQ5tOicAFXI0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============ STATE ============
        let projectsCache = [];
        let activeProjectCache = null;
        let todayReportCache = null;

        const ACTIVE_PROJECT_KEY = 'fvp_active_project'; // Keep in localStorage (device-specific)

        // ============ FIELD MAPPING UTILITIES ============
        function fromSupabaseProject(row) {
            return {
                id: row.id,
                name: row.project_name || '',
                noabProjectNo: row.noab_project_no || '',
                cnoSolicitationNo: row.cno_solicitation_no || 'N/A',
                location: row.location || '',
                engineer: row.engineer || '',
                primeContractor: row.prime_contractor || '',
                noticeToProceed: row.notice_to_proceed || '',
                contractDuration: row.contract_duration || '',
                weatherDays: row.weather_days || 0,
                expectedCompletion: row.expected_completion || '',
                defaultStartTime: row.default_start_time || '06:00',
                defaultEndTime: row.default_end_time || '16:00',
                logo: row.logo || null,
                status: row.status || 'active'
            };
        }

        // ============ PROJECT MANAGEMENT ============
        async function loadProjects() {
            try {
                const { data, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .order('project_name', { ascending: true });

                if (error) {
                    console.error('[SUPABASE] Error loading projects:', error);
                    return [];
                }

                projectsCache = data.map(fromSupabaseProject);
                console.log('[SUPABASE] Loaded projects:', projectsCache.length);
                return projectsCache;
            } catch (e) {
                console.error('[SUPABASE] Failed to load projects:', e);
                return [];
            }
        }

        function getProjects() {
            return projectsCache;
        }

        async function loadActiveProject() {
            const activeId = localStorage.getItem(ACTIVE_PROJECT_KEY);
            if (!activeId) {
                activeProjectCache = null;
                return null;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('id', activeId)
                    .single();

                if (error) {
                    console.error('[SUPABASE] Error loading active project:', error);
                    activeProjectCache = null;
                    return null;
                }

                activeProjectCache = fromSupabaseProject(data);
                console.log('[SUPABASE] Loaded active project:', activeProjectCache.name);
                return activeProjectCache;
            } catch (e) {
                console.error('[SUPABASE] Failed to load active project:', e);
                activeProjectCache = null;
                return null;
            }
        }

        function getActiveProject() {
            return activeProjectCache;
        }

        function openProjectConfig() {
            window.location.href = 'project-config.html';
        }

        function updateActiveProjectCard() {
            const section = document.getElementById('activeProjectSection');
            const project = getActiveProject();

            if (project) {
                section.innerHTML = `
                    <div class="bg-white border-l-4 border-safety-green p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 min-w-0 flex-1">
                                <div class="w-10 h-10 bg-safety-green flex items-center justify-center shrink-0">
                                    <i class="fas fa-building text-white"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-[10px] font-bold text-safety-green uppercase tracking-wider">Active Project</p>
                                    <p class="font-bold text-slate-800 truncate">${escapeHtml(project.name)}</p>
                                    ${project.noabProjectNo ? `<p class="text-xs text-slate-500">#${escapeHtml(project.noabProjectNo)}</p>` : ''}
                                </div>
                            </div>
                            <a href="project-config.html" class="text-dot-blue hover:text-dot-navy transition-colors shrink-0 ml-2" title="Change Project">
                                <i class="fas fa-exchange-alt"></i>
                            </a>
                        </div>
                    </div>
                `;
            } else {
                section.innerHTML = `
                    <a href="project-config.html" class="block bg-white border-2 border-dashed border-dot-orange p-4 hover:bg-orange-50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-dot-orange/10 border-2 border-dot-orange flex items-center justify-center shrink-0">
                                <i class="fas fa-exclamation text-dot-orange"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-xs font-bold text-dot-orange uppercase tracking-wider">No Project Selected</p>
                                <p class="text-sm text-slate-600">Tap to configure a project</p>
                            </div>
                            <i class="fas fa-chevron-right text-dot-orange"></i>
                        </div>
                    </a>
                `;
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function beginDailyReport() {
            showProjectPickerModal();
        }

        function continueDailyReport() {
            window.location.href = 'quick-interview.html';
        }

        // ============ PROJECT PICKER MODAL ============
        async function showProjectPickerModal() {
            const modal = document.getElementById('projectPickerModal');
            const listContainer = document.getElementById('projectPickerList');

            // Show loading state
            listContainer.innerHTML = `
                <div class="p-8 text-center">
                    <i class="fas fa-spinner fa-spin text-slate-400 text-2xl mb-4"></i>
                    <p class="text-sm text-slate-500">Loading projects...</p>
                </div>
            `;
            modal.classList.remove('hidden');

            // Load fresh projects from Supabase
            await loadProjects();
            const projects = getProjects();
            const activeId = localStorage.getItem(ACTIVE_PROJECT_KEY);

            if (projects.length === 0) {
                // No projects configured
                listContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <div class="w-16 h-16 bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-folder-open text-slate-400 text-2xl"></i>
                        </div>
                        <p class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">No Projects Configured</p>
                        <p class="text-sm text-slate-500 mb-6">Create a project to start generating daily reports</p>
                        <button onclick="goToProjectSetup()" class="w-full p-4 bg-safety-green hover:bg-green-700 text-white font-bold uppercase transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-plus"></i>
                            Create Project
                        </button>
                    </div>
                `;
            } else {
                // Fetch today's report status for all projects to check which are refined
                const todayStr = getTodayDateStr();
                const projectIds = projects.map(p => p.id);

                let refinedProjectIds = new Set();
                try {
                    const { data: reports } = await supabaseClient
                        .from('reports')
                        .select('project_id, status')
                        .in('project_id', projectIds)
                        .eq('report_date', todayStr);

                    if (reports) {
                        // Note: 'finalized' is reserved for future admin approval workflow
                        reports.forEach(r => {
                            if (['refined', 'submitted', 'finalized'].includes(r.status)) {
                                refinedProjectIds.add(r.project_id);
                            }
                        });
                    }
                } catch (e) {
                    console.error('Failed to check project report statuses:', e);
                }

                // Render project list
                listContainer.innerHTML = projects.map(project => {
                    const isActive = project.id === activeId;
                    const isRefined = refinedProjectIds.has(project.id);

                    if (isRefined) {
                        // Project has a refined report - show disabled state
                        return `
                            <div class="w-full p-4 text-left border-b border-slate-200 last:border-b-0 bg-slate-50 opacity-60 cursor-not-allowed">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-slate-400 flex items-center justify-center shrink-0">
                                        <i class="fas fa-lock text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <p class="font-bold text-slate-600 truncate">${escapeHtml(project.name)}</p>
                                            <span class="shrink-0 text-[10px] bg-slate-400 text-white px-2 py-0.5 font-bold uppercase">In Review</span>
                                        </div>
                                        <p class="text-xs text-slate-500 truncate mt-0.5">
                                            ${project.noabProjectNo ? `#${escapeHtml(project.noabProjectNo)}` : ''}
                                            ${project.noabProjectNo && project.location ? ' • ' : ''}
                                            ${project.location ? escapeHtml(project.location) : ''}
                                            ${!project.noabProjectNo && !project.location ? 'No details' : ''}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <button onclick="selectProjectAndProceed('${project.id}')" class="w-full p-4 text-left hover:bg-slate-50 transition-colors border-b border-slate-200 last:border-b-0 ${isActive ? 'bg-safety-green/5' : ''}">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 ${isActive ? 'bg-safety-green' : 'bg-dot-blue'} flex items-center justify-center shrink-0">
                                    <i class="fas ${isActive ? 'fa-check' : 'fa-building'} text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <p class="font-bold text-slate-800 truncate">${escapeHtml(project.name)}</p>
                                        ${isActive ? '<span class="shrink-0 text-[10px] bg-safety-green text-white px-2 py-0.5 font-bold uppercase">Active</span>' : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 truncate mt-0.5">
                                        ${project.noabProjectNo ? `#${escapeHtml(project.noabProjectNo)}` : ''}
                                        ${project.noabProjectNo && project.location ? ' • ' : ''}
                                        ${project.location ? escapeHtml(project.location) : ''}
                                        ${!project.noabProjectNo && !project.location ? 'No details' : ''}
                                    </p>
                                </div>
                                <i class="fas fa-chevron-right text-slate-400 shrink-0"></i>
                            </div>
                        </button>
                    `;
                }).join('');
            }
        }

        function closeProjectPickerModal() {
            document.getElementById('projectPickerModal').classList.add('hidden');
        }

        async function selectProjectAndProceed(projectId) {
            // Set as active project in localStorage
            localStorage.setItem(ACTIVE_PROJECT_KEY, projectId);

            // Update cache
            await loadActiveProject();

            // Update the active project card on dashboard (visible when they return)
            updateActiveProjectCard();

            // Close modal and proceed
            closeProjectPickerModal();
            window.location.href = 'quick-interview.html';
        }

        function goToProjectSetup() {
            closeProjectPickerModal();
            window.location.href = 'project-config.html';
        }

        // ============ REPORT LOADING ============
        function getTodayDateStr() {
            return new Date().toISOString().split('T')[0];
        }

        function getYesterdayDateStr() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return yesterday.toISOString().split('T')[0];
        }

        async function loadTodayReport() {
            const activeProject = getActiveProject();
            if (!activeProject) {
                todayReportCache = null;
                return null;
            }

            const todayStr = getTodayDateStr();

            try {
                const { data, error } = await supabaseClient
                    .from('reports')
                    .select('id, project_id, report_date, status, created_at, updated_at')
                    .eq('project_id', activeProject.id)
                    .eq('report_date', todayStr)
                    .single();

                if (error) {
                    // No report found is expected
                    if (error.code !== 'PGRST116') {
                        console.error('[SUPABASE] Error loading today report:', error);
                    }
                    todayReportCache = null;
                    return null;
                }

                // If report is submitted, return null (so dashboard shows "no report" state)
                if (data.status === 'submitted') {
                    todayReportCache = { ...data, submitted: true };
                    return null;
                }

                // Load additional metadata for progress calculation
                const [rawCaptureResult, activitiesResult] = await Promise.all([
                    supabaseClient.from('report_raw_capture').select('transcript, guided_notes').eq('report_id', data.id).single(),
                    supabaseClient.from('report_contractor_work').select('id').eq('report_id', data.id)
                ]);

                todayReportCache = {
                    id: data.id,
                    projectId: data.project_id,
                    date: data.report_date,
                    status: data.status,
                    submitted: false,
                    meta: {
                        interviewCompleted: data.status === 'draft' || data.status === 'pending_refine' || data.status === 'refined',
                        status: data.status
                    },
                    hasActivities: activitiesResult.data && activitiesResult.data.length > 0,
                    hasRawCapture: rawCaptureResult.data !== null
                };

                console.log('[SUPABASE] Loaded today report:', todayReportCache.id);
                return todayReportCache;
            } catch (e) {
                console.error('[SUPABASE] Failed to load today report:', e);
                todayReportCache = null;
                return null;
            }
        }

        function getReport() {
            // Return cached report (non-submitted only)
            if (todayReportCache && !todayReportCache.submitted) {
                return todayReportCache;
            }
            return null;
        }

        async function hasSubmittedReportToday() {
            const activeProject = getActiveProject();
            if (!activeProject) return false;

            const todayStr = getTodayDateStr();

            try {
                const { data, error } = await supabaseClient
                    .from('reports')
                    .select('id, status')
                    .eq('project_id', activeProject.id)
                    .eq('report_date', todayStr)
                    .eq('status', 'submitted')
                    .single();

                if (error) {
                    return false;
                }

                return data !== null;
            } catch (e) {
                return false;
            }
        }

        // Note: saveReport is no longer needed on index.html - saving happens on report.html
        // Weather data updates are also handled on report.html

        // ============ WEATHER ============
        async function syncWeather() {
            const syncIcon = document.getElementById('syncIcon');
            const syncBtn = document.getElementById('syncWeatherBtn');
            syncIcon.classList.add('fa-spin');

            try {
                // Check if offline first
                if (!navigator.onLine) {
                    document.getElementById('weatherCondition').textContent = 'Offline';
                    document.getElementById('weatherIcon').className = 'fas fa-wifi-slash text-2xl text-yellow-500 mb-1';
                    syncIcon.classList.remove('fa-spin');
                    return;
                }

                if (!navigator.geolocation) {
                    throw { code: -1, message: 'Geolocation not supported' };
                }

                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                    );
                });

                localStorage.setItem('fvp_loc_granted', 'true');

                const { latitude, longitude } = position.coords;
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto&temperature_unit=fahrenheit&precipitation_unit=inch`
                );

                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }

                const data = await response.json();

                const weatherCodes = {
                    0: { text: 'Clear', icon: 'fa-sun', color: 'text-dot-yellow' },
                    1: { text: 'Mostly Clear', icon: 'fa-sun', color: 'text-dot-yellow' },
                    2: { text: 'Partly Cloudy', icon: 'fa-cloud-sun', color: 'text-slate-500' },
                    3: { text: 'Overcast', icon: 'fa-cloud', color: 'text-slate-500' },
                    45: { text: 'Fog', icon: 'fa-smog', color: 'text-slate-400' },
                    48: { text: 'Fog', icon: 'fa-smog', color: 'text-slate-400' },
                    51: { text: 'Light Drizzle', icon: 'fa-cloud-rain', color: 'text-dot-blue' },
                    53: { text: 'Drizzle', icon: 'fa-cloud-rain', color: 'text-dot-blue' },
                    55: { text: 'Heavy Drizzle', icon: 'fa-cloud-showers-heavy', color: 'text-dot-blue' },
                    61: { text: 'Light Rain', icon: 'fa-cloud-rain', color: 'text-dot-blue' },
                    63: { text: 'Rain', icon: 'fa-cloud-showers-heavy', color: 'text-dot-blue' },
                    65: { text: 'Heavy Rain', icon: 'fa-cloud-showers-heavy', color: 'text-blue-600' },
                    80: { text: 'Showers', icon: 'fa-cloud-showers-heavy', color: 'text-dot-blue' },
                    95: { text: 'Thunderstorm', icon: 'fa-bolt', color: 'text-dot-orange' }
                };

                const weatherInfo = weatherCodes[data.current_weather.weathercode] || { text: 'Cloudy', icon: 'fa-cloud', color: 'text-slate-400' };
                const highTemp = Math.round(data.daily.temperature_2m_max[0]);
                const lowTemp = Math.round(data.daily.temperature_2m_min[0]);
                const precip = data.daily.precipitation_sum[0].toFixed(2);

                // Update UI
                document.getElementById('weatherCondition').textContent = weatherInfo.text;
                document.getElementById('weatherTempHigh').textContent = `${highTemp}°`;
                document.getElementById('weatherTempLow').textContent = `${lowTemp}°`;
                document.getElementById('weatherPrecipVal').textContent = `${precip}"`;
                document.getElementById('weatherIcon').className = `fas ${weatherInfo.icon} text-2xl ${weatherInfo.color} mb-1`;
            } catch (error) {
                console.error('Weather sync failed:', error);
                if (error.code === 1) {
                    localStorage.removeItem('fvp_loc_granted');
                    document.getElementById('weatherCondition').textContent = 'Location blocked';
                    document.getElementById('weatherIcon').className = 'fas fa-location-crosshairs text-2xl text-red-500 mb-1';
                } else if (error.code === 2) {
                    document.getElementById('weatherCondition').textContent = 'GPS unavailable';
                } else if (error.code === 3) {
                    document.getElementById('weatherCondition').textContent = 'Timeout';
                } else {
                    document.getElementById('weatherCondition').textContent = 'Sync failed';
                }
            }

            const updatedSyncIcon = document.getElementById('syncIcon');
            if (updatedSyncIcon) {
                updatedSyncIcon.classList.remove('fa-spin');
            }
        }

        // ============ UI UPDATES ============
        function updateReportStatus() {
            const report = getReport();
            const statusSection = document.getElementById('reportStatusSection');

            // Note: getReport() returns null for submitted reports, so they fall into the "no report" case
            if (!report) {
                // STATE: No Report Started
                statusSection.innerHTML = `
                    <div class="bg-white border-2 border-slate-200 p-6">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-slate-100 border-2 border-slate-300 flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-clipboard text-slate-400 text-2xl"></i>
                            </div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">No Report Started</p>
                            <p class="text-sm text-slate-500 mb-4">Begin documentation to create today's report</p>
                            <button onclick="beginDailyReport()" class="block w-full bg-dot-navy hover:bg-dot-blue text-white p-4 transition-colors">
                                <div class="flex items-center justify-center gap-3">
                                    <i class="fas fa-plus text-dot-yellow"></i>
                                    <span class="font-bold uppercase tracking-wide">Begin Daily Report</span>
                                </div>
                            </button>
                        </div>
                    </div>
                `;

            } else if (report.meta?.interviewCompleted && !report.submitted) {
                // STATE: Interview Complete, Ready for Review & Submit
                const isPending = report.meta?.status === 'pending_refine';
                const isRefined = ['refined', 'submitted', 'finalized'].includes(report.meta?.status);
                const statusColor = isPending ? 'border-dot-yellow' : (isRefined ? 'border-safety-green' : 'border-dot-blue');
                const iconBg = isPending ? 'bg-dot-yellow' : (isRefined ? 'bg-safety-green' : 'bg-dot-blue');
                const labelColor = isPending ? 'text-dot-yellow' : (isRefined ? 'text-safety-green' : 'text-dot-blue');
                const statusLabel = isPending ? 'Processing Pending' : (isRefined ? 'AI Refined' : 'Ready for Review');
                const statusDesc = isPending ? 'AI processing will complete when online' : 'Review and submit your report';

                // Only show "continue editing" link for draft and pending_refine status, NOT for refined reports
                const showEditLink = !isRefined;

                statusSection.innerHTML = `
                    <div class="bg-white border-2 ${statusColor} p-6">
                        <div class="text-center">
                            <div class="w-16 h-16 ${iconBg} flex items-center justify-center mx-auto mb-4">
                                <i class="fas ${isPending ? 'fa-clock' : 'fa-clipboard-check'} text-white text-2xl"></i>
                            </div>
                            <p class="text-xs font-bold ${labelColor} uppercase tracking-wider mb-1">${statusLabel}</p>
                            <p class="text-sm text-slate-700 font-medium mb-1">Report Complete</p>
                            <p class="text-xs text-slate-500 mb-4">${statusDesc}</p>
                            <a href="report.html" class="block w-full bg-safety-green hover:bg-green-700 text-white p-4 transition-colors ${showEditLink ? 'mb-3' : ''}">
                                <div class="flex items-center justify-center gap-3">
                                    <i class="fas fa-check-circle text-white"></i>
                                    <span class="font-bold uppercase tracking-wide">Review & Submit</span>
                                </div>
                            </a>
                            ${showEditLink ? `
                            <a href="quick-interview.html" class="text-sm text-slate-500 hover:text-dot-blue transition-colors">
                                <i class="fas fa-edit mr-1"></i>or continue editing
                            </a>
                            ` : ''}
                        </div>
                    </div>
                `;

            } else if (!report.meta?.interviewCompleted) {
                // STATE: In Progress (still editing)
                const progress = calculateProgress(report);

                statusSection.innerHTML = `
                    <div class="bg-white border-2 border-dot-orange p-6">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-dot-orange flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-pen text-white text-2xl"></i>
                            </div>
                            <p class="text-xs font-bold text-dot-orange uppercase tracking-wider mb-1">In Progress</p>
                            <p class="text-sm text-slate-700 font-medium mb-2">Report In Progress</p>
                            <!-- Progress bar -->
                            <div class="flex items-center gap-3 mb-4 max-w-xs mx-auto">
                                <div class="flex-1 h-2 bg-slate-200 overflow-hidden">
                                    <div class="h-full bg-dot-orange transition-all" style="width: ${progress}%"></div>
                                </div>
                                <span class="text-sm font-bold text-slate-500">${progress}%</span>
                            </div>
                            <a href="quick-interview.html" class="block w-full bg-dot-orange hover:bg-orange-700 text-white p-4 transition-colors">
                                <div class="flex items-center justify-center gap-3">
                                    <i class="fas fa-play text-white"></i>
                                    <span class="font-bold uppercase tracking-wide">Continue Report</span>
                                </div>
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        function calculateProgress(report) {
            // Simplified progress calculation based on available data
            let filled = 0;
            let total = 4;

            if (report.hasRawCapture) filled++;
            if (report.hasActivities) filled++;
            if (report.meta?.interviewCompleted) filled += 2;

            return Math.round((filled / total) * 100);
        }

        // ============ ACTIONS ============
        function openSettings() {
            window.location.href = 'settings.html';
        }

        // ============ PERMISSIONS ============
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOSSafari = isIOS && isSafari;
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        function checkPermissionState() {
            const micGranted = localStorage.getItem('fvp_mic_granted') === 'true';
            const locGranted = localStorage.getItem('fvp_loc_granted') === 'true';
            const onboarded = localStorage.getItem('fvp_onboarded') === 'true';
            const bannerDismissed = localStorage.getItem('fvp_banner_dismissed') === 'true';
            const bannerDismissedDate = localStorage.getItem('fvp_banner_dismissed_date');

            if (bannerDismissedDate) {
                const dismissedTime = new Date(bannerDismissedDate).getTime();
                const now = new Date().getTime();
                const hoursSinceDismissal = (now - dismissedTime) / (1000 * 60 * 60);
                if (hoursSinceDismissal > 24) {
                    localStorage.removeItem('fvp_banner_dismissed');
                    localStorage.removeItem('fvp_banner_dismissed_date');
                }
            }

            return {
                micGranted,
                locGranted,
                onboarded,
                bannerDismissed: localStorage.getItem('fvp_banner_dismissed') === 'true',
                allGranted: micGranted && locGranted
            };
        }

        function shouldShowOnboarding() {
            const state = checkPermissionState();
            if (isMobile && !state.onboarded && !state.allGranted) {
                return true;
            }
            return false;
        }

        function shouldShowBanner() {
            const state = checkPermissionState();
            if (isMobile && state.onboarded && !state.allGranted && !state.bannerDismissed) {
                return true;
            }
            return false;
        }

        function showPermissionsBanner() {
            const banner = document.getElementById('permissionsBanner');
            banner.classList.remove('hidden');
        }

        function dismissPermissionsBanner() {
            const banner = document.getElementById('permissionsBanner');
            banner.classList.add('hidden');
            localStorage.setItem('fvp_banner_dismissed', 'true');
            localStorage.setItem('fvp_banner_dismissed_date', new Date().toISOString());
        }

        async function dismissSubmittedBanner() {
            const banner = document.getElementById('submittedBanner');
            banner.classList.add('hidden');
            sessionStorage.setItem('fvp_submitted_banner_dismissed', 'true');

            // Reload report status to show fresh state
            await loadTodayReport();
            updateReportStatus();
        }

        // ============ DRAFTS/OFFLINE QUEUE ============
        const OFFLINE_QUEUE_KEY = 'fvp_offline_queue';

        function getOfflineQueueCount() {
            try {
                const stored = localStorage.getItem(OFFLINE_QUEUE_KEY);
                if (!stored) return 0;
                const parsed = JSON.parse(stored);
                return parsed.drafts ? parsed.drafts.length : 0;
            } catch (e) {
                return 0;
            }
        }

        function updateDraftsSection() {
            const count = getOfflineQueueCount();
            const section = document.getElementById('draftsSection');
            const badge = document.getElementById('draftsBadge');
            const description = document.getElementById('draftsDescription');

            if (count > 0) {
                section.classList.remove('hidden');
                badge.textContent = count;
                description.textContent = count === 1 ? '1 report waiting to sync' : `${count} reports waiting to sync`;
            } else {
                section.classList.add('hidden');
            }
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', async () => {
            if (shouldShowOnboarding()) {
                window.location.href = 'permissions.html';
                return;
            }

            if (shouldShowBanner()) {
                showPermissionsBanner();
            }

            // Clean up old AI response caches (older than 24 hours)
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && key.startsWith('fvp_ai_response_')) {
                    try {
                        const cached = JSON.parse(localStorage.getItem(key));
                        const cachedAt = new Date(cached.cachedAt);
                        const hoursSince = (Date.now() - cachedAt.getTime()) / (1000 * 60 * 60);
                        if (hoursSince > 24) {
                            localStorage.removeItem(key);
                            console.log(`[CLEANUP] Removed stale AI cache: ${key}`);
                        }
                    } catch (e) {
                        // Invalid JSON, remove it
                        localStorage.removeItem(key);
                    }
                }
            }

            // Set current date immediately
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });

            try {
                // Load data from Supabase
                await loadProjects();
                await loadActiveProject();
                await loadTodayReport();

                // Update UI
                updateActiveProjectCard();
                updateReportStatus();
                updateDraftsSection();

                // Show submitted banner if there's a submitted report today and not dismissed this session
                const bannerDismissedThisSession = sessionStorage.getItem('fvp_submitted_banner_dismissed') === 'true';
                const hasSubmitted = await hasSubmittedReportToday();
                if (hasSubmitted && !bannerDismissedThisSession) {
                    document.getElementById('submittedBanner').classList.remove('hidden');
                }

                // Sync weather
                syncWeather();
            } catch (err) {
                console.error('Failed to initialize:', err);
                // Still update UI with whatever we have
                updateActiveProjectCard();
                updateReportStatus();
                updateDraftsSection();
                syncWeather();
            }
        });

        // Update drafts section when coming back online
        window.addEventListener('online', updateDraftsSection);
    </script>

    <!-- Project Picker Modal -->
    <div id="projectPickerModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white max-w-sm w-full shadow-xl max-h-[80vh] flex flex-col">
            <!-- Header -->
            <div class="bg-dot-navy p-4 shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 text-white">
                        <i class="fas fa-folder-open text-dot-yellow"></i>
                        <h3 class="font-bold uppercase tracking-wider">Select Project</h3>
                    </div>
                    <button onclick="closeProjectPickerModal()" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Project List (scrollable) -->
            <div id="projectPickerList" class="flex-1 overflow-y-auto">
                <!-- Projects rendered here by showProjectPickerModal() -->
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-slate-200 bg-slate-50 shrink-0">
                <a href="project-config.html" class="flex items-center justify-center gap-2 text-sm text-dot-blue hover:text-dot-navy font-bold uppercase transition-colors">
                    <i class="fas fa-cog"></i>
                    Manage Projects
                </a>
            </div>
        </div>
    </div>

    <!-- PWA Navigation Fix - Prevent Safari from breaking out of standalone mode -->
    <script>
        (function() {
            // Only apply fix when running as installed PWA
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a');
                    if (link && link.href && link.href.startsWith(window.location.origin)) {
                        // Internal link - prevent default and use location.href
                        e.preventDefault();
                        window.location.href = link.href;
                    }
                }, true);
            }
        })();
    </script>

    <!-- PWA Service Worker Registration & Offline Banner -->
    <div id="offline-banner" class="fixed top-0 left-0 right-0 bg-yellow-500 text-yellow-900 text-center py-2 px-4 font-bold text-sm z-[9999] transform -translate-y-full transition-transform duration-300" style="display: none;">
        <i class="fas fa-wifi-slash mr-2"></i>You are offline - Some features may be unavailable
    </div>
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[PWA] New version available');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });
            });
        }

        // Offline/Online Event Handlers
        const offlineBanner = document.getElementById('offline-banner');

        function showOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.display = 'block';
                setTimeout(() => {
                    offlineBanner.style.transform = 'translateY(0)';
                }, 10);
            }
        }

        function hideOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.transform = 'translateY(-100%)';
                setTimeout(() => {
                    offlineBanner.style.display = 'none';
                }, 300);
            }
        }

        window.addEventListener('online', hideOfflineBanner);
        window.addEventListener('offline', showOfflineBanner);

        // Check initial state
        if (!navigator.onLine) {
            showOfflineBanner();
        }
    </script>
</body>
</html>
